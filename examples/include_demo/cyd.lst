# file opened: cyd.asm
   1  0000              ; ==============================================================================
   2  0000              ; Choose Your Destiny
   3  0000              ;
   4  0000              ; Copyright (c) 2025 Sergio Chico (Cronomantic)
   5  0000              ;
   6  0000              ; Permission is hereby granted, free of charge, to any person obtaining a copy
   7  0000              ; of this software and associated documentation files (the "Software"), to deal
   8  0000              ; in the Software without restriction, including without limitation the rights
   9  0000              ; to use, copy, modify, merge, publish, distribute and/or sell copies of the
  10  0000              ; Software, and to permit persons to whom the Software is furnished to do so,
  11  0000              ; subject to the following conditions:
  12  0000              ;
  13  0000              ; - The above copyright notice and this permission notice shall be included
  14  0000              ; in all copies or substantial portions of the Software.
  15  0000              ;
  16  0000              ; - The above copyright notice and/or one of the project logos must
  17  0000              ; be prominently displayed both on the loading screen and/or within
  18  0000              ; the programs that include this Software, as well as on the
  19  0000              ; download website in the case of a digital copy and/or on the
  20  0000              ; cover page in the case of a physical copy.
  21  0000              ;
  22  0000              ; - THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
  23  0000              ; EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
  24  0000              ; MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
  25  0000              ; IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
  26  0000              ; DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
  27  0000              ; OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR
  28  0000              ; THE USE OR OTHER DEALINGS IN THE SOFTWARE.
  29  0000              ;
  30  0000              ; ==============================================================================
  31  0000
  32  0000                  DEVICE ZXSPECTRUM48
  33  0000
  34  0000
  35  0000              LD_SCR_ADDR   EQU  16384
  36  0000              LD_SCR_SIZE   EQU  6912
  37  0000
  38  0000              PROG       EQU  $5C53
  39  0000              LD_BLOCK   EQU  $0802
  40  0000              LD_BYTES   EQU  $0556
  41  0000              REPORT_R   EQU  $0806
  42  0000              PORT_128   EQU  $7FFD
  43  0000              BANK_VAR   EQU  $5b5c
  44  0000
  45  0000
  46  0000              START_ADDRESS EQU 23755
  47  0000
  48  0000              ;INIT_ADDR must be passed as parameter on SJASMPLUS
  49  0000              ;INIT_ADDR     EQU $8000
  50  0000
  51  0000                  ORG START_ADDRESS
  52  5CCB
  53  5CCB              LINEA0:
  54  5CCB 00 00            DB 0,0 ;NUMERO DE LINEA
  55  5CCD 8C 00            DW SIZE_LINE0 - 4 ;TAMAÃ‘O
  56  5CCF EA               DB 234 ;TOKEN DE REM
  57  5CD0
  58  5CD0              LOAD_TABLE:
  59  5CD0 00 80            DEFW $8000
  60  5CD2 7D 28            DEFW $287D
  61  5CD4 7D A8            DEFW $A87D
  62  5CD6 84 00            DEFW $84
  63  5CD8 00 00            DEFW $0
  64  5CDA
  65  5CDA
  66  5CDA
  67  5CDA
  68  5CDA              START_LOADER:
  69  5CDA                  ; Clear screen
  70  5CDA F3               DI
  71  5CDB 31 00 80         LD SP, $8000
  72  5CDE
  73  5CDE AF               XOR A
  74  5CDF D3 FE            OUT (254), A                    ;Black border
  75  5CE1 21 00 40         LD HL, LD_SCR_ADDR              ;pixels
  76  5CE4 11 01 40         LD DE, LD_SCR_ADDR+1            ;pixels + 1
  77  5CE7 01 00 1B         LD BC, LD_SCR_SIZE              ;T
  78  5CEA 75               LD (HL), L                      ;pone el primer byte a '0' ya que HL = 16384 = $4000  por tanto L = 0
  79  5CEB ED B0            LDIR                            ;copia
  80  5CED
  81  5CED CD 3F 5D         CALL MAINROM
  82  5CF0 0E 00            LD C, 0
  83  5CF2 CD 30 5D         CALL SETRAM
  84  5CF5
  85  5CF5                  IFDEF IS_128
  86  5CF5 ~                CALL TESTBANK128
  87  5CF5                  ENDIF
  88  5CF5
  89  5CF5 21 D0 5C         LD HL, LOAD_TABLE               ;Blocks table
  90  5CF8              LOOP_TABLE:
  91  5CF8 4E               LD C, (HL)
  92  5CF9 23               INC HL
  93  5CFA 46               LD B, (HL)
  94  5CFB 23               INC HL                          ; Get program start address
  95  5CFC 79               LD A, C
  96  5CFD B0               OR B
  97  5CFE 28 22            JR Z, RUN                       ; Start program if address = 0
  98  5D00 5E               LD E, (HL)
  99  5D01 23               INC HL
 100  5D02 56               LD D, (HL)
 101  5D03 23               INC HL                          ; Get size
 102  5D04 DD 21 00 00      LD IX, 0
 103  5D08 DD 09            ADD IX, BC                      ; IX = start address, DE = size
 104  5D0A                  IFDEF IS_128
 105  5D0A ~                LD C, (HL)                      ; Set Bank
 106  5D0A ~                INC HL
 107  5D0A ~                DI
 108  5D0A ~                CALL SETRAM
 109  5D0A ~                EI
 110  5D0A                  ENDIF
 111  5D0A 37               SCF                             ; Set Carry Flag -> CF=1 -> LOAD
 112  5D0B 3E FF            LD A, $FF                       ; A = 0xFF (cargar datos)
 113  5D0D E5               PUSH HL
 114  5D0E CD 56 05         CALL LD_BYTES                   ; Load block
 115  5D11 E1               POP HL
 116  5D12 38 E4            JR C, LOOP_TABLE                ;If load OK , next entry...
 117  5D14
 118  5D14              RESET:
 119  5D14 AF               XOR A                           ;Reset on error
 120  5D15 01 FD 7F         LD BC, $7ffd
 121  5D18 F3               DI
 122  5D19 ED 79            OUT (C),A                       ;update port
 123  5D1B 06 1F            LD B,$1F                        ;BC=1FFD
 124  5D1D ED 79            OUT (C),A                       ;update port
 125  5D1F C3 00 00         JP 0
 126  5D22
 127  5D22              RUN:
 128  5D22 F3               DI
 129  5D23 0E 00            LD C, 0
 130  5D25 CD 30 5D         CALL SETRAM
 131  5D28 AF               XOR A
 132  5D29 D3 FE            OUT (254), A                    ;Black border
 133  5D2B CD 00 80         CALL $8000
 134  5D2E 18 E4            JR RESET
 135  5D30
 136  5D30              SETRAM:
 137  5D30 3A 5C 5B         LD A,(23388)
 138  5D33 E6 10            AND %00010000
 139  5D35 B1               OR C
 140  5D36 01 FD 7F         LD BC,$7FFD
 141  5D39 ED 79            OUT (C),A
 142  5D3B 32 5C 5B         LD (23388),A
 143  5D3E C9               RET
 144  5D3F
 145  5D3F              MAINROM:
 146  5D3F 3A 5C 5B         LD A,(23388)
 147  5D42 CB E7            SET 4,A
 148  5D44 01 FD 7F         LD BC,$7FFD
 149  5D47 ED 79            OUT (C),A
 150  5D49 32 5C 5B         LD (23388),A
 151  5D4C 3A 67 5B         LD A,(23399)
 152  5D4F CB 87            RES 0,A
 153  5D51 CB D7            SET 2,A
 154  5D53 06 1F            LD B, $1F ;BC=$1FFD
 155  5D55 ED 79            OUT (C),A
 156  5D57 32 67 5B         LD (23399),A
 157  5D5A C9               RET
 158  5D5B
 159  5D5B                  IFDEF IS_128
 160  5D5B ~            TESTBANK128:
 161  5D5B ~                ld c, 0
 162  5D5B ~                call SETRAM
 163  5D5B ~                xor a
 164  5D5B ~                ld ($FFFF), a
 165  5D5B ~                ld c, 1
 166  5D5B ~                call SETRAM
 167  5D5B ~                ld a, $A5
 168  5D5B ~                ld ($FFFF), a
 169  5D5B ~                ld c, 0
 170  5D5B ~                call SETRAM
 171  5D5B ~                ld a, ($FFFF)
 172  5D5B ~                or a
 173  5D5B ~                ret z
 174  5D5B ~                jp RESET
 175  5D5B                  ENDIF
 176  5D5B
 177  5D5B
 178  5D5B              SIZE_LINE0 = $ - LINEA0
 179  5D5B              LINEA10:
 180  5D5B 00 0A            DB 0,10
 181  5D5D 13 00            DW SIZE_LINE10 - 4
 182  5D5F FD               DB 253 ;CLEAR
 183  5D60 2E 0E 00 00      DB '.',14,0,0 ;SHORTNUMBER
 184  5D64 FF 7F            DW $8000 - 1
 185  5D66 00               DB 0 ;FIN DEL SHORTNUMBER
 186  5D67 3A               DB ':'
 187  5D68 F2               DB 242 ;PAUSE
 188  5D69 C0               DB 192 ;USR
 189  5D6A 2E 0E 00 00      DB '.',14,0,0 ;SHORTNUMBER
 190  5D6E DA 5C            DW START_LOADER
 191  5D70 00               DB 0 ;FIN DEL SHORTNUMBER
 192  5D71 0D               DB 13
 193  5D72
 194  5D72              SIZE_LINE10 = $ - LINEA10
 195  5D72              SIZEOFBASIC = $ - START_ADDRESS
 196  5D72
 197  5D72                  EMPTYTAP "./main.tap"
 198  5D72                  SAVETAP "./main.tap",BASIC,"main",START_ADDRESS,SIZEOFBASIC,10
 199  5D72                  DEVICE ZXSPECTRUM48
 200  5D72
 201  5D72              ; ==============================================================================
 202  5D72              ; Choose Your Destiny
 203  5D72              ;
 204  5D72              ; Copyright (c) 2025 Sergio Chico (Cronomantic)
 205  5D72              ;
 206  5D72              ; Permission is hereby granted, free of charge, to any person obtaining a copy
 207  5D72              ; of this software and associated documentation files (the "Software"), to deal
 208  5D72              ; in the Software without restriction, including without limitation the rights
 209  5D72              ; to use, copy, modify, merge, publish, distribute and/or sell copies of the
 210  5D72              ; Software, and to permit persons to whom the Software is furnished to do so,
 211  5D72              ; subject to the following conditions:
 212  5D72              ;
 213  5D72              ; - The above copyright notice and this permission notice shall be included
 214  5D72              ; in all copies or substantial portions of the Software.
 215  5D72              ;
 216  5D72              ; - The above copyright notice and/or one of the project logos must
 217  5D72              ; be prominently displayed both on the loading screen and/or within
 218  5D72              ; the programs that include this Software, as well as on the
 219  5D72              ; download website in the case of a digital copy and/or on the
 220  5D72              ; cover page in the case of a physical copy.
 221  5D72              ;
 222  5D72              ; - THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 223  5D72              ; EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 224  5D72              ; MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
 225  5D72              ; IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
 226  5D72              ; DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
 227  5D72              ; OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR
 228  5D72              ; THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 229  5D72              ;
 230  5D72              ; ==============================================================================
 231  5D72
 232  5D72
 233  5D72              CHARS	            EQU 23606  ; Pointer to ROM/RAM Charset
 234  5D72              TVFLAGS             EQU 23612  ; TV Flags
 235  5D72              UDG	                EQU 23675  ; Pointer to UDG Charset
 236  5D72              COORDS              EQU 23677  ; Last PLOT coordinates
 237  5D72              FLAGS2	            EQU 23681  ;
 238  5D72              ECHO_E              EQU 23682  ;
 239  5D72              DFCC                EQU 23684  ; Next screen addr for PRINT
 240  5D72              DFCCL               EQU 23686  ; Next screen attr for PRINT
 241  5D72              S_POSN              EQU 23688
 242  5D72              ATTR_P              EQU 23693  ; Current Permanent ATTRS set with INK, PAPER, etc commands
 243  5D72              ATTR_T	            EQU 23695  ; temporary ATTRIBUTES
 244  5D72              P_FLAG	            EQU 23697  ;
 245  5D72              MEM0                EQU 23698  ; Temporary memory buffer used by ROM chars
 246  5D72              BORDCR              EQU $5C48  ; Border color
 247  5D72              FRAMES              EQU $5C78  ; Frame counter
 248  5D72              LASTK               EQU $5C08  ; Last key pressed
 249  5D72              REPDEL              EQU $5C09  ; Time in 1/50s before key repeats
 250  5D72              REPPER              EQU $5C0A  ; Delay in 1/50s between key repeats
 251  5D72              PIP                 EQU $5C39  ; Length of keyboard click
 252  5D72              KSTATE              EQU $5C00
 253  5D72
 254  5D72              SCR_PXL_SIZE        EQU 32*192
 255  5D72              SCR_ATT_SIZE        EQU 32*24
 256  5D72              SCR_SIZE            EQU SCR_ATT_SIZE + SCR_PXL_SIZE
 257  5D72
 258  5D72              SCR_PXL             EQU $4000
 259  5D72              SCR_ATT             EQU SCR_PXL + SCR_PXL_SIZE
 260  5D72              SCR_ADDR            EQU SCR_PXL
 261  5D72
 262  5D72              PLUS3_DOS_BANKM     EQU $5B5C
 263  5D72              PLUS3_DOS_BANK678   EQU $5B67
 264  5D72
 265  5D72              KEY_SCAN          EQU $028E
 266  5D72              K_TEST            EQU $031E
 267  5D72              K_DECODE          EQU $0333
 268  5D72
 269  5D72              ; ==============================================================================
 270  5D72              ; Choose Your Destiny
 271  5D72              ;
 272  5D72              ; Copyright (c) 2025 Sergio Chico (Cronomantic)
 273  5D72              ;
 274  5D72              ; Permission is hereby granted, free of charge, to any person obtaining a copy
 275  5D72              ; of this software and associated documentation files (the "Software"), to deal
 276  5D72              ; in the Software without restriction, including without limitation the rights
 277  5D72              ; to use, copy, modify, merge, publish, distribute and/or sell copies of the
 278  5D72              ; Software, and to permit persons to whom the Software is furnished to do so,
 279  5D72              ; subject to the following conditions:
 280  5D72              ;
 281  5D72              ; - The above copyright notice and this permission notice shall be included
 282  5D72              ; in all copies or substantial portions of the Software.
 283  5D72              ;
 284  5D72              ; - The above copyright notice and/or one of the project logos must
 285  5D72              ; be prominently displayed both on the loading screen and/or within
 286  5D72              ; the programs that include this Software, as well as on the
 287  5D72              ; download website in the case of a digital copy and/or on the
 288  5D72              ; cover page in the case of a physical copy.
 289  5D72              ;
 290  5D72              ; - THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 291  5D72              ; EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 292  5D72              ; MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
 293  5D72              ; IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
 294  5D72              ; DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
 295  5D72              ; OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR
 296  5D72              ; THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 297  5D72              ;
 298  5D72              ; ==============================================================================
 299  5D72
 300  5D72
 301  5D72                  ORG $5d00
 302  5D00
 303  5D00              START_VARS:
 304  5D00              INITIAL_STACK EQU START_VARS
 305  5D00
 306  5D00                  ALIGN 256
 307  5D00              FLAGS:
 308  5D00 00 00 00...      DEFS 256, 0
 309  5E00              ;------------------------------------------------------------------------
 310  5E00                  DEFINE MAXIMUM_OPTIONS 32
 311  5E00                  ALIGN 256
 312  5E00              OPTIONS_TABLE:
 313  5E00 00 00 00...      DEFS 256, 0
 314  5F00              TIMEOUT_OPTION:
 315  5F00 00 00 00 00      DEFS 4, 0
 316  5F04              ;  X, Y Cursor Marker - Addr Jump
 317  5F04              ;------------------------------------------------------------------------
 318  5F04                  IFNDEF TEXT_BUFFER_LEN
 319  5F04                  DEFINE TEXT_BUFFER_LEN   128
 320  5F04                  ENDIF
 321  5F04
 322  5F04                  IFNDEF TOKEN_BUFFER_LEN
 323  5F04                  DEFINE TOKEN_BUFFER_LEN  32
 324  5F04                  ENDIF
 325  5F04              ;------------------------------------------------------------------------
 326  5F04              BUFFER:
 327  5F04 00 00 00...      DEFS   128+ 32,0
 328  5FA4
 329  5FA4              ;Buffer for text
 330  5FA4              TEXT_BUFFER EQU BUFFER
 331  5FA4              ;Buffer for decompressing token
 332  5FA4              TOKEN_BUFFER EQU TEXT_BUFFER +   128
 333  5FA4              ;------------------------------------------------------------------------
 334  5FA4                  ; OPTIONS
 335  5FA4              NUM_OPTIONS:
 336  5FA4 00               DEFB 0
 337  5FA5              SELECTED_OPTION:
 338  5FA5 00               DEFB 0
 339  5FA6              SELECTED_OPTION_VALUE:
 340  5FA6 00               DEFB 0
 341  5FA7              INCR_X_OPTION:
 342  5FA7 00               DEFB 0
 343  5FA8              INCR_Y_OPTION:
 344  5FA8 01               DEFB 1
 345  5FA9              DEFAULT_OPTION:
 346  5FA9 00               DEFB 0
 347  5FAA              OPTION_BULLET_ENABLED:
 348  5FAA 01               DEFB 1
 349  5FAB              CYCLE_OPTION:
 350  5FAB 00               DEFB 0
 351  5FAC              RETURN_FROM_CHOOSE_CH:
 352  5FAC 00               DEFB 0
 353  5FAD              CHOOSE_CH_RET_ADDRESS:
 354  5FAD 00 00 00         DEFS 3, 0
 355  5FB0              CHOOSE_CH_GOSUB_ADDRESS:
 356  5FB0 00 00 00         DEFS 3, 0
 357  5FB3
 358  5FB3              ;--------------------------------------------------------------------------
 359  5FB3              ;Print speed
 360  5FB3              PRT_INTERVAL:
 361  5FB3 00 00            DEFW 0
 362  5FB5
 363  5FB5              CURR_WINDOW:
 364  5FB5 00               DEFB 0
 365  5FB6
 366  5FB6              CHARSET_OFFSET:
 367  5FB6 00               DEFB 0
 368  5FB7
 369  5FB7              ; X is in pixels, y in chars
 370  5FB7              POS_X:
 371  5FB7 00               DEFB 0
 372  5FB8              POS_Y:
 373  5FB8 00               DEFB 0
 374  5FB9              ;Window min & max size
 375  5FB9              ; X is in pixels, y in chars
 376  5FB9              MIN_X:
 377  5FB9 00               DEFB 0
 378  5FBA              MIN_Y:
 379  5FBA 00               DEFB 0
 380  5FBB              MAX_X:
 381  5FBB FF               DEFB 255
 382  5FBC              MAX_Y:
 383  5FBC 17               DEFB 23
 384  5FBD              PRINTED_LINES:
 385  5FBD 00               DEFB 0
 386  5FBE
 387  5FBE              CHUNK:
 388  5FBE 00               DEFB 0
 389  5FBF
 390  5FBF              WAIT_NEW_SCREEN:
 391  5FBF 00               DEFB 0
 392  5FC0              SKIP_SPACES:
 393  5FC0 00               DEFB 0
 394  5FC1
 395  5FC1              FADE_OUT_ITERARIONS:
 396  5FC1 00               DEFB 0
 397  5FC2              FADE_OUT_ADDRESS:
 398  5FC2 00 00            DEFW 0
 399  5FC4              FADEOUT_W:
 400  5FC4 00               DEFB 0
 401  5FC5              FADEOUT_H:
 402  5FC5 00               DEFB 0
 403  5FC6
 404  5FC6              MAX_X_BACKSPACE:
 405  5FC6 00               DEFB 0
 406  5FC7              WIDTH_BACKSPACE:
 407  5FC7 00               DEFB 0
 408  5FC8
 409  5FC8              CURR_SAVE_SLOT:
 410  5FC8 00               DEFB 0
 411  5FC9              LAST_SAVE_RESULT:
 412  5FC9 FF               DEFB 255
 413  5FCA              LAST_DISK_ERROR:
 414  5FCA 00               DEFB 0
 415  5FCB
 416  5FCB              NO_SELECTED_BULLET  EQU 127
 417  5FCB              SELECTED_BULLET     EQU 128
 418  5FCB              WAIT_TO_KEY_BULLET  EQU SELECTED_BULLET+8
 419  5FCB
 420  5FCB              PIC_NUM_LINES_PXL:
 421  5FCB 00               DEFB 0
 422  5FCC              PIC_NUM_LINES_ATT:
 423  5FCC 00               DEFB 0
 424  5FCD
 425  5FCD              SCR_BUFF_ADDR EQU $6000
 426  5FCD                  ORG SCR_BUFF_ADDR
 427  6000              SCREEN_BUFFER_PXL:
 428  6000 00 00 00...      DEFS SCR_PXL_SIZE,0
 429  7800              SCREEN_BUFFER_ATT:
 430  7800 00 00 00...      DEFS SCR_ATT_SIZE,0
 431  7B00
 432  7B00              ;--------------------------------------------------
 433  7B00              SAVE_START:
 434  7B00              SAVE_GAME_ID:
 435  7B00 00 00 00...      DEFS 16, 0
 436  7B10              SAVE_SLOT:
 437  7B10 00               DEFB 0
 438  7B11              SAVE_NVARS:
 439  7B11 00               DEFB 0
 440  7B12              SAVE_ORIGIN:
 441  7B12 00               DEFB 0
 442  7B13              SAVE_FLAGS:
 443  7B13 00 00 00...      DEFS 256, 0
 444  7C13              SAVE_CHECKSUM:
 445  7C13 00 00            DEFW 0
 446  7C15              SAVE_END:
 447  7C15              SAVE_SIZE EQU SAVE_END-SAVE_START
 448  7C15
 449  7C15              MAXWINDOWS EQU 8
 450  7C15
 451  7C15              WINDOWS:
 452  7C15 00 00 00...      DEFS MAXWINDOWS*8,0
 453  7C55              WINDOWS_END:
 454  7C55              ;--------------------------------------------------
 455  7C55                  ;INCLUDE "VTII10bG_vars.asm"
 456  7C55
 457  7C55              END_VARS:
 458  7C55              ;--------------------------------------------------
 459  7C55
 460  7C55                  ORG $E000
 461  E000              PIC_BUFFER:
 462  E000 00 00            DEFW 0
 463  E002              PIC_BUFFER_SCR:
 464  E002 00 00 00...      DEFS SCR_PXL_SIZE+SCR_ATT_SIZE
 465  FB02
 466  FB02              ; ==============================================================================
 467  FB02              ; Choose Your Destiny
 468  FB02              ;
 469  FB02              ; Copyright (c) 2025 Sergio Chico (Cronomantic)
 470  FB02              ;
 471  FB02              ; Permission is hereby granted, free of charge, to any person obtaining a copy
 472  FB02              ; of this software and associated documentation files (the "Software"), to deal
 473  FB02              ; in the Software without restriction, including without limitation the rights
 474  FB02              ; to use, copy, modify, merge, publish, distribute and/or sell copies of the
 475  FB02              ; Software, and to permit persons to whom the Software is furnished to do so,
 476  FB02              ; subject to the following conditions:
 477  FB02              ;
 478  FB02              ; - The above copyright notice and this permission notice shall be included
 479  FB02              ; in all copies or substantial portions of the Software.
 480  FB02              ;
 481  FB02              ; - The above copyright notice and/or one of the project logos must
 482  FB02              ; be prominently displayed both on the loading screen and/or within
 483  FB02              ; the programs that include this Software, as well as on the
 484  FB02              ; download website in the case of a digital copy and/or on the
 485  FB02              ; cover page in the case of a physical copy.
 486  FB02              ;
 487  FB02              ; - THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 488  FB02              ; EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 489  FB02              ; MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
 490  FB02              ; IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
 491  FB02              ; DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
 492  FB02              ; OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR
 493  FB02              ; THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 494  FB02              ;
 495  FB02              ; ==============================================================================
 496  FB02
 497  FB02
 498  FB02                  DEFINE RELEASE "1.0"
 499  FB02
 500  FB02                  DEFINE IS_PLUS3 0
 501  FB02
 502  FB02                  IFDEF USE_WYZ
 503  FB02 ~            WYZ_BANK     EQU 1
 504  FB02 ~            WYZ_TRACKER  EQU $C000
 505  FB02                  ENDIF
 506  FB02
 507  FB02                  ORG $8000
 508  8000              START_INTERPRETER:
 509  8000
 510  8000              INT_STACK_ADDR EQU $8000
 511  8000
 512  8000                  ;Clear data area
 513  8000 AF               xor a
 514  8001 21 00 5D         ld hl, START_VARS
 515  8004 77               ld (hl), a
 516  8005 11 01 5D         ld de, START_VARS+1
 517  8008 01 54 1F         ld bc, END_VARS-START_VARS-1
 518  800B ED B0            ldir
 519  800D
 520  800D F3               di
 521  800E 31 00 5D         ld sp, INITIAL_STACK      ; Set stack
 522  8011 3E 82            ld a, high ISR_TABLE      ; load interrupt service routine
 523  8013 ED 47            ld i, a
 524  8015 ED 5E            im 2
 525  8017
 526  8017                  IFDEF IS_128_TAPE
 527  8017 ~                call SET_DEFAULT_BANKS
 528  8017                  ENDIF
 529  8017                  IFDEF USE_WYZ
 530  8017 ~                ld d, $FF
 531  8017 ~                call WYZ_CALL
 532  8017                  ENDIF
 533  8017 FB               ei
 534  8018
 535  8018                  ;Disable CAPS_LOCK
 536  8018 FD CB 30 9E      res 3,(IY+$30)
 537  801C
 538  801C 3E FF            ld a, $FF
 539  801E 32 C9 5F         ld (LAST_SAVE_RESULT), a
 540  8021
 541  8021 AF               xor a
 542  8022 CD 58 87         call BORDER
 543  8025
 544  8025                  IFDEF PAUSE_AT_START_VAL
 545  8025 ~                ld de, PAUSE_AT_START_VAL
 546  8025 ~                ld (DOWN_COUNTER), de
 547  8025 ~            1:  call INKEY_MENU
 548  8025 ~                or a
 549  8025 ~                jr nz, 2f
 550  8025 ~                ld bc, (DOWN_COUNTER)
 551  8025 ~                ld a, b
 552  8025 ~                or c
 553  8025 ~                jr nz, 1b
 554  8025 ~            2:  call INKEY_MENU
 555  8025 ~                or a
 556  8025 ~                jr nz, 2b
 557  8025                  ENDIF
 558  8025
 559  8025 AF               xor a
 560  8026 CD 93 87         call PAPER
 561  8029 3E 07            ld a, 7
 562  802B CD 73 87         call INK
 563  802E CD 0E 87         call INIT_WIN
 564  8031 CD FF 86         call CLS_BUFFER
 565  8034 CD 60 83         call SET_RND_SEED
 566  8037
 567  8037 C3 01 83         jp START_LOADING
 568  803A
 569  803A              RND_SEED:
 570  803A 00 00            DW 0
 571  803C              DOWN_COUNTER:
 572  803C 00 00            DW 0
 573  803E              UPDATE_SCR_FLAG:
 574  803E 00               DB 0
 575  803F
 576  803F              CHUNK_ADDR:
 577  803F 00 00            DW 0
 578  8041              SCRIPT_BANK:
 579  8041 00               DB 0
 580  8042
 581  8042              KEMPSTON_VALUE:
 582  8042 FF               DB $FF
 583  8043
 584  8043                  IFDEF USE_VORTEX
 585  8043 ~            MDLADDR:
 586  8043 ~                DW 0
 587  8043 ~            VORTEX_BANK:
 588  8043 ~                DB 0
 589  8043                  ENDIF
 590  8043
 591  8043                  org $8070
 592  8070              TMP_AREA:
 593  8070 00 00 00...      DS 16, 0
 594  8080                  org $8080
 595  8080              ISR:
 596  8080 F5               push af
 597  8081 E5               push hl                  ; these will be restored by ROM
 598  8082 C5               push bc
 599  8083 D5               push de
 600  8084 DD E5            push ix
 601  8086 FD E5            push iy
 602  8088 D9               exx
 603  8089 08               ex af, af'
 604  808A F5               push af
 605  808B E5               push hl
 606  808C C5               push bc
 607  808D D5               push de                  ;Full context save
 608  808E
 609  808E DB 1F            in a, ($1f)
 610  8090 32 42 80         ld (KEMPSTON_VALUE), a
 611  8093
 612  8093 3A 3E 80         ld a, (UPDATE_SCR_FLAG)  ; Get flag
 613  8096 B7               or a                     ; test if active
 614  8097 CA 6C 81         jp z, .no_screen         ; Do nothing if 0
 615  809A                  ;Update screen here!
 616  809A
 617  809A
 618  809A              ;Copy Pixels
 619  809A 21 00 60         ld hl, SCREEN_BUFFER_PXL
 620  809D 3A CB 5F         ld a, (PIC_NUM_LINES_PXL)
 621  80A0 ED 73 17 81      LD (.Copy_Screen_End),SP   ; This is some self-modifying code; stores the stack pointer in an LD SP,nn instruction at the end
 622  80A4 D9               EXX                         ; Switch to alternate registers
 623  80A5 21 00 40         LD HL,0x4000                ; HL' = screen pointer
 624  80A8 22 FB 80     1:  LD (.Copy_Screen_HL1), HL  ; Store the screen position for later
 625  80AB D9               EXX                         ; Switch to normal registers
 626  80AC 32 12 81         ld (.Dec_Line), a
 627  80AF F9               LD SP,HL            ; HL = Buffer address
 628  80B0 F1               POP AF              ; Fetch the data
 629  80B1 C1               POP BC
 630  80B2 D1               POP DE
 631  80B3 DD E1            POP IX
 632  80B5 D9               EXX             ; Switch to alternate registers
 633  80B6 08               EX AF,AF'
 634  80B7 11 10 00         LD DE,16
 635  80BA 19               ADD HL,DE           ; Add Offset for screen
 636  80BB F1               POP AF
 637  80BC C1               POP BC
 638  80BD D1               POP DE
 639  80BE FD E1            POP IY
 640  80C0 ED 73 D2 80      LD (.Copy_Screen_SP1),SP   ; Save the current buffer address for later
 641  80C4 F9               LD SP,HL            ; The screen address
 642  80C5 FD E5            PUSH IY             ; Push the data
 643  80C7 D5               PUSH DE
 644  80C8 C5               PUSH BC
 645  80C9 F5               PUSH AF
 646  80CA 08               EX AF,AF'           ; Switch to normal registers
 647  80CB D9               EXX
 648  80CC DD E5            PUSH IX
 649  80CE D5               PUSH DE
 650  80CF C5               PUSH BC
 651  80D0 F5               PUSH AF
 652  80D1              .Copy_Screen_SP1+1:
 653  80D1 21 00 00         LD HL,0             ; HL = Buffer
 654  80D4
 655  80D4 F9               LD SP,HL            ; HL = Buffer address
 656  80D5 F1               POP AF              ; Fetch the data
 657  80D6 C1               POP BC
 658  80D7 D1               POP DE
 659  80D8 DD E1            POP IX
 660  80DA D9               EXX             ; Switch to alternate registers
 661  80DB 08               EX AF,AF'
 662  80DC 11 10 00         LD DE,16
 663  80DF 19               ADD HL,DE           ; Add Offset for screen
 664  80E0 F1               POP AF
 665  80E1 C1               POP BC
 666  80E2 D1               POP DE
 667  80E3 FD E1            POP IY
 668  80E5 ED 73 F7 80      LD (.Copy_Screen_SP2),SP   ; Save the current buffer address for later
 669  80E9 F9               LD SP,HL            ; The screen address
 670  80EA FD E5            PUSH IY             ; Push the data
 671  80EC D5               PUSH DE
 672  80ED C5               PUSH BC
 673  80EE F5               PUSH AF
 674  80EF 08               EX AF,AF'           ; Switch to normal registers
 675  80F0 D9               EXX
 676  80F1 DD E5            PUSH IX
 677  80F3 D5               PUSH DE
 678  80F4 C5               PUSH BC
 679  80F5 F5               PUSH AF
 680  80F6              .Copy_Screen_SP2+1:
 681  80F6 21 00 00         LD HL,0             ; HL = Buffer
 682  80F9
 683  80F9 D9               EXX             ; Switch to alternate registers
 684  80FA              .Copy_Screen_HL1+1:
 685  80FA 21 00 00         LD HL,0             ; HL' = Screen
 686  80FD 24               INC H               ; Drop down 1 pixel row in screen memory
 687  80FE 7C               LD A,H              ; Check whether we've gone past a character boundary
 688  80FF E6 07            AND 0x07
 689  8101 20 0E            JR NZ,2F
 690  8103 7C               LD A,H              ; Go to the next character line
 691  8104 D6 08            SUB 8
 692  8106 67               LD H,A
 693  8107 7D               ld A,L
 694  8108 C6 20            ADD A,32
 695  810A 6F               LD L,A
 696  810B 30 04            JR NC,2F            ; Check for next third
 697  810D 7C               LD A,H              ; Go to next third
 698  810E C6 08            ADD A,8
 699  8110 67               LD H,A
 700  8111              .Dec_Line+1:
 701  8111 3E 00        2:  ld a, 0
 702  8113 3D               dec a
 703  8114 20 92            jr nz,1B
 704  8116
 705  8116              .Copy_Screen_End+1:
 706  8116 31 00 00         LD SP,0         ; Restore the SP
 707  8119 D9               EXX             ; Switch to normal registers
 708  811A
 709  811A                  ; Copy attributes
 710  811A 21 00 78         ld hl, SCREEN_BUFFER_ATT
 711  811D 11 00 58         ld de, SCR_ATT
 712  8120 3A CC 5F         ld a, (PIC_NUM_LINES_ATT)
 713  8123 47               ld b, a
 714  8124 0E FF        1:  ld c, $ff
 715  8126                  REPT 32
 716  8126 ED A0       >    ldi
 716  8128 ED A0       >    ldi
 716  812A ED A0       >    ldi
 716  812C ED A0       >    ldi
 716  812E ED A0       >    ldi
 716  8130 ED A0       >    ldi
 716  8132 ED A0       >    ldi
 716  8134 ED A0       >    ldi
 716  8136 ED A0       >    ldi
 716  8138 ED A0       >    ldi
 716  813A ED A0       >    ldi
 716  813C ED A0       >    ldi
 716  813E ED A0       >    ldi
 716  8140 ED A0       >    ldi
 716  8142 ED A0       >    ldi
 716  8144 ED A0       >    ldi
 716  8146 ED A0       >    ldi
 716  8148 ED A0       >    ldi
 716  814A ED A0       >    ldi
 716  814C ED A0       >    ldi
 716  814E ED A0       >    ldi
 716  8150 ED A0       >    ldi
 716  8152 ED A0       >    ldi
 716  8154 ED A0       >    ldi
 716  8156 ED A0       >    ldi
 716  8158 ED A0       >    ldi
 716  815A ED A0       >    ldi
 716  815C ED A0       >    ldi
 716  815E ED A0       >    ldi
 716  8160 ED A0       >    ldi
 716  8162 ED A0       >    ldi
 716  8164 ED A0       >    ldi
 717  8166                  ENDR
 718  8166 10 BC            djnz 1B
 719  8168
 720  8168 AF               xor a
 721  8169 32 3E 80         ld (UPDATE_SCR_FLAG), a
 722  816C
 723  816C              .no_screen:
 724  816C
 725  816C 3A C1 5F         ld a, (FADE_OUT_ITERARIONS)
 726  816F B7               or a
 727  8170 28 27            jr z, .no_fadeout
 728  8172 2A C2 5F         ld hl, (FADE_OUT_ADDRESS)
 729  8175 ED 5B C4 5F      ld de, (FADEOUT_W)
 730  8179 3D               dec a
 731  817A 32 C1 5F         ld (FADE_OUT_ITERARIONS), a
 732  817D 43           2:  ld b, e        ; width -> B
 733  817E E5               push hl
 734  817F 7E           1:  ld a, (hl)     ; read current attribute; for both PAPER and INK (individually), all three bits are merged into one by OR
 735  8180 4F               ld c, a        ; the merged bits will land into "bottom" bit (b0 INK, b3 PAPER)
 736  8181 1F               rra                 ; setting those to "1" for non-zero INK/PAPER value
 737  8182 B1               or c           ; and "0" for zero INK/PAPER - this will be then subtracted
 738  8183 1F               rra                 ; from current attribute
 739  8184 B1               or c           ; *here* the bits 0 and 3 are "1" for non-zero INK and PAPER
 740  8185 E6 09            and %00001001   ; extract those bottom INK (+1)/PAPER (+8) bits into A
 741  8187                  ; subtract that value from current attribute, to decrement INK/PAPER individually
 742  8187 91               sub c           ; A = decrement - attribute
 743  8188 ED 44            neg             ; A = attribute - decrement (new attribute value)
 744  818A 77               ld (hl), a     ; write the darkened attribute value
 745  818B 23               inc hl
 746  818C 10 F1            djnz 1b
 747  818E E1               pop hl         ; Restore hl
 748  818F 3E 20            ld a, 32       ; next attr line
 749  8191 85               add a, l
 750  8192 30 01            jr nc, 4f
 751  8194 24               inc h
 752  8195 6F           4:  ld l, a
 753  8196 15               dec d
 754  8197 20 E4            jr nz, 2b
 755  8199              .no_fadeout:
 756  8199
 757  8199                  IFDEF USE_VORTEX
 758  8199 ~            VORTEX_PLAYER_ISR:
 759  8199 ~                ;call vortex tracker here?
 760  8199 ~                ld hl, VTR_STAT
 761  8199 ~                bit 1, (hl)        ;Test if loaded module
 762  8199 ~                jr z, .no_ay
 763  8199 ~
 764  8199 ~                bit 2, (hl)        ;test if play module
 765  8199 ~                jr z, .mute
 766  8199 ~
 767  8199 ~                push hl
 768  8199 ~                ld a, (PLUS3_DOS_BANKM)
 769  8199 ~                ld bc, $7ffd
 770  8199 ~                push af                  ; Save current bank
 771  8199 ~                push bc
 772  8199 ~                ld a, (VORTEX_BANK)
 773  8199 ~                or %00010000
 774  8199 ~                out (c), a  ;Sets bank 3
 775  8199 ~                call VTR_ISR
 776  8199 ~                pop bc
 777  8199 ~                pop af
 778  8199 ~                out (c), a
 779  8199 ~                pop hl
 780  8199 ~
 781  8199 ~                bit 0, (hl)
 782  8199 ~                jr z, .no_ay
 783  8199 ~
 784  8199 ~                bit 7, (hl) ;test if end of song
 785  8199 ~                jr z, .no_ay
 786  8199 ~                res 2, (hl) ;Disable play
 787  8199 ~
 788  8199 ~            .mute:
 789  8199 ~                call VTR_MUTE
 790  8199 ~            .no_ay:
 791  8199                  ENDIF
 792  8199
 793  8199                  IFDEF USE_WYZ
 794  8199 ~            WYZ_PLAYER_ISR:
 795  8199 ~                ld a, (PLUS3_DOS_BANKM)
 796  8199 ~                ld bc, $7ffd
 797  8199 ~                push af                  ; Save current bank
 798  8199 ~                push bc
 799  8199 ~                ld a, WYZ_BANK|%00010000
 800  8199 ~                out (c), a  ;Sets bank
 801  8199 ~                xor a
 802  8199 ~                CALL WYZ_TRACKER
 803  8199 ~                pop bc
 804  8199 ~                pop af
 805  8199 ~                out (c), a
 806  8199                  ENDIF
 807  8199
 808  8199                  ; Downcounter for pauses
 809  8199 2A 3C 80         ld hl, (DOWN_COUNTER)
 810  819C 7D               ld a, l
 811  819D B4               or h
 812  819E 28 04            jr z,.cont_zero
 813  81A0 2B               dec hl
 814  81A1 22 3C 80         ld (DOWN_COUNTER), hl
 815  81A4              .cont_zero:
 816  81A4
 817  81A4              ; Frame counter for random function
 818  81A4 2A 78 5C         ld hl, (FRAMES)
 819  81A7 23               inc hl
 820  81A8 22 78 5C         ld (FRAMES), hl
 821  81AB 7D               ld a, l
 822  81AC CB 3F            srl a
 823  81AE CB 3F            srl a
 824  81B0 E6 07            and 7
 825  81B2 32 AB 5F         ld (CYCLE_OPTION), a
 826  81B5
 827  81B5              .restore_context:
 828  81B5 D1               pop de                  ; Restore context
 829  81B6 C1               pop bc
 830  81B7 E1               pop hl
 831  81B8 F1               pop af
 832  81B9 08               ex af, af'
 833  81BA D9               exx
 834  81BB FD E1            pop iy
 835  81BD DD E1            pop ix
 836  81BF D1               pop de
 837  81C0 C1               pop bc
 838  81C1                  ;
 839  81C1 E1               pop hl
 840  81C2 F1               pop af
 841  81C3 FB               ei
 842  81C4 ED 4D            reti
 843  81C6                  ;jp $3a                   ; Chain with ROM ISR
 844  81C6
 845  81C6 00 00 00...      align 256
 846  8200              ISR_TABLE:
 847  8200 80 80 80...      DEFS 257, HIGH ISR
 848  8301
 849  8301              START_LOADING:
 850  8301 DD 21 00 80      ld ix, INT_STACK_ADDR     ;Set internal Stack
 851  8305
 852  8305 AF               xor a
 853  8306 CD 19 83         call LOAD_CHUNK         ;Loads first CHUNK
 854  8309                  ;ld hl, (CHUNK_ADDR)       ;Start the CHUNK
 855  8309                  ; HL current pointer,
 856  8309              EXEC_LOOP:
 857  8309 16 9E            ld d, HIGH OPCODES
 858  830B 5E               ld e, (hl)                ; Loads instruction
 859  830C CB 23            sla e
 860  830E EB               ex de, hl
 861  830F 4E               ld c, (hl)
 862  8310 23               inc hl
 863  8311 46               ld b, (hl)
 864  8312 C5               push bc
 865  8313 EB               ex de, hl
 866  8314 23               inc hl
 867  8315 C9               ret
 868  8316
 869  8316                  ;Close file
 870  8316              END_PROGRAM:
 871  8316                  IFDEF USE_VORTEX
 872  8316 ~                call VTR_MUTE
 873  8316                  ENDIF
 874  8316                  IFDEF USE_WYZ
 875  8316 ~                ld de, $0200
 876  8316 ~                call WYZ_CALL
 877  8316                  ENDIF
 878  8316 C3 70 84         jp RESET_SYS
 879  8319
 880  8319
 881  8319              TYPE_TXT EQU  0
 882  8319              TYPE_SCR EQU  1
 883  8319              TYPE_TRK EQU  2
 884  8319              TYPE_WYZ EQU  3
 885  8319
 886  8319              ; A - New CHUNK number
 887  8319              ; On exit, new CHUNK in C
 888  8319              LOAD_CHUNK:
 889  8319 32 BE 5F         ld (CHUNK), a
 890  831C 4F               ld c, a
 891  831D 06 00            ld b, TYPE_TXT
 892  831F CD 2E 83         call FIND_IN_INDEX
 893  8322 22 3F 80         ld (CHUNK_ADDR), hl
 894  8325 32 41 80         ld (SCRIPT_BANK), a
 895  8328 F6 10            or ROM48KBASIC
 896  832A CD 5A 84         call SET_RAM_BANK
 897  832D C9               ret
 898  832E
 899  832E              ;Input: B = type of element, C = index of element
 900  832E              ;Output: B = Bank, HL = Offset
 901  832E              ;Uses: AF, AF', IX, DE, HL, BC
 902  832E              FIND_IN_INDEX:
 903  832E DD E5            push ix
 904  8330 21 01 00         ld hl, 1
 905  8333 DD 21 78 A8      ld ix, INDEX
 906  8337 11 05 00         ld de, 5
 907  833A              .loop:
 908  833A 7D               ld a, l
 909  833B B4               or h
 910  833C 28 11            jr z, .end_loop
 911  833E DD 7E 00         ld a, (ix+0)
 912  8341 B8               cp b
 913  8342 20 06            jr nz, .next
 914  8344 DD 7E 01         ld a, (ix+1)
 915  8347 B9               cp c
 916  8348 28 0A            jr z, .found
 917  834A              .next:
 918  834A DD 19            add ix, de
 919  834C 2B               dec hl
 920  834D 18 EB            jr .loop
 921  834F              .end_loop:
 922  834F 3E 01            ld a, 1
 923  8351 C3 00 9F         jp SYS_ERROR
 924  8354              .found:
 925  8354 DD 7E 02         ld a, (ix+2)
 926  8357 DD 6E 03         ld l, (ix+3)
 927  835A DD 66 04         ld h, (ix+4)
 928  835D DD E1            pop ix
 929  835F C9               ret
 930  8360
 931  8360              SET_RND_SEED:
 932  8360 2A 78 5C         ld hl,(FRAMES) ;get data from frames
 933  8363 18 03            jr RANDOM_2
 934  8365              RANDOM:
 935  8365 2A 3A 80         ld hl,(RND_SEED)
 936  8368              RANDOM_2:
 937  8368 ED 5F            ld a, r
 938  836A E6 03            and %11
 939  836C 3C               inc a
 940  836D 47               ld b, a
 941  836E              .loop:
 942  836E 7C               ld a,h
 943  836F 1F               rra
 944  8370 7D               ld a,l
 945  8371 1F               rra
 946  8372 AC               xor h
 947  8373 67               ld h,a
 948  8374 7D               ld a,l
 949  8375 1F               rra
 950  8376 7C               ld a,h
 951  8377 1F               rra
 952  8378 AD               xor l
 953  8379 6F               ld l,a
 954  837A AC               xor h
 955  837B 67               ld h,a
 956  837C 10 F0            djnz .loop
 957  837E 22 3A 80         ld (RND_SEED), hl
 958  8381 C9               ret
 959  8382
 960  8382              ;----------------------------------------------------
 961  8382              SIGNATURE:
 962  8382 43 59 44 20      DB "CYD v", "1.0", 0
 962  8386 76 31 2E 30
 962  838A 00
 963  838B              GAME_ID:
 964  838B 6D 61 69 6E      DEFB "main", 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
 964  838F 00 00 00 00
 964  8393 00 00 00 00
 964  8397 00 00 00 00
 965  839B              ;----------------------------------------------------
 966  839B              ; ==============================================================================
 967  839B              ; Choose Your Destiny
 968  839B              ;
 969  839B              ; Copyright (c) 2025 Sergio Chico (Cronomantic)
 970  839B              ;
 971  839B              ; Permission is hereby granted, free of charge, to any person obtaining a copy
 972  839B              ; of this software and associated documentation files (the "Software"), to deal
 973  839B              ; in the Software without restriction, including without limitation the rights
 974  839B              ; to use, copy, modify, merge, publish, distribute and/or sell copies of the
 975  839B              ; Software, and to permit persons to whom the Software is furnished to do so,
 976  839B              ; subject to the following conditions:
 977  839B              ;
 978  839B              ; - The above copyright notice and this permission notice shall be included
 979  839B              ; in all copies or substantial portions of the Software.
 980  839B              ;
 981  839B              ; - The above copyright notice and/or one of the project logos must
 982  839B              ; be prominently displayed both on the loading screen and/or within
 983  839B              ; the programs that include this Software, as well as on the
 984  839B              ; download website in the case of a digital copy and/or on the
 985  839B              ; cover page in the case of a physical copy.
 986  839B              ;
 987  839B              ; - THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 988  839B              ; EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 989  839B              ; MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
 990  839B              ; IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
 991  839B              ; DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
 992  839B              ; OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR
 993  839B              ; THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 994  839B              ;
 995  839B              ; ==============================================================================
 996  839B
 997  839B
 998  839B              INKEY:
 999  839B D9               exx
1000  839C
1001  839C CD 8E 02         call KEY_SCAN
1002  839F C2 AF 83         jp nz, .empty_inkey
1003  83A2
1004  83A2 CD 1E 03         call K_TEST
1005  83A5 D2 AF 83         jp nc, .empty_inkey
1006  83A8
1007  83A8 15               dec d   ; D is expected to be FLAGS so set bit 3 $FF
1008  83A9                  ; 'L' Mode so no keywords.
1009  83A9 5F               ld e, a ; main key to A
1010  83AA                  ; C is MODE 0 'KLC' from above still.
1011  83AA CD 33 03         call K_DECODE ; routine K-DECODE
1012  83AD                  ;Keycode on A
1013  83AD D9               exx
1014  83AE C9               ret
1015  83AF              .empty_inkey:
1016  83AF AF               xor a
1017  83B0 D9               exx
1018  83B1 C9               ret
1019  83B2
1020  83B2              INKEY_WAIT_ITERATIONS       EQU 10
1021  83B2              INKEY_NO_WAIT_ITERATIONS    EQU INKEY_WAIT_ITERATIONS
1022  83B2
1023  83B2
1024  83B2              INKEY_SELECT_WAIT_MODE:
1025  83B2 B7               or a
1026  83B3 20 1E            jr nz, INKEY_NO_WAIT
1027  83B5
1028  83B5              INKEY_WAIT:
1029  83B5 C5               push bc
1030  83B6 CD 9B 83     1:  call INKEY
1031  83B9 B7               or a
1032  83BA 28 FA            jr z, 1b       ;Detect keypress
1033  83BC 4F               ld c, a
1034  83BD 06 0A            ld b, INKEY_WAIT_ITERATIONS
1035  83BF CD 9B 83     2:  call INKEY
1036  83C2 B7               or a
1037  83C3 28 FA            jr z, 2b       ;Detect keypress again
1038  83C5 B9               cp c
1039  83C6 20 EE            jr nz, 1b      ;Different key, we begin again
1040  83C8 10 F5            djnz 2b        ;Decrease counter
1041  83CA CD 9B 83     3:  call INKEY
1042  83CD B7               or a
1043  83CE 20 FA            jr nz, 3b       ;Detect key release
1044  83D0 79               ld a, c
1045  83D1 C1               pop bc
1046  83D2 C9               ret
1047  83D3
1048  83D3              INKEY_NO_WAIT:
1049  83D3 C5               push bc
1050  83D4 CD 9B 83     1:  call INKEY
1051  83D7 B7               or a
1052  83D8 28 0F            jr z, .empty_inkey
1053  83DA 4F               ld c, a
1054  83DB 06 0A            ld b, INKEY_NO_WAIT_ITERATIONS
1055  83DD CD 9B 83     2:  call INKEY
1056  83E0 B7               or a
1057  83E1 28 06            jr z, .empty_inkey
1058  83E3 B9               cp c
1059  83E4 20 EE            jr nz, 1b      ;Different key, we begin again
1060  83E6 10 F5            djnz 2b        ;Decrease counter
1061  83E8 79               ld a, c        ;Returns key pressed
1062  83E9              .empty_inkey:
1063  83E9 C1               pop bc
1064  83EA C9               ret
1065  83EB
1066  83EB              KEYPRESS_RIGHT EQU %00000001
1067  83EB              KEYPRESS_LEFT  EQU %00000010
1068  83EB              KEYPRESS_DOWN  EQU %00000100
1069  83EB              KEYPRESS_UP    EQU %00001000
1070  83EB              KEYPRESS_FIRE  EQU %00010000
1071  83EB
1072  83EB              ;
1073  83EB              ; Keypress format:
1074  83EB              ;   xxxKUDLR
1075  83EB
1076  83EB              INKEY_MENU:
1077  83EB C5               push bc
1078  83EC AF               xor a
1079  83ED 4F               ld c, a
1080  83EE CD 9B 83         call INKEY
1081  83F1              .right:
1082  83F1 FE 09            cp $09  ; cursor right
1083  83F3 28 04            jr z, .right_ok
1084  83F5 FE 70            cp 'p'
1085  83F7 20 06            jr nz, .left
1086  83F9              .right_ok:
1087  83F9 47               ld b, a
1088  83FA 79               ld a, c
1089  83FB F6 01            or KEYPRESS_RIGHT
1090  83FD 4F               ld c, a
1091  83FE 78               ld a, b
1092  83FF              .left:
1093  83FF FE 08            cp $08  ; cursor left
1094  8401 28 04            jr z, .left_ok
1095  8403 FE 6F            cp 'o'
1096  8405 20 06            jr nz, .down
1097  8407              .left_ok:
1098  8407 47               ld b, a
1099  8408 79               ld a, c
1100  8409 F6 02            or KEYPRESS_LEFT
1101  840B 4F               ld c, a
1102  840C 78               ld a, b
1103  840D              .down:
1104  840D FE 0A            cp $0A  ; cursor down
1105  840F 28 04            jr z, .down_ok
1106  8411 FE 61            cp 'a'
1107  8413 20 06            jr nz, .up
1108  8415              .down_ok:
1109  8415 47               ld b, a
1110  8416 79               ld a, c
1111  8417 F6 04            or KEYPRESS_DOWN
1112  8419 4F               ld c, a
1113  841A 78               ld a, b
1114  841B              .up:
1115  841B FE 0B            cp $0B  ; cursor up
1116  841D 28 04            jr z, .up_ok
1117  841F FE 71            cp 'q'
1118  8421 20 06            jr nz, .selected
1119  8423              .up_ok:
1120  8423 47               ld b, a
1121  8424 79               ld a, c
1122  8425 F6 08            or KEYPRESS_UP
1123  8427 4F               ld c, a
1124  8428 78               ld a, b
1125  8429              .selected:
1126  8429 FE 20            cp ' '
1127  842B 28 08            jr z, .selected_ok
1128  842D FE 6D            cp 'm'
1129  842F 28 04            jr z, .selected_ok
1130  8431 FE 0D            cp 13
1131  8433 20 04            jr nz, .kempston
1132  8435              .selected_ok:
1133  8435 3E 10            ld a, KEYPRESS_FIRE
1134  8437 B1               or c
1135  8438 4F               ld c, a
1136  8439              .kempston:
1137  8439 CD 3F 84         call KEMPSTON
1138  843C B1               or c
1139  843D C1               pop bc
1140  843E C9               ret
1141  843F
1142  843F              KEMPSTON:
1143  843F 3A 42 80         ld a, (KEMPSTON_VALUE)
1144  8442 FE FF            cp $FF         ;Bus value if joystick not connected on blanking to avoid floating bus issues
1145  8444 28 12            jr z, .invalid
1146  8446 DB 1F            in a, ($1F)    ;Read kempston
1147  8448 47               ld b, a
1148  8449 E6 03            and %00000011  ; Up + Down is invalid
1149  844B FE 03            cp %00000011
1150  844D 28 09            jr z, .invalid
1151  844F 78               ld a, b
1152  8450 E6 0C            and %00001100  ; Left + Right is invalid
1153  8452 FE 0C            cp %00001100
1154  8454 28 02            jr z, .invalid
1155  8456 78               ld a, b
1156  8457 C9               ret
1157  8458              .invalid:
1158  8458 AF               xor a
1159  8459 C9               ret
1160  845A              ; ==============================================================================
1161  845A              ; Choose Your Destiny
1162  845A              ;
1163  845A              ; Copyright (c) 2025 Sergio Chico (Cronomantic)
1164  845A              ;
1165  845A              ; Permission is hereby granted, free of charge, to any person obtaining a copy
1166  845A              ; of this software and associated documentation files (the "Software"), to deal
1167  845A              ; in the Software without restriction, including without limitation the rights
1168  845A              ; to use, copy, modify, merge, publish, distribute and/or sell copies of the
1169  845A              ; Software, and to permit persons to whom the Software is furnished to do so,
1170  845A              ; subject to the following conditions:
1171  845A              ;
1172  845A              ; - The above copyright notice and this permission notice shall be included
1173  845A              ; in all copies or substantial portions of the Software.
1174  845A              ;
1175  845A              ; - The above copyright notice and/or one of the project logos must
1176  845A              ; be prominently displayed both on the loading screen and/or within
1177  845A              ; the programs that include this Software, as well as on the
1178  845A              ; download website in the case of a digital copy and/or on the
1179  845A              ; cover page in the case of a physical copy.
1180  845A              ;
1181  845A              ; - THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
1182  845A              ; EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
1183  845A              ; MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
1184  845A              ; IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
1185  845A              ; DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
1186  845A              ; OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR
1187  845A              ; THE USE OR OTHER DEALINGS IN THE SOFTWARE.
1188  845A              ;
1189  845A              ; ==============================================================================
1190  845A
1191  845A              ROM48KBASIC EQU %00010000
1192  845A
1193  845A              ;====================================================
1194  845A              ; Cambiamos el banco elegido en $C000
1195  845A              ; ParÃ¡metros:
1196  845A              ;    A = Nuevo valor del banco
1197  845A              ; Salida:
1198  845A              ;    A = Valor anterior del banco
1199  845A              ; Registros afectados:
1200  845A              ;   AF, BC
1201  845A              ;====================================================
1202  845A              SET_RAM_BANK:
1203  845A E6 17            AND %00010111                 ;mask correct bytes
1204  845C 47               LD B, A
1205  845D 3A 5C 5B         LD A,(PLUS3_DOS_BANKM)        ; Previous value of the port
1206  8460 F5               PUSH AF                       ; Saving in stack
1207  8461 E6 E8            AND %11101000                 ; Change only bank bits
1208  8463 B0               OR B                          ; Select bank on B
1209  8464 01 FD 7F         LD BC,$7ffd
1210  8467 F3               DI
1211  8468 32 5C 5B         LD (PLUS3_DOS_BANKM),A
1212  846B ED 79            OUT (C),A                     ;update port
1213  846D FB               EI
1214  846E F1               POP AF                        ;Recovering previous value
1215  846F C9               RET
1216  8470
1217  8470              RESET_SYS:
1218  8470 AF               XOR A
1219  8471 01 FD 7F         LD BC, $7ffd
1220  8474 F3               DI
1221  8475 ED 79            OUT (C),A          ;update port
1222  8477 06 1F            LD B,$1F           ;BC=1FFD
1223  8479 ED 79            OUT (C),A          ;update port
1224  847B 21 00 00         LD HL, 0
1225  847E E3               EX (SP), HL
1226  847F C9               RET
1227  8480
1228  8480              SET_DEFAULT_BANKS:
1229  8480 3A 67 5B         LD A, (PLUS3_DOS_BANK678)
1230  8483 6F               LD L, A
1231  8484 E6 07            AND %00000111
1232  8486 67               LD H, A
1233  8487 7D               LD A, L
1234  8488 E6 F8            AND %11111000
1235  848A F6 04            OR %00000100                  ;Rom 2/3 selection (+3dos / 48 basic)
1236  848C 01 FD 1F         LD BC,$1FFD                   ;BC=1FFD
1237  848F ED 79            OUT (C), A                     ;update port
1238  8491 32 67 5B         LD (PLUS3_DOS_BANK678), A
1239  8494
1240  8494 3A 5C 5B         LD A, (PLUS3_DOS_BANKM)
1241  8497 6F               LD L, A
1242  8498 E6 E8            AND %11101000                 ;Change only bank bits
1243  849A F6 10            OR %00010000                  ;Set ROM 48K & Bank 0
1244  849C 06 7F            LD B, $7F                     ;BC=7FFD
1245  849E ED 79            OUT (C), A                    ;update port
1246  84A0 32 5C 5B         LD (PLUS3_DOS_BANKM), A
1247  84A3 C9               RET
1248  84A4              ; -----------------------------------------------------------------------------
1249  84A4              ; ZX0 decoder by Einar Saukas & introspec
1250  84A4              ; "Turbo" version (126 bytes, 21% faster)
1251  84A4              ; -----------------------------------------------------------------------------
1252  84A4              ; Parameters:
1253  84A4              ;   HL: source address (compressed data)
1254  84A4              ;   DE: destination address (decompressing)
1255  84A4              ; -----------------------------------------------------------------------------
1256  84A4
1257  84A4              dzx0_turbo:
1258  84A4 01 FF FF             ld      bc, $ffff               ; preserve default offset 1
1259  84A7 ED 43 D2 84          ld      (dzx0t_last_offset+1), bc
1260  84AB 03                   inc     bc
1261  84AC 3E 80                ld      a, $80
1262  84AE 18 2B                jr      dzx0t_literals
1263  84B0              dzx0t_new_offset:
1264  84B0 0E FE                ld      c, $fe                  ; prepare negative offset
1265  84B2 87                   add     a, a
1266  84B3 C2 B9 84             jp      nz, dzx0t_new_offset_skip
1267  84B6 7E                   ld      a, (hl)                 ; load another group of 8 bits
1268  84B7 23                   inc     hl
1269  84B8 17                   rla
1270  84B9              dzx0t_new_offset_skip:
1271  84B9 D4 F9 84             call    nc, dzx0t_elias         ; obtain offset MSB
1272  84BC 0C                   inc     c
1273  84BD C8                   ret     z                       ; check end marker
1274  84BE 41                   ld      b, c
1275  84BF 4E                   ld      c, (hl)                 ; obtain offset LSB
1276  84C0 23                   inc     hl
1277  84C1 CB 18                rr      b                       ; last offset bit becomes first length bit
1278  84C3 CB 19                rr      c
1279  84C5 ED 43 D2 84          ld      (dzx0t_last_offset+1), bc ; preserve new offset
1280  84C9 01 01 00             ld      bc, 1                   ; obtain length
1281  84CC D4 F9 84             call    nc, dzx0t_elias
1282  84CF 03                   inc     bc
1283  84D0              dzx0t_copy:
1284  84D0 E5                   push    hl                      ; preserve source
1285  84D1              dzx0t_last_offset:
1286  84D1 21 00 00             ld      hl, 0                   ; restore offset
1287  84D4 19                   add     hl, de                  ; calculate destination - offset
1288  84D5 ED B0                ldir                            ; copy from offset
1289  84D7 E1                   pop     hl                      ; restore source
1290  84D8 87                   add     a, a                    ; copy from literals or new offset?
1291  84D9 38 D5                jr      c, dzx0t_new_offset
1292  84DB              dzx0t_literals:
1293  84DB 0C                   inc     c                       ; obtain length
1294  84DC 87                   add     a, a
1295  84DD C2 E3 84             jp      nz, dzx0t_literals_skip
1296  84E0 7E                   ld      a, (hl)                 ; load another group of 8 bits
1297  84E1 23                   inc     hl
1298  84E2 17                   rla
1299  84E3              dzx0t_literals_skip:
1300  84E3 D4 F9 84             call    nc, dzx0t_elias
1301  84E6 ED B0                ldir                            ; copy literals
1302  84E8 87                   add     a, a                    ; copy from last offset or new offset?
1303  84E9 38 C5                jr      c, dzx0t_new_offset
1304  84EB 0C                   inc     c                       ; obtain length
1305  84EC 87                   add     a, a
1306  84ED C2 F3 84             jp      nz, dzx0t_last_offset_skip
1307  84F0 7E                   ld      a, (hl)                 ; load another group of 8 bits
1308  84F1 23                   inc     hl
1309  84F2 17                   rla
1310  84F3              dzx0t_last_offset_skip:
1311  84F3 D4 F9 84             call    nc, dzx0t_elias
1312  84F6 C3 D0 84             jp      dzx0t_copy
1313  84F9              dzx0t_elias:
1314  84F9 87                   add     a, a                    ; interlaced Elias gamma coding
1315  84FA CB 11                rl      c
1316  84FC 87                   add     a, a
1317  84FD 30 FA                jr      nc, dzx0t_elias
1318  84FF C0                   ret     nz
1319  8500 7E                   ld      a, (hl)                 ; load another group of 8 bits
1320  8501 23                   inc     hl
1321  8502 17                   rla
1322  8503 D8                   ret     c
1323  8504 87                   add     a, a
1324  8505 CB 11                rl      c
1325  8507 87                   add     a, a
1326  8508 D8                   ret     c
1327  8509 87                   add     a, a
1328  850A CB 11                rl      c
1329  850C 87                   add     a, a
1330  850D D8                   ret     c
1331  850E 87                   add     a, a
1332  850F CB 11                rl      c
1333  8511 87                   add     a, a
1334  8512 D8                   ret     c
1335  8513              dzx0t_elias_loop:
1336  8513 87                   add     a, a
1337  8514 CB 11                rl      c
1338  8516 CB 10                rl      b
1339  8518 87                   add     a, a
1340  8519 30 F8                jr      nc, dzx0t_elias_loop
1341  851B C0                   ret     nz
1342  851C 7E                   ld      a, (hl)                 ; load another group of 8 bits
1343  851D 23                   inc     hl
1344  851E 17                   rla
1345  851F 30 F2                jr      nc, dzx0t_elias_loop
1346  8521 C9                   ret
1347  8522              ; -----------------------------------------------------------------------------
1348  8522              ; ==============================================================================
1349  8522              ; Choose Your Destiny
1350  8522              ;
1351  8522              ; Copyright (c) 2025 Sergio Chico (Cronomantic)
1352  8522              ;
1353  8522              ; Permission is hereby granted, free of charge, to any person obtaining a copy
1354  8522              ; of this software and associated documentation files (the "Software"), to deal
1355  8522              ; in the Software without restriction, including without limitation the rights
1356  8522              ; to use, copy, modify, merge, publish, distribute and/or sell copies of the
1357  8522              ; Software, and to permit persons to whom the Software is furnished to do so,
1358  8522              ; subject to the following conditions:
1359  8522              ;
1360  8522              ; - The above copyright notice and this permission notice shall be included
1361  8522              ; in all copies or substantial portions of the Software.
1362  8522              ;
1363  8522              ; - The above copyright notice and/or one of the project logos must
1364  8522              ; be prominently displayed both on the loading screen and/or within
1365  8522              ; the programs that include this Software, as well as on the
1366  8522              ; download website in the case of a digital copy and/or on the
1367  8522              ; cover page in the case of a physical copy.
1368  8522              ;
1369  8522              ; - THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
1370  8522              ; EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
1371  8522              ; MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
1372  8522              ; IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
1373  8522              ; DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
1374  8522              ; OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR
1375  8522              ; THE USE OR OTHER DEALINGS IN THE SOFTWARE.
1376  8522              ;
1377  8522              ; ==============================================================================
1378  8522
1379  8522
1380  8522              ; B <- Start flag
1381  8522              ; C <- Number of flags to save
1382  8522              CHK_RAMLOAD_PARAMETERS:
1383  8522 79               ld a, c
1384  8523 B0               or b                  ;Both are zero
1385  8524 C8               ret z
1386  8525 79               ld a, c
1387  8526 B7               or a
1388  8527 28 03            jr z, 1f
1389  8529 78               ld a, b
1390  852A 81               add a, c
1391  852B D0               ret nc                ; If NC then < 256 so OK
1392  852C AF           1:  xor a
1393  852D 90               sub b
1394  852E 4F               ld c, a
1395  852F C9               ret
1396  8530
1397  8530              ; B <- Start flag
1398  8530              ; C <- Number of flags to load
1399  8530              RAMLOAD:
1400  8530 21 13 7B         ld hl, SAVE_FLAGS
1401  8533 11 00 5D         ld de, FLAGS
1402  8536 18 15            jr COPY_FLAGS
1403  8538              ; B <- Start flag
1404  8538              ; C <- Number of flags to save
1405  8538              RAMSAVE:
1406  8538                  ;Clear save flags
1407  8538 D9               exx
1408  8539 21 13 7B         ld hl, SAVE_FLAGS
1409  853C 11 14 7B         ld de, SAVE_FLAGS+1
1410  853F 01 FF 00         ld bc, 255
1411  8542 AF               xor a
1412  8543 77               ld (hl), a
1413  8544 ED B0            ldir
1414  8546 D9               exx
1415  8547 21 00 5D         ld hl, FLAGS
1416  854A 11 13 7B         ld de, SAVE_FLAGS
1417  854D              COPY_FLAGS:
1418  854D 78               ld a, b
1419  854E B7               or a
1420  854F 28 04            jr z, 2f
1421  8551 23           1:  inc hl
1422  8552 13               inc de
1423  8553 10 FC            djnz 1b  ;until B = 0
1424  8555 79           2:  ld a, c
1425  8556 B7               or a
1426  8557 20 01            jr nz, 3f
1427  8559 04               inc b    ;BC = 256
1428  855A ED B0        3:  ldir     ;We only have C
1429  855C C9               ret
1430  855D
1431  855D              ;https://wikiti.brandonw.net/index.php?title=Z80_Routines:Security:CRC16
1432  855D              CRC16:
1433  855D              ;Borrowed from http://zilog.sh.cvut.cz/~base/misc/z80bits.html
1434  855D              ; and moddified to be a loop
1435  855D              ;The arrow comments show what lines I added or commented out from the original.
1436  855D              ;Inputs:    de->data bc=number of bytes
1437  855D              ;Outputs:   hl=CRC16
1438  855D C5               PUSH BC
1439  855E D5               PUSH DE
1440  855F F5               PUSH AF
1441  8560 21 FF FF         LD HL,$FFFF
1442  8563 C5               PUSH BC
1443  8564              .CRC16_Read:
1444  8564 1A               LD A,(DE)
1445  8565 13               INC DE
1446  8566 AC               XOR H
1447  8567 67               LD H,A
1448  8568 06 08            LD B,8
1449  856A              .CRC16_CrcByte:
1450  856A 29               ADD HL,HL
1451  856B 30 08            JR NC, .CRC16_Next
1452  856D 7C               LD A,H
1453  856E EE 10            XOR $10
1454  8570 67               LD H,A
1455  8571 7D               LD A,L
1456  8572 EE 21            XOR $21
1457  8574 6F               LD L,A
1458  8575              .CRC16_Next:
1459  8575 10 F3            DJNZ .CRC16_CrcByte
1460  8577              ;    DEC C
1461  8577 C1               POP BC
1462  8578 0B               DEC BC
1463  8579 C5               PUSH BC
1464  857A 78               LD A,B
1465  857B B1               OR C
1466  857C 20 E6            JR NZ, .CRC16_Read
1467  857E C1               POP BC
1468  857F F1               POP AF
1469  8580 D1               POP DE
1470  8581 C1               POP BC
1471  8582 C9               ret
1472  8583
1473  8583                  ;test checksum
1474  8583              ; If Z = 1 , valid
1475  8583              ; IF Z = 0, INVALID
1476  8583              TEST_CHECKSUM:
1477  8583 11 00 7B         ld de, SAVE_START
1478  8586 01 13 01         ld bc, SAVE_SIZE-2
1479  8589 CD 5D 85         call CRC16
1480  858C ED 5B 13 7C      ld de, (SAVE_CHECKSUM)
1481  8590 7D               ld a, l
1482  8591 BB               cp e
1483  8592 C0               ret nz
1484  8593 7C               ld a, h
1485  8594 BA               cp d
1486  8595 C9               ret
1487  8596
1488  8596              ;test game signature
1489  8596              ; If Z = 1 , valid
1490  8596              ; IF Z = 0, INVALID
1491  8596              COMPARE_GAME_ID:
1492  8596 11 00 7B         ld de, SAVE_GAME_ID
1493  8599 21 8B 83         ld hl, GAME_ID
1494  859C 06 10            ld b, 16
1495  859E 1A           1:  ld a, (de)
1496  859F BE               cp (hl)
1497  85A0 C0               ret nz
1498  85A1 10 FB            djnz 1b
1499  85A3 AF               xor a        ;Clear Z
1500  85A4 C9               ret
1501  85A5
1502  85A5              ;------------------------------------------
1503  85A5              ; 0 <- Operation OK
1504  85A5              ; 1 <- Disk/tape error.
1505  85A5              DO_SAVE:
1506  85A5                  ; B <- Start flag
1507  85A5                  ; C <- Number of flags to save
1508  85A5 DD E5            push ix
1509  85A7 E5               push hl
1510  85A8 3A C8 5F         ld a, (CURR_SAVE_SLOT)
1511  85AB 32 10 7B         ld (SAVE_SLOT), a
1512  85AE ED 43 11 7B      ld (SAVE_NVARS), bc
1513  85B2 CD 38 85         call RAMSAVE
1514  85B5                  ;Copy game ID
1515  85B5 11 00 7B         ld de, SAVE_GAME_ID
1516  85B8 21 8B 83         ld hl, GAME_ID
1517  85BB 01 10 00         ld bc, 16
1518  85BE ED B0            ldir
1519  85C0 11 00 7B         ld de, SAVE_START
1520  85C3 01 13 01         ld bc, SAVE_SIZE-2
1521  85C6 CD 5D 85         call CRC16
1522  85C9 22 13 7C         ld (SAVE_CHECKSUM), hl
1523  85CC 3A 5C 5B         ld a, ($5b5c)
1524  85CF F6 10            or ROM48KBASIC
1525  85D1 CD 5A 84         call SET_RAM_BANK
1526  85D4 F5               push af
1527  85D5 3E FF            ld a, $FF
1528  85D7 DD 21 00 7B      ld ix, SAVE_START
1529  85DB 11 15 01         ld de, SAVE_SIZE
1530  85DE              ;Save
1531  85DE              ; On entry:
1532  85DE              ;  A=block type
1533  85DE              ;  IX=start
1534  85DE              ;  DE=length
1535  85DE CD C6 04         call $04C6      ; Call SA_BYTES+4
1536  85E1              ; On exit:
1537  85E1              ;   C    : Ok
1538  85E1              ;   NC   : SPACE pressed
1539  85E1 30 03            jr nc, .save_error
1540  85E3 AF               xor a
1541  85E4 18 50            jr END_TAPE_OP
1542  85E6              .save_error:
1543  85E6 3E 01            ld a, 1
1544  85E8 18 4C            jr END_TAPE_OP
1545  85EA
1546  85EA              ; 0 <- Operation OK
1547  85EA              ; 1 <- Disk/tape error.
1548  85EA              ; 2 <- GameId error.
1549  85EA              ; 3 <- Slot error
1550  85EA              ; 4 <- Checksum error
1551  85EA              DO_LOAD:
1552  85EA DD E5            push ix
1553  85EC E5               push hl
1554  85ED 3A 5C 5B         ld a, ($5b5c)
1555  85F0 F6 10            or ROM48KBASIC
1556  85F2 CD 5A 84         call SET_RAM_BANK
1557  85F5 F5               push af
1558  85F6 3E FF            ld a, $FF
1559  85F8 DD 21 00 7B      ld ix, SAVE_START
1560  85FC 11 15 01         ld de, SAVE_SIZE
1561  85FF 37               scf
1562  8600              ;Loading data
1563  8600              ; On entry:
1564  8600              ;  A=block type
1565  8600              ;  IX=start
1566  8600              ;  DE=length
1567  8600              ;  CS=load, CC=verify
1568  8600 14               inc d
1569  8601 08               ex af, af'       ; Set up flags
1570  8602 15               dec d
1571  8603 F3               di               ; Disable interupts
1572  8604 CD 62 05         call $0562       ; Call LD_BYTES+12
1573  8607              ;   C    : Ok
1574  8607              ;   NC   : SPACE pressed or Loading error
1575  8607 FB               ei
1576  8608 30 2A            jr nc, .load_error
1577  860A CD 83 85         call TEST_CHECKSUM
1578  860D 20 21            jr nz, .chksum_error
1579  860F CD 96 85         call COMPARE_GAME_ID
1580  8612 20 14            jr nz, .gameid_error
1581  8614 3A C8 5F         ld a, (CURR_SAVE_SLOT)
1582  8617 4F               ld c, a
1583  8618 3A 10 7B         ld a, (SAVE_SLOT)
1584  861B B9               cp c
1585  861C 20 0E            jr nz, .slot_error
1586  861E ED 4B 11 7B      ld bc, (SAVE_NVARS)
1587  8622 CD 30 85         call RAMLOAD
1588  8625 AF               xor a
1589  8626 18 0E            jr END_TAPE_OP
1590  8628              .gameid_error:
1591  8628 3E 02            ld a, 2
1592  862A 18 0A            jr END_TAPE_OP
1593  862C              .slot_error:
1594  862C 3E 03            ld a, 3
1595  862E 18 06            jr END_TAPE_OP
1596  8630              .chksum_error:
1597  8630 3E 04            ld a, 4
1598  8632 18 02            jr END_TAPE_OP
1599  8634              .load_error:
1600  8634 3E 01            ld a, 1
1601  8636              END_TAPE_OP:
1602  8636 32 C9 5F         ld (LAST_SAVE_RESULT), a
1603  8639 3A 48 5C         ld a, (BORDCR)
1604  863C 0F               rrca
1605  863D 0F               rrca
1606  863E 0F               rrca
1607  863F E6 07            and %00000111
1608  8641 CD 58 87         call BORDER
1609  8644 F1               pop af
1610  8645 CD 5A 84         call SET_RAM_BANK
1611  8648 E1               pop hl
1612  8649 DD E1            pop ix
1613  864B C9               ret
1614  864C
1615  864C              ;------------------------------------------
1616  864C
1617  864C              ; ==============================================================================
1618  864C              ; Choose Your Destiny
1619  864C              ;
1620  864C              ; Copyright (c) 2025 Sergio Chico (Cronomantic)
1621  864C              ;
1622  864C              ; Permission is hereby granted, free of charge, to any person obtaining a copy
1623  864C              ; of this software and associated documentation files (the "Software"), to deal
1624  864C              ; in the Software without restriction, including without limitation the rights
1625  864C              ; to use, copy, modify, merge, publish, distribute and/or sell copies of the
1626  864C              ; Software, and to permit persons to whom the Software is furnished to do so,
1627  864C              ; subject to the following conditions:
1628  864C              ;
1629  864C              ; - The above copyright notice and this permission notice shall be included
1630  864C              ; in all copies or substantial portions of the Software.
1631  864C              ;
1632  864C              ; - The above copyright notice and/or one of the project logos must
1633  864C              ; be prominently displayed both on the loading screen and/or within
1634  864C              ; the programs that include this Software, as well as on the
1635  864C              ; download website in the case of a digital copy and/or on the
1636  864C              ; cover page in the case of a physical copy.
1637  864C              ;
1638  864C              ; - THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
1639  864C              ; EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
1640  864C              ; MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
1641  864C              ; IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
1642  864C              ; DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
1643  864C              ; OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR
1644  864C              ; THE USE OR OTHER DEALINGS IN THE SOFTWARE.
1645  864C              ;
1646  864C              ; ==============================================================================
1647  864C
1648  864C
1649  864C              IMG_LOAD:
1650  864C 4F               ld c, a
1651  864D 06 01            ld b, TYPE_SCR
1652  864F CD 2E 83         call FIND_IN_INDEX
1653  8652 F6 10            or ROM48KBASIC
1654  8654 CD 5A 84         call SET_RAM_BANK
1655  8657 F5               push af
1656  8658
1657  8658 23               inc hl
1658  8659 23               inc hl
1659  865A 7E               ld a, (hl)
1660  865B 32 CB 5F         ld (PIC_NUM_LINES_PXL), a
1661  865E 23               inc hl
1662  865F 7E               ld a, (hl)
1663  8660 32 CC 5F         ld (PIC_NUM_LINES_ATT), a
1664  8663 23               inc hl
1665  8664 E5               push hl
1666  8665 CD FF 86         call CLS_BUFFER
1667  8668 E1               pop hl
1668  8669 11 00 60         ld de, SCREEN_BUFFER_PXL
1669  866C CD A4 84         call dzx0_turbo
1670  866F 11 00 78         ld de, SCREEN_BUFFER_ATT
1671  8672 CD A4 84         call dzx0_turbo
1672  8675
1673  8675 3A CC 5F         ld a,(PIC_NUM_LINES_ATT)  ; Test if has mirroring
1674  8678 47               ld b, a
1675  8679 E6 7F            and %01111111
1676  867B 32 CC 5F         ld (PIC_NUM_LINES_ATT), a ; Put the correct number of att lines
1677  867E 32 CE 86         ld (att_self_m), a ; Self modified code for later
1678  8681 3E 80            ld a, %10000000
1679  8683 A0               and b                      ; If Zero, then not mirroring
1680  8684 28 3E            jr z, .no_mirror
1681  8686
1682  8686              ;Mirror pixels
1683  8686 11 00 60         ld de, SCREEN_BUFFER_PXL
1684  8689 3A CB 5F         ld a, (PIC_NUM_LINES_PXL)
1685  868C 47               ld b, a
1686  868D              .loop1:
1687  868D 48               ld c, b
1688  868E 21 1F 00         ld hl, 31
1689  8691 19               add hl, de
1690  8692 E5               push hl
1691  8693 06 10            ld b, 16
1692  8695              .loop2:
1693  8695 1A               ld a, (de)
1694  8696 13               inc de
1695  8697                  ;inverting the byte
1696  8697 D9               exx
1697  8698 06 08            ld b, 8
1698  869A              .loop3:
1699  869A 1F               rra
1700  869B CB 11            rl c
1701  869D 10 FB            djnz .loop3
1702  869F 79               ld a, c
1703  86A0 D9               exx
1704  86A1 77               ld (hl), a
1705  86A2 2B               dec hl
1706  86A3 10 F0            djnz .loop2
1707  86A5 D1               pop de
1708  86A6 13               inc de
1709  86A7 41               ld b, c
1710  86A8 10 E3            djnz .loop1
1711  86AA
1712  86AA              ;Mirror attributtes
1713  86AA 11 00 78         ld de, SCREEN_BUFFER_ATT
1714  86AD 3A CC 5F         ld a, (PIC_NUM_LINES_ATT)
1715  86B0 47               ld b, a
1716  86B1              .loop4:
1717  86B1 48               ld c, b
1718  86B2 21 1F 00         ld hl, 31
1719  86B5 19               add hl, de
1720  86B6 E5               push hl
1721  86B7 06 10            ld b, 16
1722  86B9              .loop5:
1723  86B9 1A               ld a, (de)
1724  86BA 13               inc de
1725  86BB 77               ld (hl), a
1726  86BC 2B               dec hl
1727  86BD 10 FA            djnz .loop5
1728  86BF D1               pop de
1729  86C0 13               inc de
1730  86C1 41               ld b, c
1731  86C2 10 ED            djnz .loop4
1732  86C4
1733  86C4              .no_mirror:
1734  86C4 F1               pop af
1735  86C5 CD 5A 84         call SET_RAM_BANK
1736  86C8 C9               ret
1737  86C9
1738  86C9              COPY_SCREEN:
1739  86C9 CD F2 86         call SET_CLEAR_COLOR
1740  86CC F5               push af
1741  86CD              att_self_m+1:
1742  86CD 3E 00            ld a, 0
1743  86CF 0F               rrca
1744  86D0 0F               rrca
1745  86D1 0F               rrca
1746  86D2 47               ld b, a
1747  86D3 E6 E0            and %11100000
1748  86D5 4F               ld c, a
1749  86D6 3E 1F            ld a, %00011111
1750  86D8 A0               and b
1751  86D9 47               ld b, a
1752  86DA 0B               dec bc
1753  86DB F1               pop af
1754  86DC 21 00 58         ld hl, SCR_ATT
1755  86DF 77               ld (hl), a
1756  86E0 11 01 58         ld de, SCR_ATT+1
1757  86E3 ED B0            ldir
1758  86E5 3E 01            ld a, 1
1759  86E7 32 3E 80         ld (UPDATE_SCR_FLAG), a
1760  86EA 76               halt
1761  86EB 3A 3E 80     1:  ld a, (UPDATE_SCR_FLAG)  ; Get flag
1762  86EE B7               or a
1763  86EF 20 FA            jr nz, 1b
1764  86F1 C9               ret
1765  86F2
1766  86F2              ;--------------
1767  86F2              SET_CLEAR_COLOR:
1768  86F2 3A 8D 5C         ld A, (23693)      ;Get ATTR
1769  86F5 E6 F8            and %11111000      ;Mask INK
1770  86F7 47               ld B, A            ;Saving on b
1771  86F8 0F               rrca
1772  86F9 0F               rrca
1773  86FA 0F               rrca               ;Move PAPER to the left
1774  86FB E6 07            and %00000111      ;Mask new INK
1775  86FD B0               or B               ;Set new INK the same as PAPER
1776  86FE C9               ret
1777  86FF              ;---------------
1778  86FF              CLS_BUFFER:
1779  86FF 11 01 60         ld de, SCREEN_BUFFER_PXL+1
1780  8702 21 00 60         ld hl, SCREEN_BUFFER_PXL
1781  8705 01 FF 1A         ld bc, SCR_SIZE-1
1782  8708 AF               xor a
1783  8709 36 00            ld (hl), 0
1784  870B ED B0            ldir
1785  870D C9               ret
1786  870E
1787  870E
1788  870E
1789  870E              ;------------------------------------------------------------------------
1790  870E
1791  870E              ; ==============================================================================
1792  870E              ; Choose Your Destiny
1793  870E              ;
1794  870E              ; Copyright (c) 2025 Sergio Chico (Cronomantic)
1795  870E              ;
1796  870E              ; Permission is hereby granted, free of charge, to any person obtaining a copy
1797  870E              ; of this software and associated documentation files (the "Software"), to deal
1798  870E              ; in the Software without restriction, including without limitation the rights
1799  870E              ; to use, copy, modify, merge, publish, distribute and/or sell copies of the
1800  870E              ; Software, and to permit persons to whom the Software is furnished to do so,
1801  870E              ; subject to the following conditions:
1802  870E              ;
1803  870E              ; - The above copyright notice and this permission notice shall be included
1804  870E              ; in all copies or substantial portions of the Software.
1805  870E              ;
1806  870E              ; - The above copyright notice and/or one of the project logos must
1807  870E              ; be prominently displayed both on the loading screen and/or within
1808  870E              ; the programs that include this Software, as well as on the
1809  870E              ; download website in the case of a digital copy and/or on the
1810  870E              ; cover page in the case of a physical copy.
1811  870E              ;
1812  870E              ; - THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
1813  870E              ; EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
1814  870E              ; MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
1815  870E              ; IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
1816  870E              ; DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
1817  870E              ; OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR
1818  870E              ; THE USE OR OTHER DEALINGS IN THE SOFTWARE.
1819  870E              ;
1820  870E              ; ==============================================================================
1821  870E
1822  870E              INIT_WIN:
1823  870E 3E 20            ld a, $20
1824  8710 CD F6 88         call GET_CHARACTER_WIDTH
1825  8713 32 C7 5F         ld (WIDTH_BACKSPACE), a
1826  8716
1827  8716 3E 08            ld a, MAXWINDOWS
1828  8718 11 15 7C         ld de, WINDOWS
1829  871B 08           1:  ex af, af'
1830  871C 01 07 00         ld bc, .end_data-.win_data
1831  871F 21 51 87         ld hl, .win_data
1832  8722 ED B0            ldir
1833  8724 3A 8D 5C         ld a, (ATTR_P)
1834  8727 12               ld (de), a
1835  8728 13               inc de
1836  8729 08               ex af, af'
1837  872A 3D               dec a
1838  872B 20 EE            jr nz, 1b
1839  872D
1840  872D                  ;Init other variables
1841  872D 11 A4 5F         ld de, NUM_OPTIONS
1842  8730 01 1A 00         ld bc, .end_data-.data
1843  8733 21 3E 87         ld hl, .data
1844  8736 ED B0            ldir
1845  8738 CD D6 8C         call SET_BACKSPACE_MARGINS_WIDTH
1846  873B C3 18 8D         jp CLEAR_WIN
1847  873E              .data:
1848  873E 00               DEFB 0
1849  873F 00               DEFB 0
1850  8740 00               DEFB 0
1851  8741 00               DEFB 0
1852  8742 01               DEFB 1
1853  8743 00               DEFB 0
1854  8744 01               DEFB 1
1855  8745 00               DEFB 0
1856  8746 00               DEFB 0
1857  8747 00 00 00...      DEFS 6, 0
1858  874D 00 00            DEFW 0
1859  874F 00               DEFB 0
1860  8750 00               DEFB 0
1861  8751              .win_data:
1862  8751 00               DEFB 0
1863  8752 00               DEFB 0
1864  8753 00               DEFB 0
1865  8754 00               DEFB 0
1866  8755 FF               DEFB 255
1867  8756 17               DEFB 23
1868  8757 00               DEFB 0
1869  8758              .end_data:
1870  8758
1871  8758              ; The border color is on A
1872  8758              ; Set C on error
1873  8758              BORDER:
1874  8758 FE 08            cp $08
1875  875A 30 10            jr nc, .t2
1876  875C D3 FE            out ($FE), A 	;The 'OUT' instruction is then used to set the border colour.
1877  875E 07               rlca 	        ;The parameter is then multiplied by eight.
1878  875F 07               rlca
1879  8760 07               rlca
1880  8761 CB 6F            bit 5,A 	    ;Is the border colour a 'light' colour?
1881  8763 20 02            jr nz, .t1 	    ;Jump if so (the INK colour will be black).
1882  8765 EE 07            xor $07 	    ;Change the INK colour to white.
1883  8767              .t1:
1884  8767 32 48 5C         ld (BORDCR),a 	;Set the system variable (BORDCR) as required and return.
1885  876A B7               or a
1886  876B C9               ret
1887  876C              .t2:
1888  876C 37               scf
1889  876D C9               ret
1890  876E
1891  876E              ;
1892  876E              ; Set INK value
1893  876E              ;
1894  876E              ; Sets the INK color passed in A register in the ATTR_T variable
1895  876E              INK_TMP:
1896  876E 11 8F 5C         ld de, ATTR_T
1897  8771 18 03            jr .SET_INK
1898  8773              !INK:
1899  8773 11 8D 5C         ld de, ATTR_P
1900  8776              .SET_INK:
1901  8776 FE 08            cp 8
1902  8778 20 06            jr nz, .SET_INK2
1903  877A 13               inc de ; Points DE to MASK_T or MASK_P
1904  877B 1A               ld a, (de)
1905  877C F6 07            or 7 ; Set bits 0,1,2 to enable transparency
1906  877E 12               ld (de), a
1907  877F C9               ret
1908  8780              .SET_INK2:
1909  8780                  ; Another entry. This will set the ink color at location pointer by DE
1910  8780 E6 07            and 7	; # Gets color mod 8
1911  8782 47               ld b, a	; Saves the color
1912  8783 1A               ld a, (de)
1913  8784 E6 F8            and $F8 ; Clears previous value
1914  8786 B0               or b
1915  8787 12               ld (de), a
1916  8788 13               inc de ; Points DE to MASK_T or MASK_P
1917  8789 1A               ld a, (de)
1918  878A E6 F8            and 0F8h ; Reset bits 0,1,2 sign to disable transparency
1919  878C 12               ld (de), a ; Store new attr
1920  878D C9               ret
1921  878E
1922  878E              ; Sets the PAPER color passed in A register in the ATTR_T variable
1923  878E              PAPER_TMP:
1924  878E 11 8F 5C         ld de, ATTR_T
1925  8791 18 03            jr .SET_PAPER
1926  8793              ; Set Paper value
1927  8793              !PAPER:
1928  8793 11 8D 5C         ld de, ATTR_P
1929  8796              .SET_PAPER:
1930  8796 FE 08            cp 8
1931  8798 20 06            jr nz, .SET_PAPER2
1932  879A 13               inc de
1933  879B 1A               ld a, (de)
1934  879C F6 38            or $38
1935  879E 12               ld (de), a
1936  879F C9               ret
1937  87A0                  ; Another entry. This will set the paper color at location pointer by DE
1938  87A0              .SET_PAPER2:
1939  87A0 E6 07            and 7	; # Remove
1940  87A2 07               rlca
1941  87A3 07               rlca
1942  87A4 07               rlca		; a *= 8
1943  87A5 47               ld b, a	; Saves the color
1944  87A6 1A               ld a, (de)
1945  87A7 E6 C7            and $C7 ; Clears previous value
1946  87A9 B0               or b
1947  87AA 12               ld (de), a
1948  87AB 13               inc de ; Points to MASK_T or MASK_P accordingly
1949  87AC 1A               ld a, (de)
1950  87AD E6 C7            and $C7  ; Resets bits 3,4,5
1951  87AF 12               ld (de), a
1952  87B0 C9               ret
1953  87B1
1954  87B1
1955  87B1              ; Sets the BRIGHT flag passed in A register in the ATTR_T variable
1956  87B1              BRIGHT_TMP:
1957  87B1 21 8F 5C         ld hl, ATTR_T
1958  87B4 18 03            jr .SET_BRIGHT
1959  87B6              !BRIGHT:
1960  87B6 21 8D 5C         ld hl, ATTR_P
1961  87B9              .SET_BRIGHT:
1962  87B9                  ; Another entry. This will set the bright flag at location pointer by DE
1963  87B9 FE 08            cp 8
1964  87BB 28 0F            jr z, .IS_TR
1965  87BD                  ; # Convert to 0/1
1966  87BD B7               or a
1967  87BE 28 02            jr z, .IS_ZERO
1968  87C0 3E 40            ld a, $40
1969  87C2              .IS_ZERO:
1970  87C2 47               ld b, a	; Saves the color
1971  87C3 7E               ld a, (hl)
1972  87C4 E6 BF            and $BF ; Clears previous value
1973  87C6 B0               or b
1974  87C7 77               ld (hl), a
1975  87C8 23               inc hl
1976  87C9 CB B6            res 6, (hl)  ;Reset bit 6 to disable transparency
1977  87CB C9               ret
1978  87CC              .IS_TR:  ; transparent
1979  87CC 23               inc hl ; Points DE to MASK_T or MASK_P
1980  87CD CB F6            set 6, (hl)  ;Set bit 6 to enable transparency
1981  87CF C9               ret
1982  87D0
1983  87D0
1984  87D0              ; Sets the FLASH flag passed in A register in the ATTR_T variable
1985  87D0              FLASH_TMP:
1986  87D0 21 8F 5C         ld hl, ATTR_T
1987  87D3 18 03            jr .SET_FLASH
1988  87D5              !FLASH:
1989  87D5 21 8D 5C         ld hl, ATTR_P
1990  87D8              .SET_FLASH:
1991  87D8                  ; Another entry. This will set the flash flag at location pointer by DE
1992  87D8 FE 08            cp 8
1993  87DA 28 0F            jr z, .IS_TR
1994  87DC                  ; # Convert to 0/1
1995  87DC B7               or a
1996  87DD 28 02            jr z, .IS_ZERO
1997  87DF 3E 80            ld a, $80
1998  87E1              .IS_ZERO:
1999  87E1 47               ld b, a	; Saves the color
2000  87E2 7E               ld a, (hl)
2001  87E3 E6 7F            and $7F ; Clears previous value
2002  87E5 B0               or b
2003  87E6 77               ld (hl), a
2004  87E7 23               inc hl
2005  87E8 CB BE            res 7, (hl)  ;Reset bit 7 to disable transparency
2006  87EA C9               ret
2007  87EB              .IS_TR:  ; transparent
2008  87EB 23               inc hl ; Points DE to MASK_T or MASK_P
2009  87EC CB FE            set 7, (hl)  ;Set bit 7 to enable transparency
2010  87EE C9               ret
2011  87EF
2012  87EF
2013  87EF              ;------------------------------------------------------------------------
2014  87EF              SET_MARGINS:
2015  87EF                  ;BC = PosY, PosX
2016  87EF                  ;DE = Height, Width
2017  87EF 79               ld a, c
2018  87F0 FE 20            cp 32     ;POSX - 32
2019  87F2 38 02            jr c, 1f
2020  87F4 3E 1F            ld a, 31
2021  87F6 4F           1:  ld c, a
2022  87F7
2023  87F7 78               ld a, b
2024  87F8 FE 18            cp 24     ;POSY - 24
2025  87FA 38 02            jr c, 1f
2026  87FC 3E 17            ld a, 23
2027  87FE 47           1:  ld b, a
2028  87FF
2029  87FF 7B               ld a, e
2030  8800 FE 21            cp 32+1   ;Width - 33
2031  8802 38 02            jr c, 1f
2032  8804 3E 20            ld a, 32
2033  8806 B7           1:  or a
2034  8807 20 01            jr nz, 2f
2035  8809 3C               inc a
2036  880A 5F           2:  ld e, a
2037  880B
2038  880B 7A               ld a, d
2039  880C FE 19            cp 24+1   ;Height - 25
2040  880E 38 02            jr c, 1f
2041  8810 3E 18            ld a, 24
2042  8812 B7           1:  or a
2043  8813 20 01            jr nz, 2f
2044  8815 3C               inc a
2045  8816 57           2:  ld d, a
2046  8817
2047  8817 7A               ld a, d
2048  8818 80               add a, b    ;PosY + Height
2049  8819 FE 19            cp 24+1
2050  881B 38 02            jr c, 1f
2051  881D 3E 18            ld a, 24
2052  881F 3D           1:  dec a
2053  8820 57               ld d, a
2054  8821
2055  8821 79               ld a, c
2056  8822 87               add a, a
2057  8823 87               add a, a
2058  8824 87               add a, a   ; PosX * 8
2059  8825 4F               ld c, a
2060  8826 7B               ld a, e
2061  8827 87               add a, a
2062  8828 87               add a, a
2063  8829 87               add a, a   ;Width * 8
2064  882A 30 04            jr nc, 1f  ;Width * 8 < 256
2065  882C 3E FF        2:  ld a, $FF
2066  882E 18 04            jr 3f
2067  8830 81           1:  add a, c   ;PosX + Width
2068  8831 38 F9            jr c, 2b   ; >= 256
2069  8833 3D               dec a
2070  8834 5F           3:  ld e, a
2071  8835 ED 43 B9 5F      ld (MIN_X), bc
2072  8839 ED 53 BB 5F      ld (MAX_X), de
2073  883D ED 43 B7 5F      ld (POS_X), bc
2074  8841
2075  8841 AF               xor a
2076  8842 32 BD 5F         ld (PRINTED_LINES), a
2077  8845 C9               ret
2078  8846
2079  8846
2080  8846              SET_CURSOR:
2081  8846 DD E5            push ix
2082  8848 DD 21 00 00      ld ix, 0
2083  884C DD 39            add ix, sp
2084  884E 21 00 00         ld hl, 0
2085  8851 E5               push hl
2086  8852 E5               push hl
2087  8853 3E 1F            ld a, 31
2088  8855 DD BE 05         cp (ix+5)
2089  8858 D2 5F 88         jp nc, .tmp17
2090  885B DD 36 05 1F      ld (ix+5), 31
2091  885F              .tmp17:
2092  885F 3E 17            ld a, 23
2093  8861 DD BE 07         cp (ix+7)
2094  8864 D2 6B 88         jp nc, .tmp19
2095  8867 DD 36 07 17      ld (ix+7), 23
2096  886B              .tmp19:
2097  886B DD 7E 05         ld a, (ix+5)
2098  886E 87               add a, a
2099  886F 87               add a, a
2100  8870 87               add a, a
2101  8871 DD 77 05         ld (ix+5), a
2102  8874 6F               ld l, a
2103  8875 E5               push hl
2104  8876 3A B9 5F         ld a, (MIN_X)
2105  8879 6F               ld l, a
2106  887A EB               ex de, hl
2107  887B E1               pop hl
2108  887C 19               add hl, de
2109  887D DD 75 FE         ld (ix-2), l
2110  8880 DD 74 FF         ld (ix-1), h
2111  8883 54               ld d, h
2112  8884 5D               ld e, l
2113  8885 3A BB 5F         ld a, (MAX_X)
2114  8888 6F               ld l, a
2115  8889 26 00            ld h, 0
2116  888B B7               or a
2117  888C ED 52            sbc hl, de
2118  888E D2 9D 88         jp nc, .tmp21
2119  8891 3A B9 5F         ld a, (MIN_X)
2120  8894 6F               ld l, a
2121  8895 26 00            ld h, 0
2122  8897 DD 75 FE         ld (ix-2), l
2123  889A DD 74 FF         ld (ix-1), h
2124  889D              .tmp21:
2125  889D DD 7E 07         ld a, (ix+7)
2126  88A0 6F               ld l, a
2127  88A1 26 00            ld h, 0
2128  88A3 E5               push hl
2129  88A4 3A BA 5F         ld a, (MIN_Y)
2130  88A7 6F               ld l, a
2131  88A8 EB               ex de, hl
2132  88A9 E1               pop hl
2133  88AA 19               add hl, de
2134  88AB DD 75 FC         ld (ix-4), l
2135  88AE DD 74 FD         ld (ix-3), h
2136  88B1 54               ld d, h
2137  88B2 5D               ld e, l
2138  88B3 3A BC 5F         ld a, (MAX_Y)
2139  88B6 6F               ld l, a
2140  88B7 26 00            ld h, 0
2141  88B9 B7               or a
2142  88BA ED 52            sbc hl, de
2143  88BC D2 CB 88         jp nc, .tmp23
2144  88BF 3A BA 5F         ld a, (MIN_Y)
2145  88C2 6F               ld l, a
2146  88C3 26 00            ld h, 0
2147  88C5 DD 75 FC         ld (ix-4), l
2148  88C8 DD 74 FD         ld (ix-3), h
2149  88CB              .tmp23:
2150  88CB DD 6E FE         ld l, (ix-2)
2151  88CE 7D               ld a, l
2152  88CF 32 B7 5F         ld (POS_X), a
2153  88D2 DD 6E FC         ld l, (ix-4)
2154  88D5 DD 66 FD         ld h, (ix-3)
2155  88D8 7D               ld a, l
2156  88D9 32 B8 5F         ld (POS_Y), a
2157  88DC DD F9            ld sp, ix
2158  88DE DD E1            pop ix
2159  88E0 D9               exx
2160  88E1 E1               pop hl
2161  88E2 C1               pop bc
2162  88E3 E3               ex (sp), hl
2163  88E4 D9               exx
2164  88E5 AF               xor a
2165  88E6 32 BD 5F         ld (PRINTED_LINES), a
2166  88E9 C9               ret
2167  88EA
2168  88EA
2169  88EA              ;------------------------------------------------------------------------
2170  88EA              GET_CHARACTER_POINTER:
2171  88EA              PROC
2172  88EA ED 5B 29 9F      ld de, (CHARSET_ADDR)
2173  88EE 6F               ld l, a
2174  88EF 26 00            ld h, 0
2175  88F1 29               add hl, hl     ; hl <= 2 * hl
2176  88F2 29               add hl, hl     ; hl <= 4 * hl
2177  88F3 29               add hl, hl     ; hl <= 8 * hl
2178  88F4 19               add hl, de     ; Pointer to character
2179  88F5 C9               ret
2180  88F6
2181  88F6              GET_CHARACTER_WIDTH:
2182  88F6 ED 4B 2B 9F      ld bc, (CHARSET_WIDTHS_ADDR)
2183  88FA 81               add a, c
2184  88FB 4F               ld c, a
2185  88FC 88               adc a, b
2186  88FD 91               sub c
2187  88FE 47               ld b, a       ; bc = bc + a
2188  88FF 0A               ld a, (bc)
2189  8900 C9               ret
2190  8901
2191  8901              ;TODO:
2192  8901              CRLF:
2193  8901 DD E5            push ix
2194  8903 DD 21 B7 5F      ld ix, POS_X
2195  8907 DD 7E 02         ld a, (ix+2)
2196  890A DD 77 00         ld (ix+0), a
2197  890D DD 34 01         inc (ix+1)
2198  8910              .CHECK_NEXT_LINE:
2199  8910 3A BF 5F         ld a, (WAIT_NEW_SCREEN)
2200  8913 B7               or a
2201  8914 28 33            jr z, 2f
2202  8916 DD 7E 05         ld a, (ix+5)
2203  8919 DD 96 03         sub (ix+3)
2204  891C 28 2B            jr z, 2f
2205  891E DD 34 06         inc (ix+6)
2206  8921 47               ld b, a
2207  8922 DD 7E 06         ld a, (ix+6)
2208  8925 B8               cp b
2209  8926 38 21            jr c, 2f        ;(printedLines >= (cwinH - 1))
2210  8928 DD 7E 05         ld a, (ix+5)
2211  892B DD BE 01         cp (ix+1)       ; MAXY-POSY
2212  892E 30 0C            jr nc, 3f
2213  8930 DD 7E 02         ld a, (ix+2)
2214  8933 DD 77 00         ld (ix+0), a
2215  8936 DD 35 01         dec (ix+1)
2216  8939 CD 37 8D         call SCROLL_WIN
2217  893C CD 53 8A     3:  call WAIT_NEXT_PAGE
2218  893F DD 36 06 00      ld (ix+6), 0
2219  8943 DD 7E 02         ld a, (ix+2)
2220  8946 DD 77 00         ld (ix+0), a
2221  8949 DD 7E 05     2:  ld a, (ix+5)
2222  894C DD BE 01         cp (ix+1)      ;MAXY-POSY
2223  894F 30 06            jr nc, 1f
2224  8951 DD 35 01         dec (ix+1)
2225  8954 CD 37 8D         call SCROLL_WIN
2226  8957 DD E1        1:  pop ix
2227  8959 C9               ret
2228  895A
2229  895A
2230  895A              ;    Entry param : A = Character width of character
2231  895A              ;    Output: H = Y for next char
2232  895A              ;            L = X for next char
2233  895A              ;            D = Y for printing this char
2234  895A              ;            E = X for printing this char
2235  895A              UPDATE_POS:
2236  895A 32 7A 89         ld (.s_mod),a ; Self modificable core, store character width on an instruction
2237  895D 2A B7 5F         ld hl, (POS_X) ; h = POS_Y, l = POS_X
2238  8960 54               ld d, h        ; Save old position in DE
2239  8961 5D               ld e, l        ; d = POS_Y, e = POS_X
2240  8962 85               add a, l       ; X = X + Char Width
2241  8963 38 07            jr c, .new_l    ; detect screen overflow
2242  8965 6F               ld l, a        ; Set L = X + Char Width
2243  8966 3A BB 5F         ld a, (MAX_X)  ; Set A = MAX_X
2244  8969 BD               cp l           ; MAX_X-X
2245  896A 30 11            jr nc, .upd_pos ; MAX_X >= X
2246  896C              .new_l:
2247  896C 3E 01            ld a, 1
2248  896E 32 C0 5F         ld (SKIP_SPACES), a ;NEWLINE DONE
2249  8971 CD 01 89         call CRLF
2250  8974 2A B7 5F         ld hl, (POS_X)
2251  8977 54               ld d, h        ; Save new position in DE
2252  8978 5D               ld e, l
2253  8979              .s_mod+1:          ; If we jump to next line, the next pos_x must be updated
2254  8979 3E 00            ld a, 0-0      ; The parameter is self_modified here
2255  897B 85               add a, l       ; add the width of the character to the next position
2256  897C 6F               ld l, a        ; Update POS_X
2257  897D ~            /*
2258  897D ~                ld bc, (MIN_X) ; b = MIN_Y, c = MIN_X
2259  897D ~                ld l, c        ; Set X = MIN_X
2260  897D ~                inc h          ; Increment Y
2261  897D ~                ld a, (MAX_Y)  ; Set A = MAX_Y
2262  897D ~                cp h           ; MAX_Y-Y
2263  897D ~                jr nc, .upd_pos2; MAX_Y >= Y
2264  897D ~                ;cleaning the screen...
2265  897D ~                call CLEAR_WIN
2266  897D ~                ld hl, (POS_X)
2267  897D ~                jr .upd_pos3
2268  897D ~            .upd_pos2:
2269  897D ~                jr nz, .upd_pos3
2270  897D ~                ld a, (WAIT_NEW_SCREEN)
2271  897D ~                or a
2272  897D ~                jr z, .upd_pos3
2273  897D ~                call WAIT_NEXT_PAGE
2274  897D ~                ld hl, (POS_X)
2275  897D ~            .upd_pos3:
2276  897D ~                ld d, h        ; Save new position in DE
2277  897D ~                ld e, l
2278  897D ~            .s_mod+1:          ; If we jump to next line, the next pos_x must be updated
2279  897D ~                ld a, 0-0      ; The parameter is self_modified here
2280  897D ~                add a, l       ; add the width of the character to the next position
2281  897D ~                ld l, a        ; Update POS_X
2282  897D ~                ; POS_X should never be zero in this case
2283  897D ~            */
2284  897D              .upd_pos:
2285  897D 22 B7 5F         ld (POS_X), hl ; Update next position
2286  8980 C9               ret
2287  8981
2288  8981              ; Test if using alternate charset
2289  8981              PUT_VAR_CHAR_WITH_CHARSET_OFFSET:
2290  8981 4F               ld c, a
2291  8982 3A B6 5F         ld a, (CHARSET_OFFSET)
2292  8985 81               add a, c
2293  8986
2294  8986              PUT_VAR_CHAR:
2295  8986 CD EA 88         call GET_CHARACTER_POINTER
2296  8989 E5               push hl        ; Store address to character
2297  898A
2298  898A CD F6 88         call GET_CHARACTER_WIDTH
2299  898D F5               push af        ; Store character width
2300  898E
2301  898E FE 08            cp 8
2302  8990 38 12            jr c, .t5      ;Width < 8
2303  8992 20 0B            jr nz, .t6     ;width > 8
2304  8994 F1               pop af
2305  8995 CD 25 8C         call ADJUST_CHAR_POS
2306  8998 E1               pop hl
2307  8999 CD 51 8C         call PUT_8X8_CHAR
2308  899C C3 33 8A         jp .t7         ;Jump to make typematic pause
2309  899F              .t6:
2310  899F 3E 04            ld a, 4         ;Character too big
2311  89A1 C3 00 9F         jp SYS_ERROR
2312  89A4
2313  89A4              .t5:
2314  89A4 CD 5A 89         call UPDATE_POS
2315  89A7                  ; d = POS_Y, e = POS_X
2316  89A7
2317  89A7 7B               ld a, e        ; Grab our pixel number
2318  89A8 E6 07            and 7          ; And do mod 8 [So now we have how many pixels into the character square we're starting at]
2319  89AA F5               push af        ; Save A (pixels into character square)
2320  89AB D9               exx
2321  89AC 57               ld d, a        ; d' -> pixels into character square
2322  89AD 21 3C 8A         ld hl, .MASK
2323  89B0 85               add a, l
2324  89B1 6F               ld l, a
2325  89B2 8C               adc a, h
2326  89B3 95               sub l
2327  89B4 67               ld h, a        ; hl = hl + a
2328  89B5 7E               ld a, (hl)
2329  89B6 47               ld b, a
2330  89B7 2F               cpl            ; Complementing mask bits
2331  89B8 4F               ld c, a        ; b' -> mask, c' -> complemented mask
2332  89B9 7A               ld a, d        ; restore A on D
2333  89BA B7               or a           ; Set Z flag if is zero
2334  89BB 08               ex af, af'     ; Saving in AF' the displacement
2335  89BC D9               exx
2336  89BD
2337  89BD                  ;Condiciones para NO dibujar el siguiente caracter
2338  89BD                  ;- Su posiciÃ³n dentro del + ancho del caracter es menor que 8
2339  89BD                  ;- si no, si el siguiente carÃ¡cter es X > 255
2340  89BD                  ;- si no, si el siguiente carÃ¡cter es X > MAX_W
2341  89BD
2342  89BD F1               pop af         ; Restore pos_x in char on A
2343  89BE C1               pop bc         ; restore char size on B
2344  89BF 80               add a, b       ; pos_x_in_char + size
2345  89C0 FE 08            cp 8           ; It more than 7? ((a - 8) = (A >= 8))
2346  89C2 17               rla            ; Carry to A ( C = A < 8)
2347  89C3 E6 01            and 1          ; Discard 7 MSB bits
2348  89C5 4F               ld c, a        ; Saving condition in C
2349  89C6 78               ld a, b        ; Char size on A
2350  89C7 83               add a, e       ; Add charsize + posX
2351  89C8 CB 11            rl c           ; If C it most than the screen, add condition doing RL on C
2352  89CA 47               ld b, a        ; Storing charsize + posX on b
2353  89CB 3A BB 5F         ld a, (MAX_X)  ; Storing MAX_X on A
2354  89CE B8               cp b           ; MAX_X-X -> NC = MAX_X >= x
2355  89CF CB 11            rl c           ; Add the condition on C
2356  89D1 79               ld a, c        ; COndition on A again
2357  89D2                  ; bit 2 enabled if pos_x_in_char + size >= 8
2358  89D2                  ; bit 1 enabled if pos_x + size > 255
2359  89D2                  ; bit 0 enabled if pos_x + size > MAX_X
2360  89D2 32 F9 89         ld (.s_mod2), a
2361  89D5 32 27 8A         ld (.s_mod3), a
2362  89D8                  ; This should be unnecesary with a variable instead of
2363  89D8                  ; self-modified code, but this way is a bit faster because
2364  89D8                  ; read of the variable is done 16 times.
2365  89D8
2366  89D8 7B               ld a, e        ; Get x pos
2367  89D9 6F               ld l, a        ; put x into L
2368  89DA CB 3F            srl a          ; divide by 2
2369  89DC CB 3F            srl a          ; divide by another 2 (/4)
2370  89DE CB 3F            srl a          ; divide by another 2 (/8)
2371  89E0 5F               ld e, a        ; Put the result in e (Since the screen has 8 pixel bytes, pixel/8 = which char pos along our first pixel is in)
2372  89E1
2373  89E1 7A               ld a, d        ; Get y pos into A'
2374  89E2 CB 2F            sra a          ; Divide by 2
2375  89E4 CB 2F            sra a          ; Divide by another 2 (/4 total)
2376  89E6 CB 2F            sra a          ; Divide by another 2 (/8) [Gives us a 1/3 of screen number]
2377  89E8 C6 58            add a, 88      ; Add in start of screen attributes high byte
2378  89EA 67               ld h, a        ; And put the result in H
2379  89EB 7A               ld a, d        ; grab our Y co-ord again
2380  89EC E6 07            and 7          ; Mod 8 (why? *I thought to give a line in this 1/3 of screen, but we're in attrs here)
2381  89EE 0F               rrca           ;
2382  89EF 0F               rrca
2383  89F0 0F               rrca           ; Bring the bottom 3 bits to the top - Multiply by 32
2384  89F1                    ; (since there are 32 bytes across the screen), here, in other words. [Faster than 5 SLA instructions]
2385  89F1 83               add a, e       ; add in our x coordinate byte to give us a low screen byte
2386  89F2 6F               ld l, a        ; Put the result in L. So now HL -> screen byte at the top of the character
2387  89F3
2388  89F3 3A 8D 5C         ld a, (ATTR_P)   ; ATTR P     Permanent current colours, etc (as set up by colour statements).
2389  89F6 5F               ld e, a          ; Copy ATTR into e
2390  89F7 73               ld (hl), e       ; Drop ATTR value into screen
2391  89F8
2392  89F8
2393  89F8              .s_mod2+1:
2394  89F8 3E 00            ld a, 0-0        ; self_modified
2395  89FA B7               or a             ; test if value is zero
2396  89FB 20 03            jr nz, .t1        ; if not zero, do not process next character
2397  89FD 23               inc hl           ; Go to next position along
2398  89FE 73               ld (hl), e       ; 63446 Must be yes - we're setting the attributes in the next square too.
2399  89FF 2B               dec hl           ; Back up to last position
2400  8A00
2401  8A00              .t1:
2402  8A00 7A               ld a, d          ; Y Coord into A'
2403  8A01 E6 F8            and 248          ; Turn it into 0,8 or 16. (y=0-23)
2404  8A03 C6 40            add a, 64        ; Turn it into 64,72,80  [40,48,50 Hex] for high byte of screen pos
2405  8A05 67               ld h, a          ; Stick it in H (we have screen coords now)
2406  8A06 E5               push hl          ; Save it
2407  8A07 D9               exx              ; Swap registers
2408  8A08 E1               pop hl           ; Put it into HL' the screen pointer, b -> mask, c -> pixels into character square
2409  8A09 D9               exx              ; Swap Back
2410  8A0A
2411  8A0A E1               pop hl           ; Restore pointer to char
2412  8A0B 08               ex af, af'       ; Recover displacement to the right
2413  8A0C C2 11 8A         jp nz, .t2        ; test if is zero
2414  8A0F 3E 08            ld a, 8          ; In that case, set to 8
2415  8A11              .t2:
2416  8A11 57               ld d, a          ; D = num of pixel rotations to do
2417  8A12
2418  8A12 06 08            ld b, 8
2419  8A14
2420  8A14              .loop1:
2421  8A14 7E               ld a, (hl)       ; get char line pxl
2422  8A15 23               inc hl           ; next char line
2423  8A16 48               ld c, b          ; Save line counter on c
2424  8A17 42               ld b, d          ; Set on b the displacement to the right
2425  8A18
2426  8A18              .loop2:
2427  8A18 0F               rrca             ; Rotate a
2428  8A19 10 FD            djnz .loop2
2429  8A1B
2430  8A1B D9               exx
2431  8A1C                  ;HL' the screen pointer, b' -> mask, c' -> mask complemented
2432  8A1C 57               ld d, a
2433  8A1D A1               and c
2434  8A1E 5F               ld e, a         ; Get the left part of the rotated character
2435  8A1F 78               ld a, b
2436  8A20 A2               and d
2437  8A21 57               ld d, a         ; Get the right part of the rotated character
2438  8A22              ;HL' -> the screen pointer, b' -> mask, c' -> mask complemented
2439  8A22              ;d' -> left char line data, e' -> right char line data
2440  8A22 79               ld a, c         ; Get inverted mask
2441  8A23 A6               and (hl)        ; Mask screen
2442  8A24 B2               or d            ; or with char
2443  8A25 77               ld (hl), a      ; To screen again
2444  8A26
2445  8A26              .s_mod3+1:
2446  8A26 3E 00            ld a, 0-0       ; Self-modified to check if next char must be written
2447  8A28 B7               or a            ; Check if right mask is zero
2448  8A29 20 03            jr nz, .t3       ; Next char doesn't need update
2449  8A2B 2C               inc l           ; next char
2450  8A2C 73               ld (hl), e      ; To screen
2451  8A2D 2D               dec l           ; Return to previous char
2452  8A2E              .t3:
2453  8A2E 24               inc h           ; next char line
2454  8A2F D9               exx
2455  8A30 41               ld b, c         ; Restore on b the line counter
2456  8A31 10 E1            djnz .loop1
2457  8A33
2458  8A33                  ; Typing pause
2459  8A33              .t7:
2460  8A33 2A B3 5F         ld hl, (PRT_INTERVAL)
2461  8A36              .t4:
2462  8A36 7C               ld a, h
2463  8A37 B5               or l
2464  8A38 C8               ret z
2465  8A39 2B               dec hl
2466  8A3A 18 FA            jr .t4
2467  8A3C
2468  8A3C              .MASK:
2469  8A3C FF               DEFB %11111111  ;CPL =>  %00000000
2470  8A3D 7F               DEFB %01111111  ;CPL =>  %10000000
2471  8A3E 3F               DEFB %00111111  ;CPL =>  %11000000
2472  8A3F 1F               DEFB %00011111  ;CPL =>  %11100000
2473  8A40 0F               DEFB %00001111  ;CPL =>  %11110000
2474  8A41 07               DEFB %00000111  ;CPL =>  %11111000
2475  8A42 03               DEFB %00000011  ;CPL =>  %11111100
2476  8A43 01               DEFB %00000001  ;CPL =>  %11111110
2477  8A44
2478  8A44
2479  8A44              CENTER:
2480  8A44 3A B9 5F         ld a, (MIN_X)
2481  8A47 4F               ld c, a
2482  8A48 3A BB 5F         ld a, (MAX_X)
2483  8A4B 91               sub c
2484  8A4C CB 3F            srl a
2485  8A4E 81               add a, c
2486  8A4F 32 B7 5F         ld (POS_X), a
2487  8A52 C9               ret
2488  8A53
2489  8A53              WAIT_NEXT_PAGE:
2490  8A53 CD 44 8A         call CENTER
2491  8A56 ED 5B B7 5F      ld de, (POS_X)
2492  8A5A                  ;inc d
2493  8A5A              .loop:
2494  8A5A CD 9B 83         call INKEY
2495  8A5D FE 0D            cp 13
2496  8A5F 28 1A            jr z, .keyp
2497  8A61 FE 20            cp ' '
2498  8A63 28 16            jr z, .keyp
2499  8A65 FE 6D            cp 'm'
2500  8A67 28 12            jr z, .keyp
2501  8A69
2502  8A69 3A AB 5F         ld a, (CYCLE_OPTION)
2503  8A6C D5               push de
2504  8A6D D5               push de
2505  8A6E C6 88            add a, WAIT_TO_KEY_BULLET
2506  8A70 CD EA 88         call GET_CHARACTER_POINTER
2507  8A73 D1               pop de
2508  8A74 76               halt
2509  8A75 CD 51 8C         call PUT_8X8_CHAR
2510  8A78 D1               pop de
2511  8A79 18 DF            jr .loop
2512  8A7B              .keyp:
2513  8A7B CD 9B 83         call INKEY
2514  8A7E B7               or a
2515  8A7F 20 FA            jr nz, .keyp
2516  8A81 CD 8B 8D         call CLEAR_LINE
2517  8A84 3A B9 5F         ld a, (MIN_X)
2518  8A87 32 B7 5F         ld (POS_X), a
2519  8A8A C9               ret
2520  8A8B
2521  8A8B
2522  8A8B              PRINT_SELECTED_OPTION_BULLET:
2523  8A8B F5               push af
2524  8A8C 3A AA 5F         ld a, (OPTION_BULLET_ENABLED)
2525  8A8F B7               or a
2526  8A90 20 02            jr nz, 1f
2527  8A92 F1               pop af
2528  8A93 C9               ret
2529  8A94 ED 4B B7 5F  1:  ld bc, (POS_X)
2530  8A98 3A A5 5F         ld a, (SELECTED_OPTION)
2531  8A9B CB 27            sla a
2532  8A9D CB 27            sla a
2533  8A9F CB 27            sla a
2534  8AA1 26 5E            ld h, HIGH OPTIONS_TABLE
2535  8AA3 6F               ld l, a
2536  8AA4 5E               ld e, (hl)
2537  8AA5 23               inc hl
2538  8AA6 56               ld d, (hl)
2539  8AA7 ED 53 B7 5F      ld (POS_X), de
2540  8AAB F1               pop af
2541  8AAC D5               push de
2542  8AAD CD EA 88         call GET_CHARACTER_POINTER
2543  8AB0 D1               pop de
2544  8AB1 CD 51 8C         call PUT_8X8_CHAR
2545  8AB4 ED 43 B7 5F      ld (POS_X), bc
2546  8AB8 C9               ret
2547  8AB9
2548  8AB9              ANIMATE_OPTION_BULLET:
2549  8AB9 3A AB 5F         ld a, (CYCLE_OPTION)
2550  8ABC C6 80            add a, SELECTED_BULLET
2551  8ABE 76               halt
2552  8ABF CD 8B 8A         call PRINT_SELECTED_OPTION_BULLET
2553  8AC2 C9               ret
2554  8AC3
2555  8AC3              ; HL <- Pointer to the null ended string
2556  8AC3              PRINT_STR:
2557  8AC3 7D               ld a, l
2558  8AC4 B4               or h
2559  8AC5 C8               ret z          ; Exit if null pointer
2560  8AC6
2561  8AC6              .loop1:
2562  8AC6 7E               ld a, (hl)
2563  8AC7 B7               or a
2564  8AC8 C8               ret z         ; Exit if null character found
2565  8AC9 FE 0D            cp 13         ; EOL
2566  8ACB 28 79            jr z, .eol
2567  8ACD FE 0A            cp 10         ; CR
2568  8ACF 28 75            jr z, .eol
2569  8AD1 FE 20            cp 32         ; Space
2570  8AD3 28 50            jr z, .space
2571  8AD5
2572  8AD5                  ; search for end of current word
2573  8AD5 54               ld d, h
2574  8AD6 5D               ld e, l       ; Store current pointer on D
2575  8AD7 0E 00            ld c, 0       ; size count
2576  8AD9              .loop2:
2577  8AD9 1A               ld a, (de)    ; get next character
2578  8ADA B7               or a
2579  8ADB 28 1C            jr z, .end_loop2
2580  8ADD FE 0D            cp 13
2581  8ADF 28 18            jr z, .end_loop2
2582  8AE1 FE 0A            cp 10
2583  8AE3 28 14            jr z, .end_loop2
2584  8AE5 FE 20            cp 32
2585  8AE7 28 10            jr z, .end_loop2
2586  8AE9 C5               push bc
2587  8AEA 4F               ld c, a
2588  8AEB 3A B6 5F         ld a, (CHARSET_OFFSET)
2589  8AEE 81               add a, c
2590  8AEF CD F6 88         call GET_CHARACTER_WIDTH
2591  8AF2 C1               pop bc
2592  8AF3 81               add a, c
2593  8AF4 4F               ld c, a
2594  8AF5 13               inc de        ; Increment counter
2595  8AF6 C3 D9 8A         jp .loop2
2596  8AF9              .end_loop2:
2597  8AF9 3A B7 5F         ld a, (POS_X)
2598  8AFC 47               ld b, a
2599  8AFD 3A BB 5F         ld a, (MAX_X)
2600  8B00 90               sub b           ; MAX_X - POS_X
2601  8B01 B9               cp c            ; Width - word size
2602  8B02 E5               push hl
2603  8B03 D5               push de
2604  8B04 DC 01 89         call c, CRLF    ; If the word doesn't fit, do a carriage return
2605  8B07 D1               pop de
2606  8B08 E1               pop hl
2607  8B09
2608  8B09                  ;Print rest of the word
2609  8B09              .loop3:
2610  8B09 7E               ld a, (hl)
2611  8B0A B7               or a
2612  8B0B C8               ret z         ; Exit if null character found
2613  8B0C FE 0A            cp 10         ; CR
2614  8B0E 28 36            jr z, .eol
2615  8B10 FE 0D            cp 13         ; EOL
2616  8B12 28 32            jr z, .eol
2617  8B14 FE 20            cp 32         ; Space
2618  8B16 28 0D            jr z, .space
2619  8B18 E5               push hl
2620  8B19 CD 81 89         call PUT_VAR_CHAR_WITH_CHARSET_OFFSET
2621  8B1C AF               xor a
2622  8B1D 32 C0 5F         ld (SKIP_SPACES), a      ; Disable space skip after a non-space character
2623  8B20 E1               pop hl
2624  8B21 23               inc hl
2625  8B22 C3 09 8B         jp .loop3
2626  8B25
2627  8B25              .space:
2628  8B25 3A C0 5F         ld a, (SKIP_SPACES)
2629  8B28 B7               or a
2630  8B29 20 17            jr nz, .skip_space   ; Space is not printed in this case
2631  8B2B D5               push de              ; Reserve space only
2632  8B2C C5               push bc
2633  8B2D E5               push hl
2634  8B2E 3E 20            ld a, 32
2635  8B30 CD 81 89         call PUT_VAR_CHAR_WITH_CHARSET_OFFSET
2636  8B33 3A C0 5F         ld a, (SKIP_SPACES)  ;Skip space after auto-carriage return
2637  8B36 B7               or a
2638  8B37 28 06            jr z, .no_backstep ; Space is not printed in this case
2639  8B39 3A B9 5F         ld a, (MIN_X)
2640  8B3C 32 B7 5F         ld (POS_X), a
2641  8B3F              .no_backstep:
2642  8B3F E1               pop hl
2643  8B40 C1               pop bc
2644  8B41 D1               pop de
2645  8B42              .skip_space:
2646  8B42 23               inc hl
2647  8B43 C3 C6 8A         jp .loop1
2648  8B46
2649  8B46              .eol:
2650  8B46 D5               push de                   ; Reserve space only
2651  8B47 C5               push bc
2652  8B48 E5               push hl
2653  8B49 CD 01 89         call CRLF
2654  8B4C AF               xor a                    ; Disable space skip after a EOL
2655  8B4D 32 C0 5F         ld (SKIP_SPACES), a
2656  8B50 E1               pop hl
2657  8B51 C1               pop bc
2658  8B52 D1               pop de
2659  8B53 23               inc hl
2660  8B54 C3 C6 8A         jp .loop1
2661  8B57
2662  8B57
2663  8B57              PRINT_TOKEN_STR:
2664  8B57 AF               xor a
2665  8B58 11 04 5F         ld de, TEXT_BUFFER
2666  8B5B 12               ld (de), a
2667  8B5C              .loop3:
2668  8B5C 4E               ld c, (hl)
2669  8B5D 23               inc hl
2670  8B5E 3E FF            ld a, 255
2671  8B60 91               sub c
2672  8B61 4F               ld c, a                   ; Decrypting character
2673  8B62 E6 80            and $80                   ; Test if is token
2674  8B64 28 45            jr z, .not_token          ; if c >= 128, it is a token
2675  8B66
2676  8B66 3E 7F            ld a, $7F                ; Mask for token
2677  8B68 A1               and c                    ; Recovering character
2678  8B69 E5               push hl
2679  8B6A D5               push de
2680  8B6B              ;----------------------------------------------------------
2681  8B6B                  ; Get token
2682  8B6B ED 5B 27 9F      ld de, (TOKENS_ADDR)
2683  8B6F B7               or a
2684  8B70 28 09            jr z, .token_found
2685  8B72 47               ld b, a                   ; B as counter
2686  8B73              .loop1:
2687  8B73 1A               ld a, (de)
2688  8B74 13               inc de
2689  8B75 FE 80            cp 128
2690  8B77 38 FA            jr c, .loop1               ; A < 128 don't decrement b
2691  8B79 10 F8            djnz .loop1                ; Decrease B IF A > 127
2692  8B7B              .token_found:
2693  8B7B 21 84 5F         ld hl, TOKEN_BUFFER        ;HL = ptr to token buffer
2694  8B7E E5               push hl
2695  8B7F              .loop2:
2696  8B7F 1A               ld a, (de)
2697  8B80 4F               ld c, a                   ; C character
2698  8B81 E6 7F            and $7F
2699  8B83 77               ld (hl), a
2700  8B84 13               inc de
2701  8B85 23               inc hl
2702  8B86 79               ld a, c                  ;Loop if c < 127
2703  8B87 FE 7F            cp 127
2704  8B89 38 F4            jr c, .loop2
2705  8B8B 36 00            ld (hl), 0               ;Null at the end...
2706  8B8D              ;----------------------------------------------------------
2707  8B8D E1               pop hl                   ;Restore start token buffer
2708  8B8E D1               pop de                   ;restore text buffer
2709  8B8F                  ; hl has the token buffer;
2710  8B8F                  ; de has the text buffer
2711  8B8F              .loop4:
2712  8B8F 7E               ld a, (hl)
2713  8B90 23               inc hl
2714  8B91 B7               or a
2715  8B92 28 13            jr z, .end_loop4
2716  8B94 12               ld (de), a
2717  8B95 13               inc de
2718  8B96 FE 20            cp 32
2719  8B98 28 08            jr z, .end_token
2720  8B9A FE 0A            cp 10
2721  8B9C 28 04            jr z, .end_token
2722  8B9E FE 0D            cp 13
2723  8BA0 20 ED            jr nz, .loop4
2724  8BA2              .end_token:                  ; Print current text buffer
2725  8BA2 CD C3 8B         call PRINT_STR_BUFFER
2726  8BA5 18 E8            jr .loop4
2727  8BA7              .end_loop4:
2728  8BA7 E1               pop hl                  ; Restoring string pointer on HL
2729  8BA8 C3 5C 8B         jp .loop3                ; Next iteration
2730  8BAB              ;-------------------------
2731  8BAB              .not_token:
2732  8BAB 79               ld a, c
2733  8BAC 12               ld (de), a
2734  8BAD 13               inc de
2735  8BAE FE 20            cp 32
2736  8BB0 28 05            jr z, .end_word
2737  8BB2 FE 0A            cp 10
2738  8BB4 20 06            jr nz, .end_str
2739  8BB6 1B               dec de
2740  8BB7              .end_word:
2741  8BB7 C5               push bc
2742  8BB8 CD C3 8B         call PRINT_STR_BUFFER
2743  8BBB C1               pop bc
2744  8BBC              .end_str:
2745  8BBC 3E 0A            ld a, $0A               ; = 255 - 0xf5
2746  8BBE B9               cp c
2747  8BBF C8               ret z
2748  8BC0 C3 5C 8B         jp .loop3            ; char <> (255 - 0xf5)
2749  8BC3              PRINT_STR_BUFFER:
2750  8BC3 AF               xor a                   ; A = 0
2751  8BC4 12               ld (de), a              ; Set the final mark on text buffer
2752  8BC5 11 04 5F         ld de, TEXT_BUFFER
2753  8BC8 EB               ex de, hl               ; Put the thex buffer on hl
2754  8BC9 E5               push hl
2755  8BCA D5               push de
2756  8BCB CD C3 8A         call PRINT_STR
2757  8BCE E1               pop hl                  ; Restore register on its original positions
2758  8BCF D1               pop de
2759  8BD0 C9               ret
2760  8BD1
2761  8BD1              ; Get the number in A as text in DE
2762  8BD1              ; With C set, print leading zeroes
2763  8BD1              PRINT_A_BYTE:
2764  8BD1 26 00            ld h, 0
2765  8BD3 6F               ld l, a
2766  8BD4
2767  8BD4              ; Get the number in HL as text in DE
2768  8BD4              ; With C set, print leading zeroes
2769  8BD4              PRINT_HL_WORD:
2770  8BD4 08               ex af, af'                ;Save carry
2771  8BD5 11 04 5F         ld de, TEXT_BUFFER
2772  8BD8 D5               push de                   ;Save start of text buffer address on stack
2773  8BD9 CD F1 8B         call CONV_HL_TO_STR
2774  8BDC AF               xor a
2775  8BDD 12               ld (de), a                ; Set NULL at the end of the string
2776  8BDE E1               pop hl                    ; Restore start buffer on HL
2777  8BDF 08               ex af, af'                ; Restore carry
2778  8BE0 DA C3 8A         jp c, PRINT_STR           ; On carry, leave any leading zeroes.
2779  8BE3 06 04            ld b, 4                   ; Max number of digits to skip
2780  8BE5 3E 30            ld a, $30                 ; is Zero char
2781  8BE7              .loop1:
2782  8BE7 BE               cp (hl)
2783  8BE8 C2 C3 8A         jp nz, PRINT_STR          ; If not, we have ended
2784  8BEB 23               inc hl                    ; Advance pointer
2785  8BEC 10 F9            djnz .loop1               ; Iterate over all digits
2786  8BEE              .end_loop1:
2787  8BEE C3 C3 8A         jp PRINT_STR              ; Print number
2788  8BF1
2789  8BF1
2790  8BF1              CONV_HL_TO_STR:
2791  8BF1 01 F0 D8         ld bc, -10000
2792  8BF4 CD 0B 8C         call .one
2793  8BF7 01 18 FC         ld bc, -1000
2794  8BFA CD 0B 8C         call .one
2795  8BFD 01 9C FF         ld bc, -100
2796  8C00 CD 0B 8C         call .one
2797  8C03 01 F6 FF         ld bc, -10
2798  8C06 CD 0B 8C         call .one
2799  8C09 0E FF            ld c, -1
2800  8C0B              .one
2801  8C0B 3E 2F            ld a, $30-1    ;"0"-1
2802  8C0D              .two
2803  8C0D 3C               inc a
2804  8C0E 09               add hl, bc
2805  8C0F 38 FC            jr c, .two
2806  8C11 C5               push bc
2807  8C12 F5               push af
2808  8C13 78               ld a, b
2809  8C14 2F               cpl
2810  8C15 47               ld b, a
2811  8C16 79               ld a, c
2812  8C17 2F               cpl
2813  8C18 4F               ld c, a
2814  8C19 03               inc bc
2815  8C1A DC 23 8C         call c, .carry
2816  8C1D F1               pop af
2817  8C1E 09               add hl, bc
2818  8C1F C1               pop bc
2819  8C20 12               ld (de), a
2820  8C21 13               inc de
2821  8C22 C9               ret
2822  8C23              .carry:
2823  8C23 0B               dec bc
2824  8C24 C9               ret
2825  8C25
2826  8C25              ADJUST_CHAR_POS:
2827  8C25 3A B7 5F         ld a, (POS_X)
2828  8C28 E6 07            and 7
2829  8C2A 28 07            jr z, 1f
2830  8C2C 4F               ld c, a
2831  8C2D 3E 08            ld a, 8
2832  8C2F 91               sub c
2833  8C30 CD 5A 89         call UPDATE_POS       ;Advance to match 8x8 character
2834  8C33 3A B7 5F     1:  ld a, (POS_X)
2835  8C36 FE F8            cp $f8
2836  8C38 28 05            jr z, 2f
2837  8C3A 3E 08            ld a, 8
2838  8C3C C3 5A 89         jp UPDATE_POS
2839  8C3F                  ; d = POS_Y, e = POS_X
2840  8C3F AF           2:  xor a
2841  8C40 C3 5A 89         jp UPDATE_POS
2842  8C43
2843  8C43
2844  8C43              ADJUST_CHAR_POS_NO_ADVANCE:
2845  8C43 2A B7 5F         ld hl, (POS_X)
2846  8C46 3E 07            ld a, 7
2847  8C48 A5               and l
2848  8C49 C8               ret z              ;Already on 8x8 grid, do nothing
2849  8C4A 4F               ld c, a
2850  8C4B 3E 08            ld a, 8
2851  8C4D 91               sub c
2852  8C4E C3 5A 89         jp UPDATE_POS       ;Advance to match 8x8 character
2853  8C51                  ; h = POS_Y, l = POS_X
2854  8C51
2855  8C51              ; hl character input
2856  8C51              ; d = POS_Y, e = POS_X
2857  8C51              PUT_8X8_CHAR:
2858  8C51 E5               push hl
2859  8C52 CB 3B            srl e
2860  8C54 CB 3B            srl e
2861  8C56 CB 3B            srl e
2862  8C58 7A               ld a, d
2863  8C59 0F               rrca
2864  8C5A 0F               rrca
2865  8C5B 0F               rrca
2866  8C5C E6 03            and 3
2867  8C5E C6 58            add a, $58
2868  8C60 67               ld h, a
2869  8C61 7A               ld a, d
2870  8C62 E6 07            and 7
2871  8C64 0F               rrca
2872  8C65 0F               rrca
2873  8C66 0F               rrca
2874  8C67 83               add a, e
2875  8C68 6F               ld l, a
2876  8C69 3A 8D 5C         ld a, (ATTR_P)
2877  8C6C 77               ld (hl), a
2878  8C6D 7A               ld a, d
2879  8C6E E6 18            and $18
2880  8C70 C6 40            add a, $40
2881  8C72 67               ld h, a
2882  8C73 7A               ld a, d
2883  8C74 E6 07            and 7
2884  8C76 0F               rrca
2885  8C77 0F               rrca
2886  8C78 0F               rrca
2887  8C79 83               add a, e
2888  8C7A 6F               ld l, a
2889  8C7B D1               pop de
2890  8C7C                  REPT 8
2891  8C7C 1A          >    ld a, (de)
2892  8C7D 13          >    inc de
2893  8C7E 77          >    ld (hl), a
2894  8C7F 24          >    inc h
2891  8C80 1A          >    ld a, (de)
2892  8C81 13          >    inc de
2893  8C82 77          >    ld (hl), a
2894  8C83 24          >    inc h
2891  8C84 1A          >    ld a, (de)
2892  8C85 13          >    inc de
2893  8C86 77          >    ld (hl), a
2894  8C87 24          >    inc h
2891  8C88 1A          >    ld a, (de)
2892  8C89 13          >    inc de
2893  8C8A 77          >    ld (hl), a
2894  8C8B 24          >    inc h
2891  8C8C 1A          >    ld a, (de)
2892  8C8D 13          >    inc de
2893  8C8E 77          >    ld (hl), a
2894  8C8F 24          >    inc h
2891  8C90 1A          >    ld a, (de)
2892  8C91 13          >    inc de
2893  8C92 77          >    ld (hl), a
2894  8C93 24          >    inc h
2891  8C94 1A          >    ld a, (de)
2892  8C95 13          >    inc de
2893  8C96 77          >    ld (hl), a
2894  8C97 24          >    inc h
2891  8C98 1A          >    ld a, (de)
2892  8C99 13          >    inc de
2893  8C9A 77          >    ld (hl), a
2894  8C9B 24          >    inc h
2895  8C9C                  ENDR
2896  8C9C C9               ret
2897  8C9D              ;-----------------------------------------------------
2898  8C9D
2899  8C9D              BACKSPACE:
2900  8C9D 3A C7 5F         ld a, (WIDTH_BACKSPACE)
2901  8CA0 6F               ld l, a
2902  8CA1 ED 5B B7 5F      ld de, (POS_X)
2903  8CA5 ED 4B B9 5F      ld bc, (MIN_X)            ; Loads positions
2904  8CA9 7B               ld a, e                   ; Gets POS_X on A
2905  8CAA 95           1:  sub l                     ; Backtrack a position
2906  8CAB 38 03            jr c, 2f                  ; If POS_X < 0
2907  8CAD B9               cp c                      ; Compare with MIN_X
2908  8CAE 30 15            jr nc, .noLeftBorder      ; Test left border
2909  8CB0 7A           2:  ld a, d                   ; Gets POS_Y on A
2910  8CB1 B7               or a                      ; Is Zero ?
2911  8CB2 28 12            jr z, .noBacktrack        ; if it is zero, then do nothing
2912  8CB4 3D               dec a                     ; Decrement position
2913  8CB5 B8               cp b                      ; Compare with MIN_Y
2914  8CB6 38 0E            jr c, .noBacktrack        ; IF Y < MIN_Y, do nothing
2915  8CB8 57               ld d, a                   ; Store the new position Y
2916  8CB9 3A BD 5F         ld a, (PRINTED_LINES)
2917  8CBC 3D               dec a
2918  8CBD 32 BD 5F         ld (PRINTED_LINES), a
2919  8CC0 3A C6 5F         ld a, (MAX_X_BACKSPACE)   ; Sets X to the right side (MAX_X)
2920  8CC3 18 E5            jr 1b                     ; substract again
2921  8CC5              .noLeftBorder:
2922  8CC5 5F               ld e, a                   ; Store the new position X
2923  8CC6              .noBacktrack:
2924  8CC6 ED 53 B7 5F      ld (POS_X), de            ; Update new screen position
2925  8CCA D5               push de
2926  8CCB 3E 20            ld a, $20                 ; Clear the new position
2927  8CCD CD 81 89         call PUT_VAR_CHAR_WITH_CHARSET_OFFSET
2928  8CD0 D1               pop de                    ; Step back again
2929  8CD1 ED 53 B7 5F      ld (POS_X), de
2930  8CD5 C9               ret
2931  8CD6
2932  8CD6              SET_BACKSPACE_MARGINS_WIDTH:
2933  8CD6 3A C7 5F         ld a, (WIDTH_BACKSPACE)
2934  8CD9 4F               ld c, a
2935  8CDA 3A BB 5F         ld a, (MAX_X)
2936  8CDD 47               ld b, a
2937  8CDE 3A B9 5F         ld a, (MIN_X)
2938  8CE1 B8           1:  cp b
2939  8CE2 30 03            jr nc, 2f                 ;Right border overshoot
2940  8CE4 81               add a, c
2941  8CE5 30 FA            jr nc, 1b                 ;beyond 255!
2942  8CE7 91           2:  sub c                     ;Step back
2943  8CE8 32 C6 5F         ld (MAX_X_BACKSPACE), a
2944  8CEB C9               ret
2945  8CEC
2946  8CEC
2947  8CEC              ;----------------------------------------------------
2948  8CEC
2949  8CEC              POS_CHECK:
2950  8CEC                  ; B = Y, C = X
2951  8CEC 3E 17            ld a, 23
2952  8CEE B8               cp b
2953  8CEF D8               ret c
2954  8CF0 3E 1F            ld a, 31
2955  8CF2 B9               cp c
2956  8CF3 C9               ret
2957  8CF4
2958  8CF4              POS_ADJUST:
2959  8CF4                  ; B = Y, C = X
2960  8CF4 3E 17            ld a, 23
2961  8CF6 B8               cp b
2962  8CF7 30 01            jr nc, 1f
2963  8CF9 47               ld b, a
2964  8CFA 3E 1F        1:  ld a, 31
2965  8CFC B9               cp c
2966  8CFD D0               ret nc
2967  8CFE 4F               ld c, a
2968  8CFF C9               ret
2969  8D00
2970  8D00              RECT_ADJUST:
2971  8D00                  ; B = Y, C = X
2972  8D00                  ; D = Height, E = Width
2973  8D00 7B               ld a, e
2974  8D01 81               add a, c
2975  8D02 38 04            jr c, 4f
2976  8D04 FE 20            cp 32
2977  8D06 38 04            jr c, 1f
2978  8D08 3E 20        4:  ld a, 32
2979  8D0A 91               sub c
2980  8D0B 5F               ld e, a
2981  8D0C 7A           1:  ld a, d
2982  8D0D 80               add a, b
2983  8D0E 38 03            jr c, 3f
2984  8D10 FE 18            cp 24
2985  8D12 D8               ret c
2986  8D13 3E 18        3:  ld a, 24
2987  8D15 90               sub b
2988  8D16 57               ld d, a
2989  8D17 C9               ret
2990  8D18              ;-----------------------------------------------------
2991  8D18
2992  8D18              CLEAR_WIN:
2993  8D18 ED 4B B9 5F      ld bc, (MIN_X)
2994  8D1C ED 5B BB 5F      ld de, (MAX_X)
2995  8D20 ED 43 B7 5F      ld (POS_X), bc         ;set to origin of window
2996  8D24 DD E5            push ix
2997  8D26 DD 21 74 80      ld ix, TMP_AREA+4
2998  8D2A CD AC 8D         call CALCULATE_RECT
2999  8D2D CD CC 8D         call CLEAR_RECT
3000  8D30 AF               xor a
3001  8D31                  ;ld (NUM_OPTIONS), a          ;Clear options.
3002  8D31 32 BD 5F         ld (PRINTED_LINES), a
3003  8D34 DD E1            pop ix
3004  8D36 C9               ret
3005  8D37
3006  8D37              SCROLL_WIN:
3007  8D37 DD E5            push ix
3008  8D39 ED 4B B9 5F      ld bc, (MIN_X)
3009  8D3D ED 5B BB 5F      ld de, (MAX_X)
3010  8D41 DD 21 74 80      ld ix, TMP_AREA+4
3011  8D45 CD AC 8D         call CALCULATE_RECT
3012  8D48 DD 4E FF         ld c, (ix-1)   ; XPOS
3013  8D4B DD 46 FE         ld b, (ix-2)   ; YPOS
3014  8D4E DD 56 FD         ld d, (ix-3)   ; Width
3015  8D51 DD 5E FC         ld e, (ix-4)   ; Height
3016  8D54 CD 37 8E         call SCROLL_UP
3017  8D57                  ; b=row, c=col
3018  8D57                  ; d=width, e=height
3019  8D57 3A BC 5F         ld a, (MAX_Y)
3020  8D5A DD 77 FE         ld (ix-2), a
3021  8D5D DD 36 FC 01      ld (ix-4), 1
3022  8D61 CD CC 8D         call CLEAR_RECT
3023  8D64 3A A4 5F         ld a, (NUM_OPTIONS)
3024  8D67 B7               or a
3025  8D68 C4 6E 8D         call nz, UPDATE_OPTIONS_POS
3026  8D6B DD E1            pop ix
3027  8D6D C9               ret
3028  8D6E
3029  8D6E                  ; a = number of options
3030  8D6E              UPDATE_OPTIONS_POS:
3031  8D6E ED 4B B9 5F      ld bc, (MIN_X)               ;c = MIN_Y
3032  8D72 47               ld b, a                      ;Number of options -> b
3033  8D73 11 08 00         ld de, 8
3034  8D76 21 01 5E         ld hl, OPTIONS_TABLE+1  ;Set pointer to first Y parameter
3035  8D79 35           1:  dec (hl)
3036  8D7A 7E               ld a, (hl)
3037  8D7B FE 18            cp 24                        ; A - 24
3038  8D7D 30 07            jr nc, 2f                    ; testing if A >= 24
3039  8D7F B9               cp c                         ; A - MIN_Y
3040  8D80 38 04            jr c, 2f                     ; testing if A < MIN_Y
3041  8D82 19               add hl, de
3042  8D83 10 F4            djnz 1b
3043  8D85 C9               ret
3044  8D86 3E 08        2:  ld a, 8                      ; ERROR if option is lost
3045  8D88 C3 00 9F         jp SYS_ERROR
3046  8D8B
3047  8D8B              CLEAR_LINE:
3048  8D8B DD E5            push ix
3049  8D8D ED 4B B9 5F      ld bc, (MIN_X)
3050  8D91 ED 5B BB 5F      ld de, (MAX_X)
3051  8D95 DD 21 74 80      ld ix, TMP_AREA+4
3052  8D99 CD AC 8D         call CALCULATE_RECT
3053  8D9C 3A B8 5F         ld a, (POS_Y)
3054  8D9F DD 77 FE         ld (ix-2), a
3055  8DA2 DD 36 FC 01      ld (ix-4), 1
3056  8DA6 CD CC 8D         call CLEAR_RECT
3057  8DA9 DD E1            pop ix
3058  8DAB C9               ret
3059  8DAC
3060  8DAC              CALCULATE_RECT:
3061  8DAC DD 70 FE         ld (ix-2), b         ; YPOS
3062  8DAF
3063  8DAF CB 39            srl c
3064  8DB1 CB 39            srl c
3065  8DB3 CB 39            srl c
3066  8DB5
3067  8DB5 CB 3B            srl e
3068  8DB7 CB 3B            srl e
3069  8DB9 CB 3B            srl e
3070  8DBB
3071  8DBB DD 71 FF         ld (ix-1), c         ; XPOS
3072  8DBE
3073  8DBE 7B               ld a, e
3074  8DBF 91               sub c
3075  8DC0 3C               inc a
3076  8DC1 DD 77 FD         ld (ix-3), a         ;Width
3077  8DC4
3078  8DC4 7A               ld a, d
3079  8DC5 90               sub b
3080  8DC6 57               ld d, a
3081  8DC7 3C               inc a
3082  8DC8 DD 77 FC         ld (ix-4), a        ; Height
3083  8DCB C9               ret
3084  8DCC
3085  8DCC              CLEAR_RECT:
3086  8DCC DD 7E FE         ld      a,(ix-2)   ; ypos
3087  8DCF 0F               rrca
3088  8DD0 0F               rrca
3089  8DD1 0F               rrca               ; Multiply by 32
3090  8DD2 6F               ld      l,a        ; Pass to L
3091  8DD3 E6 03            and     3          ; Mask with 00000011
3092  8DD5 C6 58            add     a,88       ; 88 * 256 = 22528 - start of attributes. Change this if you are working with a buffer or somesuch.
3093  8DD7 67               ld      h,a        ; Put it in the High Byte
3094  8DD8 7D               ld      a,l        ; We get y value *32
3095  8DD9 E6 E0            and     224        ; Mask with 11100000
3096  8DDB 6F               ld      l,a        ; Put it in L
3097  8DDC DD 7E FF         ld      a,(ix-1)   ; xpos
3098  8DDF 85               add     a,l        ; Add it to the Low byte
3099  8DE0 6F               ld      l,a        ; Put it back in L, and we're done. HL=Address.
3100  8DE1
3101  8DE1 E5               push HL            ; save address
3102  8DE2 3A 8D 5C         LD A, (ATTR_P)     ; attribute
3103  8DE5 11 20 00         LD DE,32
3104  8DE8 DD 4E FC         LD c,(ix-4)       ; height
3105  8DEB
3106  8DEB              .BLPaintHeightLoop:
3107  8DEB DD 46 FD         LD b,(ix-3)        ; width
3108  8DEE
3109  8DEE              .BLPaintWidthLoop:
3110  8DEE 77               LD (HL),a          ; paint a character
3111  8DEF 2C               INC L              ; Move to the right (Note that we only would have to inc H if we are crossing from the right edge to the left, and we shouldn't be needing to do that)
3112  8DF0 10 FC            DJNZ .BLPaintWidthLoop
3113  8DF2
3114  8DF2              .BLPaintWidthExitLoop:
3115  8DF2 E1               POP HL             ; recover our left edge
3116  8DF3 0D               DEC C
3117  8DF4 28 05            JR Z, .BLPaintHeightExitLoop
3118  8DF6
3119  8DF6 19               ADD HL,DE          ; move 32 down
3120  8DF7 E5               PUSH HL            ; save it again
3121  8DF8 C3 EB 8D         JP .BLPaintHeightLoop
3122  8DFB
3123  8DFB              .BLPaintHeightExitLoop:
3124  8DFB
3125  8DFB DD 46 FF         ld b,(ix-1)     ; get x value
3126  8DFE DD 4E FE         ld c,(ix-2)     ; get y value
3127  8E01
3128  8E01 79               ld a, c         ; Set HL to screen byte for this character.
3129  8E02 E6 18            and 24
3130  8E04 F6 40            or 64
3131  8E06 67               ld h, a
3132  8E07 79               ld a, c
3133  8E08 E6 07            and 7
3134  8E0A 1F               rra
3135  8E0B 1F               rra
3136  8E0C 1F               rra
3137  8E0D 1F               rra
3138  8E0E 80               add a, b
3139  8E0F 6F               ld l, a
3140  8E10
3141  8E10 DD 46 FC         ld b,(ix-4)     ; get height
3142  8E13 DD 4E FD         ld c,(ix-3)     ; get width
3143  8E16
3144  8E16              .clearbox_outer_loop:
3145  8E16 AF               xor a
3146  8E17 C5               push bc       ; save height.
3147  8E18 E5               push hl       ; save screen address.
3148  8E19 16 08            ld d, 8       ; 8 rows to a character.
3149  8E1B
3150  8E1B              .clearbox_mid_loop:
3151  8E1B 5D               ld e,l        ; save screen byte lower half.
3152  8E1C 41               ld b,c        ; get width.
3153  8E1D
3154  8E1D              .clearbox_inner_loop:
3155  8E1D 77               ld (hl), a    ; write out a zero to the screen.
3156  8E1E
3157  8E1E 2C               inc l         ; go right.
3158  8E1F 10 FC            djnz .clearbox_inner_loop    ; repeat.
3159  8E21
3160  8E21 6B               ld l,e        ; recover screen byte
3161  8E22 24               inc h         ; down a row
3162  8E23
3163  8E23 15               dec d
3164  8E24 C2 1B 8E         jp nz, .clearbox_mid_loop  ; repeat for this row.
3165  8E27
3166  8E27 E1               pop hl        ; get back address at start of line
3167  8E28 C1               pop bc        ; get back char count.
3168  8E29
3169  8E29 3E 20            ld a, 32      ; Go down to next character row.
3170  8E2B 85               add a, l
3171  8E2C 6F               ld l, a
3172  8E2D D2 34 8E         jp nc, .clearbox_row_skip
3173  8E30
3174  8E30 3E 08            ld a, 8
3175  8E32 84               add a, h
3176  8E33 67               ld h, a
3177  8E34
3178  8E34              .clearbox_row_skip:
3179  8E34 10 E0            djnz .clearbox_outer_loop
3180  8E36 C9               ret
3181  8E37
3182  8E37
3183  8E37              ;----------------------------------------------------
3184  8E37              ; scrolls the window defined by (row, col, width, height) 1 cell up
3185  8E37              SCROLL_UP:
3186  8E37                  ; b=row, c=col
3187  8E37                  ; d=width, e=height
3188  8E37 7B               ld a, e
3189  8E38 B7               or a
3190  8E39 C8               ret z
3191  8E3A B2               or d
3192  8E3B C8               ret z
3193  8E3C
3194  8E3C C5               push bc
3195  8E3D D5               push de
3196  8E3E
3197  8E3E 78               ld a,b
3198  8E3F E6 18            and 18h
3199  8E41 67               ld h,a
3200  8E42 78               ld a,b
3201  8E43 E6 07            and 07h
3202  8E45 87               add a,a
3203  8E46 87               add a,a
3204  8E47 87               add a,a
3205  8E48 87               add a,a
3206  8E49 87               add a,a
3207  8E4A 81               add a,c
3208  8E4B 6F               ld l,a   ;HL=top-left window address in bitmap coord
3209  8E4C 01 00 40         ld bc, SCR_PXL
3210  8E4F 09               add hl, bc
3211  8E50 7B               ld a,e
3212  8E51 4A               ld c, d  ; c = width
3213  8E52 54               ld d, h
3214  8E53 5D               ld e, l
3215  8E54 3D               dec a
3216  8E55 28 22            jr z, .CleanLast
3217  8E57 87               add a,a
3218  8E58 87               add a,a
3219  8E59 87               add a,a
3220  8E5A 47               ld b, a  ; b = 8 * (height - 1)
3221  8E5B
3222  8E5B 24               inc h
3223  8E5C 24               inc h
3224  8E5D 24               inc h
3225  8E5E 24               inc h
3226  8E5F 24               inc h
3227  8E60 24               inc h
3228  8E61 24               inc h
3229  8E62 CD BF 8E         call PIXEL_DOWN
3230  8E65
3231  8E65              .BucleScans:
3232  8E65 C5               push bc
3233  8E66 D5               push de
3234  8E67 E5               push hl
3235  8E68 06 00            ld b, 0
3236  8E6A ED B0            ldir
3237  8E6C E1               pop hl
3238  8E6D D1               pop de
3239  8E6E C1               pop bc
3240  8E6F CD BF 8E         call PIXEL_DOWN
3241  8E72 EB               ex de, hl
3242  8E73 CD BF 8E         call PIXEL_DOWN
3243  8E76 EB               ex de, hl
3244  8E77 10 EC            djnz .BucleScans
3245  8E79
3246  8E79              .CleanLast:
3247  8E79 EB               ex de,hl
3248  8E7A D1               pop de
3249  8E7B 06 08            ld b, 8
3250  8E7D 4A               ld c, d
3251  8E7E D5               push de
3252  8E7F
3253  8E7F              .CleanLastLoop:
3254  8E7F C5               push bc
3255  8E80 E5               push hl
3256  8E81 36 00            ld (hl), 0
3257  8E83 0D               dec c
3258  8E84 28 07            jr z, .EndCleanScan
3259  8E86 54               ld d, h
3260  8E87 5D               ld e, l
3261  8E88 13               inc de
3262  8E89 06 00            ld b, 0
3263  8E8B ED B0            ldir
3264  8E8D
3265  8E8D              .EndCleanScan:
3266  8E8D E1               pop hl
3267  8E8E C1               pop bc
3268  8E8F 24               inc h
3269  8E90 10 ED            djnz .CleanLastLoop
3270  8E92
3271  8E92              .ScrollAttrs:
3272  8E92 D1               pop de
3273  8E93 C1               pop bc
3274  8E94 68               ld l,b
3275  8E95 26 00            ld h,0
3276  8E97 29               add hl,hl
3277  8E98 29               add hl,hl
3278  8E99 29               add hl,hl
3279  8E9A 29               add hl,hl
3280  8E9B 29               add hl,hl
3281  8E9C 7D               ld a,l
3282  8E9D 81               add a,c
3283  8E9E 6F               ld l,a
3284  8E9F 7C               ld a,h
3285  8EA0 67               ld h,a    ;HL=top-left address in attr coords
3286  8EA1 01 00 58         ld bc, SCR_ATT
3287  8EA4 09               add hl, bc
3288  8EA5 43               ld b,e
3289  8EA6 05               dec b
3290  8EA7 C8               ret z
3291  8EA8
3292  8EA8              .BucleAttrs:
3293  8EA8 C5               push bc
3294  8EA9 D5               push de
3295  8EAA E5               push hl
3296  8EAB 06 00            ld b,0
3297  8EAD 4A               ld c,d
3298  8EAE EB               ex de,hl
3299  8EAF 21 20 00         ld hl,32
3300  8EB2 19               add hl,de
3301  8EB3 ED B0            ldir
3302  8EB5 E1               pop hl
3303  8EB6 11 20 00         ld de,32
3304  8EB9 19               add hl,de
3305  8EBA D1               pop de
3306  8EBB C1               pop bc
3307  8EBC 10 EA            djnz .BucleAttrs
3308  8EBE C9               ret
3309  8EBF              ;-----------------------------------
3310  8EBF              ; Pixel Down
3311  8EBF              ;
3312  8EBF              ; Adjusts screen address HL to move one pixel down in the display.
3313  8EBF              ; (0,0) is located at the top left corner of the screen.
3314  8EBF              ;
3315  8EBF              ; enter: HL = valid screen address
3316  8EBF              ; exit : Carry = moved off screen
3317  8EBF              ;        Carry'= moved off current cell (needs ATTR update)
3318  8EBF              ;        HL = moves one pixel down
3319  8EBF              ; used : AF, HL
3320  8EBF              PIXEL_DOWN:
3321  8EBF D5               push de
3322  8EC0 11 00 40         ld de, SCR_PXL
3323  8EC3 B7               or a
3324  8EC4 ED 52            sbc hl, de
3325  8EC6 24               inc h
3326  8EC7 7C               ld a,h
3327  8EC8 E6 07            and $07
3328  8ECA 20 17            jr nz, .leave
3329  8ECC 37               scf         ;  Sets carry on F', which flags ATTR must be updated
3330  8ECD 08               ex af, af'
3331  8ECE 7C               ld a,h
3332  8ECF D6 08            sub $08
3333  8ED1 67               ld h,a
3334  8ED2 7D               ld a,l
3335  8ED3 C6 20            add a,$20
3336  8ED5 6F               ld l,a
3337  8ED6 30 0B            jr nc, .leave
3338  8ED8 7C               ld a,h
3339  8ED9 C6 08            add a,$08
3340  8EDB 67               ld h,a
3341  8EDC FE 19            cp $19     ; carry = 0 => Out of screen
3342  8EDE 38 03            jr c, .leave ; returns if out of screen
3343  8EE0 3F               ccf
3344  8EE1 D1               pop de
3345  8EE2 C9               ret
3346  8EE3              .leave:
3347  8EE3 19               add hl, de ; This always sets Carry = 0
3348  8EE4 D1               pop de
3349  8EE5 C9               ret
3350  8EE6              ;-------------------------------
3351  8EE6              ; ==============================================================================
3352  8EE6              ; Choose Your Destiny
3353  8EE6              ;
3354  8EE6              ; Copyright (c) 2025 Sergio Chico (Cronomantic)
3355  8EE6              ;
3356  8EE6              ; Permission is hereby granted, free of charge, to any person obtaining a copy
3357  8EE6              ; of this software and associated documentation files (the "Software"), to deal
3358  8EE6              ; in the Software without restriction, including without limitation the rights
3359  8EE6              ; to use, copy, modify, merge, publish, distribute and/or sell copies of the
3360  8EE6              ; Software, and to permit persons to whom the Software is furnished to do so,
3361  8EE6              ; subject to the following conditions:
3362  8EE6              ;
3363  8EE6              ; - The above copyright notice and this permission notice shall be included
3364  8EE6              ; in all copies or substantial portions of the Software.
3365  8EE6              ;
3366  8EE6              ; - The above copyright notice and/or one of the project logos must
3367  8EE6              ; be prominently displayed both on the loading screen and/or within
3368  8EE6              ; the programs that include this Software, as well as on the
3369  8EE6              ; download website in the case of a digital copy and/or on the
3370  8EE6              ; cover page in the case of a physical copy.
3371  8EE6              ;
3372  8EE6              ; - THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
3373  8EE6              ; EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
3374  8EE6              ; MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
3375  8EE6              ; IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
3376  8EE6              ; DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
3377  8EE6              ; OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR
3378  8EE6              ; THE USE OR OTHER DEALINGS IN THE SOFTWARE.
3379  8EE6              ;
3380  8EE6              ; ==============================================================================
3381  8EE6
3382  8EE6              OP_END EQU END_PROGRAM
3383  8EE6
3384  8EE6              OP_TEXT:
3385  8EE6 11 09 83         ld de, EXEC_LOOP
3386  8EE9 D5               push de
3387  8EEA C3 57 8B         jp PRINT_TOKEN_STR
3388  8EED
3389  8EED              OP_GOTO:
3390  8EED 4E               ld c, (hl)
3391  8EEE 23               inc hl
3392  8EEF 5E               ld e, (hl)
3393  8EF0 23               inc hl
3394  8EF1 56               ld d, (hl)
3395  8EF2 EB               ex de, hl
3396  8EF3 3A BE 5F         ld a, (CHUNK)
3397  8EF6 B9               cp c       ; If the CHUNK is the same...
3398  8EF7 28 06            jr z, .same_CHUNK
3399  8EF9 E5               push hl
3400  8EFA 79               ld a, c
3401  8EFB CD 19 83         call LOAD_CHUNK
3402  8EFE E1               pop hl
3403  8EFF              .same_CHUNK:
3404  8EFF C3 09 83         jp EXEC_LOOP
3405  8F02
3406  8F02              OP_GOSUB:
3407  8F02 E5               push hl
3408  8F03 11 03 00         ld de, 3
3409  8F06 19               add hl, de
3410  8F07 3A BE 5F         ld a, (CHUNK)
3411  8F0A DD 75 FF         ld (ix-1), l
3412  8F0D DD 74 FE         ld (ix-2), h
3413  8F10 DD 77 FD         ld (ix-3), a
3414  8F13 11 FD FF         ld de, 65536-3    ; ix-3
3415  8F16 DD 19            add ix, de
3416  8F18 E1               pop hl
3417  8F19 C3 ED 8E         jp OP_GOTO
3418  8F1C
3419  8F1C              OP_RETURN:
3420  8F1C DD 4E 00         ld c, (ix+0)
3421  8F1F DD 66 01         ld h, (ix+1)
3422  8F22 DD 6E 02         ld l, (ix+2)
3423  8F25 11 03 00         ld de, 3
3424  8F28 DD 19            add ix, de
3425  8F2A 3A BE 5F         ld a, (CHUNK)
3426  8F2D B9               cp c       ; If the CHUNK is the same...
3427  8F2E 28 06            jr z, .same_CHUNK
3428  8F30 E5               push hl
3429  8F31 79               ld a, c
3430  8F32 CD 19 83         call LOAD_CHUNK
3431  8F35 E1               pop hl
3432  8F36              .same_CHUNK:
3433  8F36 C3 09 83         jp EXEC_LOOP
3434  8F39
3435  8F39              ;-------------------------------------
3436  8F39
3437  8F39                  MACRO POP_INT_STACK
3438  8F39 ~                ld a, (ix+0)
3439  8F39 ~                inc ix
3440  8F39                  ENDM
3441  8F39
3442  8F39                  MACRO PUSH_INT_STACK
3443  8F39 ~                dec ix
3444  8F39 ~                ld (ix+0), a
3445  8F39                  ENDM
3446  8F39
3447  8F39              OP_IF_GOTO:
3448  8F39                  POP_INT_STACK
3448  8F39 DD 7E 00    >    ld a, (ix+0)
3448  8F3C DD 23       >    inc ix
3449  8F3E B7               or a
3450  8F3F C2 ED 8E         jp nz, OP_GOTO
3451  8F42 11 03 00         ld de, 3
3452  8F45 19               add hl, de
3453  8F46 C3 09 83         jp EXEC_LOOP
3454  8F49
3455  8F49              OP_IF_N_GOTO:
3456  8F49                  POP_INT_STACK
3456  8F49 DD 7E 00    >    ld a, (ix+0)
3456  8F4C DD 23       >    inc ix
3457  8F4E B7               or a
3458  8F4F CA ED 8E         jp z, OP_GOTO
3459  8F52 11 03 00         ld de, 3
3460  8F55 19               add hl, de
3461  8F56 C3 09 83         jp EXEC_LOOP
3462  8F59              ;-------------------------------------------------------
3463  8F59                  IFNDEF UNUSED_OP_POP_SET
3463  8F59
3464  8F59              OP_POP_SET:
3465  8F59                  ; [param] <- Stack
3466  8F59                  POP_INT_STACK
3466  8F59 DD 7E 00    >    ld a, (ix+0)
3466  8F5C DD 23       >    inc ix
3467  8F5E 16 5D            ld d, HIGH FLAGS
3468  8F60 5E               ld e, (hl)
3469  8F61 23               inc hl
3470  8F62 12               ld (de), a
3471  8F63 C3 09 83         jp EXEC_LOOP
3472  8F66                  ENDIF
3473  8F66
3474  8F66                  IFNDEF UNUSED_OP_POP_SET_DI
3475  8F66              OP_POP_SET_DI:
3476  8F66                  ; [[param]] <- Stack
3477  8F66 16 5D            ld d, HIGH FLAGS
3478  8F68 5E               ld e, (hl)
3479  8F69 23               inc hl
3480  8F6A EB               ex de, hl
3481  8F6B                  POP_INT_STACK
3481  8F6B DD 7E 00    >    ld a, (ix+0)
3481  8F6E DD 23       >    inc ix
3482  8F70 6E               ld l, (hl)
3483  8F71 77               ld (hl), a
3484  8F72 EB               ex de, hl
3485  8F73 C3 09 83         jp EXEC_LOOP
3486  8F76                  ENDIF
3487  8F76
3488  8F76                  IFNDEF UNUSED_OP_PUSH_D
3489  8F76              OP_PUSH_D:
3490  8F76                  ; Stack <- Param
3491  8F76 7E               ld a, (hl)
3492  8F77 23               inc hl
3493  8F78                  PUSH_INT_STACK
3493  8F78 DD 2B       >    dec ix
3493  8F7A DD 77 00    >    ld (ix+0), a
3494  8F7D C3 09 83         jp EXEC_LOOP
3495  8F80                  ENDIF
3496  8F80
3497  8F80                  IFNDEF UNUSED_OP_PUSH_I
3498  8F80              OP_PUSH_I:
3499  8F80                  ; Stack <- [Param]
3500  8F80 16 5D            ld d, HIGH FLAGS
3501  8F82 5E               ld e, (hl)
3502  8F83 23               inc hl
3503  8F84 1A               ld a, (de)
3504  8F85                  PUSH_INT_STACK
3504  8F85 DD 2B       >    dec ix
3504  8F87 DD 77 00    >    ld (ix+0), a
3505  8F8A C3 09 83         jp EXEC_LOOP
3506  8F8D                  ENDIF
3507  8F8D
3508  8F8D                  IFNDEF UNUSED_OP_PUSH_DI
3509  8F8D              OP_PUSH_DI:
3510  8F8D                  ; Stack <- [[Param]]
3511  8F8D 16 5D            ld d, HIGH FLAGS
3512  8F8F 5E               ld e, (hl)
3513  8F90 23               inc hl
3514  8F91 1A               ld a, (de)
3515  8F92 5F               ld e, a
3516  8F93 1A               ld a, (de)
3517  8F94                  PUSH_INT_STACK
3517  8F94 DD 2B       >    dec ix
3517  8F96 DD 77 00    >    ld (ix+0), a
3518  8F99 C3 09 83         jp EXEC_LOOP
3519  8F9C                  ENDIF
3520  8F9C
3521  8F9C                  IFNDEF UNUSED_OP_POP_PUSH_I
3522  8F9C              OP_POP_PUSH_I:
3523  8F9C                  ; Stack <- [Stack]
3524  8F9C DD 5E 00         ld e, (ix+0)
3525  8F9F 16 5D            ld d, HIGH FLAGS
3526  8FA1 1A               ld a, (de)
3527  8FA2 DD 77 00         ld (ix+0), a
3528  8FA5 C3 09 83         jp EXEC_LOOP
3529  8FA8                  ENDIF
3530  8FA8
3531  8FA8                  IFNDEF UNUSED_OP_SET_D
3532  8FA8              OP_SET_D:
3533  8FA8                  ;[Param1] <- Param2
3534  8FA8 16 5D            ld d, HIGH FLAGS
3535  8FAA 5E               ld e, (hl)
3536  8FAB 23               inc hl
3537  8FAC 7E               ld a, (hl)
3538  8FAD 23               inc hl
3539  8FAE 12               ld (de), a
3540  8FAF C3 09 83         jp EXEC_LOOP
3541  8FB2                  ENDIF
3542  8FB2
3543  8FB2                  IFNDEF UNUSED_OP_SET_I
3544  8FB2              OP_SET_I:
3545  8FB2                  ;[Param1] <- [Param2]
3546  8FB2 4E               ld c, (hl)
3547  8FB3 23               inc hl
3548  8FB4 16 5D            ld d, HIGH FLAGS
3549  8FB6 5E               ld e, (hl)
3550  8FB7 23               inc hl
3551  8FB8 1A               ld a, (de)
3552  8FB9 59               ld e, c
3553  8FBA 12               ld (de), a
3554  8FBB C3 09 83         jp EXEC_LOOP
3555  8FBE                  ENDIF
3556  8FBE
3557  8FBE                  IFNDEF UNUSED_OP_SET_DI
3558  8FBE              OP_SET_DI:
3559  8FBE                  ;[Param1] <- [[Param2]]
3560  8FBE 4E               ld c, (hl)
3561  8FBF 23               inc hl
3562  8FC0 16 5D            ld d, HIGH FLAGS
3563  8FC2 5E               ld e, (hl)
3564  8FC3 23               inc hl
3565  8FC4 1A               ld a, (de)
3566  8FC5 5F               ld e, a
3567  8FC6 1A               ld a, (de)
3568  8FC7 59               ld e, c
3569  8FC8 12               ld (de), a
3570  8FC9 C3 09 83         jp EXEC_LOOP
3571  8FCC                  ENDIF
3572  8FCC              ;-------------------------------------
3573  8FCC                  MACRO OP_2PARAM_GET_STACK
3574  8FCC ~                ld c, (ix+0)
3575  8FCC ~                ld a, (ix+1)
3576  8FCC                  ENDM
3577  8FCC
3578  8FCC                  MACRO OP_2PARAM_STORE_STACK
3579  8FCC ~                inc ix
3580  8FCC ~                ld (ix+0), a
3581  8FCC ~                jp EXEC_LOOP
3582  8FCC                  ENDM
3583  8FCC
3584  8FCC                  IFNDEF UNUSED_OP_NOT
3585  8FCC              OP_NOT:
3586  8FCC DD 7E 00         ld a, (ix+0)
3587  8FCF EE 01            xor 1
3588  8FD1 DD 77 00         ld (ix+0), a
3589  8FD4 C3 09 83         jp EXEC_LOOP
3590  8FD7                  ENDIF
3591  8FD7
3592  8FD7                  IFNDEF UNUSED_OP_NOT_B
3593  8FD7              OP_NOT_B:
3594  8FD7 DD 7E 00         ld a, (ix+0)
3595  8FDA 2F               cpl
3596  8FDB DD 77 00         ld (ix+0), a
3597  8FDE C3 09 83         jp EXEC_LOOP
3598  8FE1                  ENDIF
3599  8FE1
3600  8FE1                  IFNDEF UNUSED_OP_AND
3601  8FE1              OP_AND:
3602  8FE1                  OP_2PARAM_GET_STACK
3602  8FE1 DD 4E 00    >    ld c, (ix+0)
3602  8FE4 DD 7E 01    >    ld a, (ix+1)
3603  8FE7 A1               and c
3604  8FE8                  OP_2PARAM_STORE_STACK
3604  8FE8 DD 23       >    inc ix
3604  8FEA DD 77 00    >    ld (ix+0), a
3604  8FED C3 09 83    >    jp EXEC_LOOP
3605  8FF0                  ENDIF
3606  8FF0
3607  8FF0                  IFNDEF UNUSED_OP_OR
3608  8FF0              OP_OR:
3609  8FF0                  OP_2PARAM_GET_STACK
3609  8FF0 DD 4E 00    >    ld c, (ix+0)
3609  8FF3 DD 7E 01    >    ld a, (ix+1)
3610  8FF6 B1               or c
3611  8FF7                  OP_2PARAM_STORE_STACK
3611  8FF7 DD 23       >    inc ix
3611  8FF9 DD 77 00    >    ld (ix+0), a
3611  8FFC C3 09 83    >    jp EXEC_LOOP
3612  8FFF                  ENDIF
3613  8FFF
3614  8FFF                  IFNDEF UNUSED_OP_CP_EQ
3615  8FFF              OP_CP_EQ:
3616  8FFF                  OP_2PARAM_GET_STACK
3616  8FFF DD 4E 00    >    ld c, (ix+0)
3616  9002 DD 7E 01    >    ld a, (ix+1)
3617  9005 B9               cp c
3618  9006 28 03            jr z, 1f
3619  9008 AF               xor a
3620  9009 18 02            jr 2f
3621  900B 3E 01        1:  ld a, 1
3622  900D              2:  OP_2PARAM_STORE_STACK
3622  900D DD 23       >    inc ix
3622  900F DD 77 00    >    ld (ix+0), a
3622  9012 C3 09 83    >    jp EXEC_LOOP
3623  9015                  ENDIF
3624  9015
3625  9015                  IFNDEF UNUSED_OP_CP_NE
3626  9015              OP_CP_NE:
3627  9015                  OP_2PARAM_GET_STACK
3627  9015 DD 4E 00    >    ld c, (ix+0)
3627  9018 DD 7E 01    >    ld a, (ix+1)
3628  901B B9               cp c
3629  901C 20 03            jr nz, 1f
3630  901E AF               xor a
3631  901F 18 02            jr 2f
3632  9021 3E 01        1:  ld a, 1
3633  9023              2:  OP_2PARAM_STORE_STACK
3633  9023 DD 23       >    inc ix
3633  9025 DD 77 00    >    ld (ix+0), a
3633  9028 C3 09 83    >    jp EXEC_LOOP
3634  902B                  ENDIF
3635  902B
3636  902B                  IFNDEF UNUSED_OP_CP_LT
3637  902B              OP_CP_LT:                ; p1 < p2
3638  902B                  OP_2PARAM_GET_STACK  ; p2 = C, p1 = A
3638  902B DD 4E 00    >    ld c, (ix+0)
3638  902E DD 7E 01    >    ld a, (ix+1)
3639  9031 B9               cp c                 ; p1 - p2 -> p1 < p2
3640  9032 38 03            jr c, 1f
3641  9034 AF               xor a
3642  9035 18 02            jr 2f
3643  9037 3E 01        1:  ld a, 1
3644  9039              2:  OP_2PARAM_STORE_STACK
3644  9039 DD 23       >    inc ix
3644  903B DD 77 00    >    ld (ix+0), a
3644  903E C3 09 83    >    jp EXEC_LOOP
3645  9041                  ENDIF
3646  9041
3647  9041                  IFNDEF UNUSED_OP_CP_ME
3648  9041              OP_CP_ME:               ; p1 >= p2
3649  9041                  OP_2PARAM_GET_STACK ; p2 = C, p1 = A
3649  9041 DD 4E 00    >    ld c, (ix+0)
3649  9044 DD 7E 01    >    ld a, (ix+1)
3650  9047 B9               cp c                ; p1 - p2
3651  9048 30 03            jr nc, 1f
3652  904A AF               xor a
3653  904B 18 02            jr 2f
3654  904D 3E 01        1:  ld a, 1
3655  904F              2:  OP_2PARAM_STORE_STACK
3655  904F DD 23       >    inc ix
3655  9051 DD 77 00    >    ld (ix+0), a
3655  9054 C3 09 83    >    jp EXEC_LOOP
3656  9057                  ENDIF
3657  9057
3658  9057                  IFNDEF UNUSED_OP_CP_MT
3659  9057              OP_CP_MT:                ; p1 > p2
3660  9057                  OP_2PARAM_GET_STACK  ; p2 = C, p1 = A
3660  9057 DD 4E 00    >    ld c, (ix+0)
3660  905A DD 7E 01    >    ld a, (ix+1)
3661  905D 47               ld b, a
3662  905E 79               ld a, c              ; p2 = A, p1 = B
3663  905F B8               cp b                 ; p2 - p1 -> p2 < p1
3664  9060 38 03            jr c, 1f
3665  9062 AF               xor a
3666  9063 18 02            jr 2f
3667  9065 3E 01        1:  ld a, 1
3668  9067              2:  OP_2PARAM_STORE_STACK
3668  9067 DD 23       >    inc ix
3668  9069 DD 77 00    >    ld (ix+0), a
3668  906C C3 09 83    >    jp EXEC_LOOP
3669  906F                  ENDIF
3670  906F
3671  906F                  IFNDEF UNUSED_OP_CP_LE
3672  906F              OP_CP_LE:                ; p1 <= p2
3673  906F                  OP_2PARAM_GET_STACK  ; p2 = C, p1 = A
3673  906F DD 4E 00    >    ld c, (ix+0)
3673  9072 DD 7E 01    >    ld a, (ix+1)
3674  9075 47               ld b, a
3675  9076 79               ld a, c              ; p2 = A, p1 = B
3676  9077 B8               cp b                 ; p2 - p1 -> p2 < p1
3677  9078 30 03            jr nc, 1f
3678  907A AF               xor a
3679  907B 18 02            jr 2f
3680  907D 3E 01        1:  ld a, 1
3681  907F              2:  OP_2PARAM_STORE_STACK
3681  907F DD 23       >    inc ix
3681  9081 DD 77 00    >    ld (ix+0), a
3681  9084 C3 09 83    >    jp EXEC_LOOP
3682  9087                  ENDIF
3683  9087
3684  9087              ;-------------------------------------------------------
3685  9087
3686  9087                  IFNDEF UNUSED_OP_ADD
3687  9087              OP_ADD:
3688  9087                  OP_2PARAM_GET_STACK
3688  9087 DD 4E 00    >    ld c, (ix+0)
3688  908A DD 7E 01    >    ld a, (ix+1)
3689  908D 81               add a, c
3690  908E 30 02            jr nc, 1f
3691  9090 3E FF            ld a, $FF
3692  9092              1:  OP_2PARAM_STORE_STACK
3692  9092 DD 23       >    inc ix
3692  9094 DD 77 00    >    ld (ix+0), a
3692  9097 C3 09 83    >    jp EXEC_LOOP
3693  909A                  ENDIF
3694  909A
3695  909A                  IFNDEF UNUSED_OP_SUB
3696  909A              OP_SUB:
3697  909A                  OP_2PARAM_GET_STACK
3697  909A DD 4E 00    >    ld c, (ix+0)
3697  909D DD 7E 01    >    ld a, (ix+1)
3698  90A0 91               sub c
3699  90A1 30 01            jr nc, 1f
3700  90A3 AF               xor a
3701  90A4              1:  OP_2PARAM_STORE_STACK
3701  90A4 DD 23       >    inc ix
3701  90A6 DD 77 00    >    ld (ix+0), a
3701  90A9 C3 09 83    >    jp EXEC_LOOP
3702  90AC                  ENDIF
3703  90AC
3704  90AC                  IFNDEF UNUSED_OP_INKEY
3705  90AC              OP_INKEY:
3706  90AC 16 5D            ld d, HIGH FLAGS
3707  90AE 5E               ld e, (hl)
3708  90AF 23               inc hl
3709  90B0 7E               ld a, (hl)
3710  90B1 23               inc hl
3711  90B2 CD B2 83         call INKEY_SELECT_WAIT_MODE
3712  90B5 12               ld (de), a
3713  90B6 C3 09 83         jp EXEC_LOOP
3714  90B9                  ENDIF
3715  90B9
3716  90B9                  IFNDEF UNUSED_OP_PUSH_INKEY
3717  90B9              OP_PUSH_INKEY:
3718  90B9 7E               ld a, (hl)
3719  90BA 23               inc hl
3720  90BB CD B2 83         call INKEY_SELECT_WAIT_MODE
3721  90BE                  PUSH_INT_STACK
3721  90BE DD 2B       >    dec ix
3721  90C0 DD 77 00    >    ld (ix+0), a
3722  90C3 C3 09 83         jp EXEC_LOOP
3723  90C6                  ENDIF
3724  90C6
3725  90C6                  IFNDEF UNUSED_OP_SET_KEMPSTON
3726  90C6              OP_SET_KEMPSTON:
3727  90C6 16 5D            ld d, HIGH FLAGS
3728  90C8 5E               ld e, (hl)
3729  90C9 23               inc hl
3730  90CA CD 3F 84         call KEMPSTON
3731  90CD 12               ld (de), a
3732  90CE C3 09 83         jp EXEC_LOOP
3733  90D1                  ENDIF
3734  90D1
3735  90D1                  IFNDEF UNUSED_OP_PUSH_KEMPSTON
3736  90D1              OP_PUSH_KEMPSTON:
3737  90D1 CD 3F 84         call KEMPSTON
3738  90D4                  PUSH_INT_STACK
3738  90D4 DD 2B       >    dec ix
3738  90D6 DD 77 00    >    ld (ix+0), a
3739  90D9 C3 09 83         jp EXEC_LOOP
3740  90DC                  ENDIF
3741  90DC
3742  90DC
3743  90DC                  IFNDEF UNUSED_OP_PUSH_RANDOM
3744  90DC                  IFNDEF USED_DIV_DE
3745  90DC                  DEFINE USED_DIV_DE
3746  90DC                  ENDIF
3747  90DC              OP_PUSH_RANDOM:
3748  90DC E5               push hl
3749  90DD CD 65 83         call RANDOM
3750  90E0 ED 5F            ld a, r            ;Select if we use H or L value based in R value
3751  90E2 0F               rrca
3752  90E3 38 03            jr c, 1f
3753  90E5 7D               ld a, l
3754  90E6 18 01            jr 2f
3755  90E8 7C           1:  ld a, h
3756  90E9 E1           2:  pop hl
3757  90EA 57               ld d, a
3758  90EB 5E               ld e, (hl)        ;Get max element
3759  90EC 23               inc hl
3760  90ED 3E FF            ld a, $FF         ;If E is 255, leave the value as it is
3761  90EF BB               cp e
3762  90F0 20 03            jr nz, 3f
3763  90F2 7A               ld a, d
3764  90F3 18 04            jr 4f
3765  90F5 1C           3:  inc e             ;Increment E to calculate mod E+1
3766  90F6 CD 28 91         call DIV_DE
3767  90F9              4:  ;Stack
3768  90F9                  PUSH_INT_STACK
3768  90F9 DD 2B       >    dec ix
3768  90FB DD 77 00    >    ld (ix+0), a
3769  90FE C3 09 83         jp EXEC_LOOP
3770  9101                  ENDIF
3771  9101
3772  9101
3773  9101                  IFNDEF UNUSED_OP_RANDOM
3774  9101                  IFNDEF USED_DIV_DE
3775  9101 ~                DEFINE USED_DIV_DE
3776  9101                  ENDIF
3777  9101              OP_RANDOM:
3778  9101 5E               ld e, (hl)
3779  9102 16 5D            ld d, HIGH FLAGS
3780  9104 D5               push de
3781  9105 23               inc hl
3782  9106 E5               push hl
3783  9107 CD 65 83         call RANDOM
3784  910A ED 5F            ld a, r            ;Select if we use H or L value based in R value
3785  910C 0F               rrca
3786  910D 38 03            jr c, 1f
3787  910F 7D               ld a, l
3788  9110 18 01            jr 2f
3789  9112 7C           1:  ld a, h
3790  9113 E1           2:  pop hl
3791  9114 57               ld d, a
3792  9115 5E               ld e, (hl)        ;Get max element
3793  9116 23               inc hl
3794  9117 3E FF            ld a, $FF         ;If E is 255, leave the value as it is
3795  9119 BB               cp e
3796  911A 20 03            jr nz, 3f
3797  911C 7A               ld a, d
3798  911D 18 04            jr 4f
3799  911F 1C           3:  inc e             ;Increment E to calculate mod E+1
3800  9120 CD 28 91         call DIV_DE
3801  9123 D1           4:  pop de
3802  9124 12               ld (de), a
3803  9125 C3 09 83         jp EXEC_LOOP
3804  9128                  ENDIF
3805  9128
3806  9128                  IFDEF USED_DIV_DE
3807  9128                  ; Divide D by E. The quotient is in D and remainder in A
3808  9128              DIV_DE:
3809  9128 AF              xor a
3810  9129 06 08           ld b, 8
3811  912B CB 22        1: sla d
3812  912D 17              rla
3813  912E BB              cp e
3814  912F 38 02           jr c, 2f
3815  9131 93              sub e
3816  9132 14              inc d
3817  9133 10 F6        2: djnz	1b
3818  9135 C9              ret
3819  9136                 ENDIF
3820  9136
3821  9136
3822  9136                  IFNDEF UNUSED_OP_RANDOMIZE
3823  9136              OP_RANDOMIZE:
3824  9136 E5               push hl
3825  9137 CD 60 83         call SET_RND_SEED
3826  913A E1               pop hl
3827  913B C3 09 83         jp EXEC_LOOP
3828  913E                  ENDIF
3829  913E
3830  913E                  IFNDEF UNUSED_OP_AT
3831  913E              OP_POP_AT:
3832  913E                  ;Get Rows
3833  913E                  POP_INT_STACK
3833  913E DD 7E 00    >    ld a, (ix+0)
3833  9141 DD 23       >    inc ix
3834  9143 FE 18            cp 24
3835  9145 38 02            jr c, 1f
3836  9147 3E 17            ld a, 23
3837  9149 47           1:  ld b, a
3838  914A                  ;Get Cols
3839  914A                  POP_INT_STACK
3839  914A DD 7E 00    >    ld a, (ix+0)
3839  914D DD 23       >    inc ix
3840  914F FE 20            cp 32
3841  9151 38 02            jr c, 2f
3842  9153 3E 1F            ld a, 31
3843  9155 E5           2:  push hl
3844  9156 C5               push bc         ;Rows on B
3845  9157 F5               push af         ;Cols on A
3846  9158 CD 46 88         call SET_CURSOR
3847  915B E1               pop hl
3848  915C C3 09 83         jp EXEC_LOOP
3849  915F                  ENDIF
3850  915F              ;============================================
3851  915F
3852  915F                  IFNDEF UNUSED_OP_INK_D
3853  915F              OP_INK_D:
3854  915F 11 09 83         ld de, EXEC_LOOP
3855  9162 D5               push de
3856  9163 7E               ld a, (hl)
3857  9164 23               inc hl
3858  9165 C3 73 87         jp INK
3859  9168                  ENDIF
3860  9168
3861  9168                  IFNDEF UNUSED_OP_PAPER_D
3862  9168              OP_PAPER_D:
3863  9168 11 09 83         ld de, EXEC_LOOP
3864  916B D5               push de
3865  916C 7E               ld a, (hl)
3866  916D 23               inc hl
3867  916E C3 93 87         jp PAPER
3868  9171                  ENDIF
3869  9171
3870  9171                  IFNDEF UNUSED_OP_BRIGHT_D
3871  9171              OP_BRIGHT_D:
3872  9171 7E               ld a, (hl)
3873  9172 23               inc hl
3874  9173 E5               push hl
3875  9174 CD B6 87         call BRIGHT
3876  9177 E1               pop hl
3877  9178 C3 09 83         jp EXEC_LOOP
3878  917B                  ENDIF
3879  917B
3880  917B                  IFNDEF UNUSED_OP_FLASH_D
3881  917B              OP_FLASH_D:
3882  917B 7E               ld a, (hl)
3883  917C 23               inc hl
3884  917D E5               push hl
3885  917E CD D5 87         call FLASH
3886  9181 E1               pop hl
3887  9182 C3 09 83         jp EXEC_LOOP
3888  9185                  ENDIF
3889  9185
3890  9185                  IFNDEF UNUSED_OP_BORDER_D
3891  9185              OP_BORDER_D:
3892  9185 11 09 83         ld de, EXEC_LOOP
3893  9188 D5               push de
3894  9189 7E               ld a, (hl)
3895  918A 23               inc hl
3896  918B C3 58 87         jp BORDER
3897  918E                  ENDIF
3898  918E
3899  918E                  IFNDEF UNUSED_OP_PRINT_D
3900  918E              OP_PRINT_D:
3901  918E 7E               ld a, (hl)
3902  918F 23               inc hl
3903  9190 E5               push hl
3904  9191 CD D1 8B         call PRINT_A_BYTE
3905  9194 E1               pop hl
3906  9195 C3 09 83         jp EXEC_LOOP
3907  9198                  ENDIF
3908  9198
3909  9198                  IFNDEF UNUSED_OP_INK_I
3910  9198              OP_INK_I:
3911  9198 11 09 83         ld de, EXEC_LOOP
3912  919B D5               push de
3913  919C 5E               ld e, (hl)
3914  919D 23               inc hl
3915  919E 16 5D            ld d, HIGH FLAGS
3916  91A0 1A               ld a, (de)
3917  91A1 C3 73 87         jp INK
3918  91A4                  ENDIF
3919  91A4
3920  91A4                  IFNDEF UNUSED_OP_PAPER_I
3921  91A4              OP_PAPER_I:
3922  91A4 11 09 83         ld de, EXEC_LOOP
3923  91A7 D5               push de
3924  91A8 5E               ld e, (hl)
3925  91A9 23               inc hl
3926  91AA 16 5D            ld d, HIGH FLAGS
3927  91AC 1A               ld a, (de)
3928  91AD C3 93 87         jp PAPER
3929  91B0                  ENDIF
3930  91B0
3931  91B0                  IFNDEF UNUSED_OP_BRIGHT_I
3932  91B0              OP_BRIGHT_I:
3933  91B0 5E               ld e, (hl)
3934  91B1 23               inc hl
3935  91B2 16 5D            ld d, HIGH FLAGS
3936  91B4 1A               ld a, (de)
3937  91B5 E5               push hl
3938  91B6 CD B6 87         call BRIGHT
3939  91B9 E1               pop hl
3940  91BA C3 09 83         jp EXEC_LOOP
3941  91BD                  ENDIF
3942  91BD
3943  91BD                  IFNDEF UNUSED_OP_FLASH_I
3944  91BD              OP_FLASH_I:
3945  91BD 5E               ld e, (hl)
3946  91BE 23               inc hl
3947  91BF 16 5D            ld d, HIGH FLAGS
3948  91C1 1A               ld a, (de)
3949  91C2 E5               push hl
3950  91C3 CD D5 87         call FLASH
3951  91C6 E1               pop hl
3952  91C7 C3 09 83         jp EXEC_LOOP
3953  91CA                  ENDIF
3954  91CA
3955  91CA                  IFNDEF UNUSED_OP_BORDER_I
3956  91CA              OP_BORDER_I:
3957  91CA 11 09 83         ld de, EXEC_LOOP
3958  91CD D5               push de
3959  91CE 5E               ld e, (hl)
3960  91CF 23               inc hl
3961  91D0 16 5D            ld d, HIGH FLAGS
3962  91D2 1A               ld a, (de)
3963  91D3 C3 58 87         jp BORDER
3964  91D6                  ENDIF
3965  91D6
3966  91D6                  IFNDEF UNUSED_OP_PRINT_I
3967  91D6              OP_PRINT_I:
3968  91D6 5E               ld e, (hl)
3969  91D7 23               inc hl
3970  91D8 16 5D            ld d, HIGH FLAGS
3971  91DA 1A               ld a, (de)
3972  91DB E5               push hl
3973  91DC CD D1 8B         call PRINT_A_BYTE
3974  91DF E1               pop hl
3975  91E0 C3 09 83         jp EXEC_LOOP
3976  91E3                  ENDIF
3977  91E3
3978  91E3                  IFNDEF UNUSED_OP_POP_INK
3979  91E3              OP_POP_INK:
3980  91E3 11 09 83         ld de, EXEC_LOOP
3981  91E6 D5               push de
3982  91E7                  POP_INT_STACK
3982  91E7 DD 7E 00    >    ld a, (ix+0)
3982  91EA DD 23       >    inc ix
3983  91EC C3 73 87         jp INK
3984  91EF                  ENDIF
3985  91EF
3986  91EF                  IFNDEF UNUSED_OP_POP_PAPER
3987  91EF              OP_POP_PAPER:
3988  91EF 11 09 83         ld de, EXEC_LOOP
3989  91F2 D5               push de
3990  91F3                  POP_INT_STACK
3990  91F3 DD 7E 00    >    ld a, (ix+0)
3990  91F6 DD 23       >    inc ix
3991  91F8 C3 93 87         jp PAPER
3992  91FB                  ENDIF
3993  91FB
3994  91FB                  IFNDEF UNUSED_OP_POP_BRIGHT
3995  91FB              OP_POP_BRIGHT:
3996  91FB                  POP_INT_STACK
3996  91FB DD 7E 00    >    ld a, (ix+0)
3996  91FE DD 23       >    inc ix
3997  9200 E5               push hl
3998  9201 CD B6 87         call BRIGHT
3999  9204 E1               pop hl
4000  9205 C3 09 83         jp EXEC_LOOP
4001  9208                  ENDIF
4002  9208
4003  9208                  IFNDEF UNUSED_OP_POP_FLASH
4004  9208              OP_POP_FLASH:
4005  9208                  POP_INT_STACK
4005  9208 DD 7E 00    >    ld a, (ix+0)
4005  920B DD 23       >    inc ix
4006  920D E5               push hl
4007  920E CD D5 87         call FLASH
4008  9211 E1               pop hl
4009  9212 C3 09 83         jp EXEC_LOOP
4010  9215                  ENDIF
4011  9215
4012  9215                  IFNDEF UNUSED_OP_POP_BORDER
4013  9215              OP_POP_BORDER:
4014  9215 11 09 83         ld de, EXEC_LOOP
4015  9218 D5               push de
4016  9219                  POP_INT_STACK
4016  9219 DD 7E 00    >    ld a, (ix+0)
4016  921C DD 23       >    inc ix
4017  921E C3 58 87         jp BORDER
4018  9221                  ENDIF
4019  9221
4020  9221                  IFNDEF UNUSED_OP_POP_PRINT
4021  9221              OP_POP_PRINT:
4022  9221                  POP_INT_STACK
4022  9221 DD 7E 00    >    ld a, (ix+0)
4022  9224 DD 23       >    inc ix
4023  9226 E5               push hl
4024  9227 CD D1 8B         call PRINT_A_BYTE
4025  922A E1               pop hl
4026  922B C3 09 83         jp EXEC_LOOP
4027  922E                  ENDIF
4028  922E
4029  922E                  IFNDEF UNUSED_OP_MARGINS
4030  922E              OP_MARGINS:
4031  922E
4032  922E 4E               ld c, (hl)       ;PosX
4033  922F 23               inc hl
4034  9230 46               ld b, (hl)       ;PosY
4035  9231 23               inc hl
4036  9232 5E               ld e, (hl)       ;Width
4037  9233 23               inc hl
4038  9234 56               ld d, (hl)       ;Height
4039  9235 23               inc hl
4040  9236 E5               push hl
4041  9237 CD EF 87         call SET_MARGINS
4042  923A CD D6 8C         call SET_BACKSPACE_MARGINS_WIDTH
4043  923D E1               pop hl
4044  923E C3 09 83         jp EXEC_LOOP
4045  9241                  ENDIF
4046  9241
4047  9241                  IFNDEF UNUSED_OP_AT
4048  9241              OP_AT:
4049  9241 46               ld b, (hl)
4050  9242 23               inc hl
4051  9243 7E               ld a, (hl)
4052  9244 23               inc hl
4053  9245 E5               push hl
4054  9246 F5               push af         ;Rows on A
4055  9247 C5               push bc         ;Cols on B
4056  9248 CD 46 88         call SET_CURSOR
4057  924B E1               pop hl
4058  924C C3 09 83         jp EXEC_LOOP
4059  924F                  ENDIF
4060  924F
4061  924F                  IFNDEF UNUSED_OP_CENTER
4062  924F              OP_CENTER:
4063  924F 11 09 83         ld de, EXEC_LOOP
4064  9252 D5               push de
4065  9253 C3 44 8A         jp CENTER
4066  9256                  ENDIF
4067  9256
4068  9256                  IFNDEF UNUSED_OP_PICTURE_D
4069  9256              OP_PICTURE_D:
4070  9256 7E               ld a, (hl)
4071  9257 23               inc hl
4072  9258 E5               push hl
4073  9259 CD 4C 86         call IMG_LOAD
4074  925C E1               pop hl
4075  925D C3 09 83         jp EXEC_LOOP
4076  9260                  ENDIF
4077  9260
4078  9260                  IFNDEF UNUSED_OP_DISPLAY_D
4079  9260              OP_DISPLAY_D:
4080  9260 7E               ld a, (hl)
4081  9261 23               inc hl
4082  9262 B7               or a
4083  9263 CA 09 83         jp z, EXEC_LOOP
4084  9266 E5               push hl
4085  9267 CD C9 86         call COPY_SCREEN
4086  926A E1               pop hl
4087  926B C3 09 83         jp EXEC_LOOP
4088  926E                  ENDIF
4089  926E
4090  926E                  IFNDEF UNUSED_OP_PICTURE_I
4091  926E              OP_PICTURE_I:
4092  926E 5E               ld e, (hl)
4093  926F 23               inc hl
4094  9270 16 5D            ld d, HIGH FLAGS
4095  9272 1A               ld a, (de)
4096  9273 E5               push hl
4097  9274 CD 4C 86         call IMG_LOAD
4098  9277 E1               pop hl
4099  9278 C3 09 83         jp EXEC_LOOP
4100  927B                  ENDIF
4101  927B
4102  927B                  IFNDEF UNUSED_OP_DISPLAY_I
4103  927B              OP_DISPLAY_I:
4104  927B 5E               ld e, (hl)
4105  927C 23               inc hl
4106  927D 16 5D            ld d, HIGH FLAGS
4107  927F 1A               ld a, (de)
4108  9280 B7               or a
4109  9281 CA 09 83         jp z, EXEC_LOOP
4110  9284 E5               push hl
4111  9285 CD C9 86         call COPY_SCREEN
4112  9288 E1               pop hl
4113  9289 C3 09 83         jp EXEC_LOOP
4114  928C                  ENDIF
4115  928C
4116  928C                  IFNDEF UNUSED_OP_POP_PICTURE
4117  928C              OP_POP_PICTURE:
4118  928C                  POP_INT_STACK
4118  928C DD 7E 00    >    ld a, (ix+0)
4118  928F DD 23       >    inc ix
4119  9291 E5               push hl
4120  9292 CD 4C 86         call IMG_LOAD
4121  9295 E1               pop hl
4122  9296 C3 09 83         jp EXEC_LOOP
4123  9299                  ENDIF
4124  9299
4125  9299                  IFNDEF UNUSED_OP_POP_DISPLAY
4126  9299              OP_POP_DISPLAY:
4127  9299                  POP_INT_STACK
4127  9299 DD 7E 00    >    ld a, (ix+0)
4127  929C DD 23       >    inc ix
4128  929E B7               or a
4129  929F CA 09 83         jp z, EXEC_LOOP
4130  92A2 E5               push hl
4131  92A3 CD C9 86         call COPY_SCREEN
4132  92A6 E1               pop hl
4133  92A7 C3 09 83         jp EXEC_LOOP
4134  92AA                  ENDIF
4135  92AA
4136  92AA                  IFNDEF UNUSED_OP_WAIT
4137  92AA              OP_WAIT:
4138  92AA 5E               ld e, (hl)
4139  92AB 23               inc hl
4140  92AC 56               ld d, (hl)
4141  92AD 23               inc hl
4142  92AE ED 53 3C 80      ld (DOWN_COUNTER), de
4143  92B2              .wait:
4144  92B2 ED 5B 3C 80      ld de, (DOWN_COUNTER)
4145  92B6 7A               ld a, d
4146  92B7 B3               or e
4147  92B8 20 F8            jr nz, .wait
4148  92BA C3 09 83         jp EXEC_LOOP
4149  92BD                  ENDIF
4150  92BD
4151  92BD                  IFNDEF UNUSED_OP_OPTION
4152  92BD              OP_OPTION:
4153  92BD 3A A4 5F         ld a, (NUM_OPTIONS)
4154  92C0 FE 20            cp 32    ;test if number of options is MAX4
4155  92C2 38 05            jr c,.option_ok
4156  92C4 3E 02            ld a, 2
4157  92C6 C3 00 9F         jp SYS_ERROR
4158  92C9              .option_ok:
4159  92C9 E5               push hl                    ;Store pointer
4160  92CA 3A AA 5F         ld a, (OPTION_BULLET_ENABLED)
4161  92CD B7               or a
4162  92CE 28 0F            jr z, 1f
4163  92D0 CD 25 8C         call ADJUST_CHAR_POS  ;Advance to the best position for printing the choice
4164  92D3 D5               push de
4165  92D4 D5               push de                    ; ; d = POS_Y, e = POS_X
4166  92D5 3E 7F            ld a, NO_SELECTED_BULLET
4167  92D7 CD EA 88         call GET_CHARACTER_POINTER  ;Get character pointer
4168  92DA D1               pop de
4169  92DB CD 51 8C         call PUT_8X8_CHAR           ; Print the character
4170  92DE D1               pop de
4171  92DF 3A A4 5F     1:  ld a, (NUM_OPTIONS)
4172  92E2 CB 27            sla a
4173  92E4 CB 27            sla a
4174  92E6 CB 27            sla a
4175  92E8 6F               ld l, a
4176  92E9 26 5E            ld h, HIGH OPTIONS_TABLE
4177  92EB 73               ld (hl), e             ;Store screen pos
4178  92EC 23               inc hl
4179  92ED 72               ld (hl), d
4180  92EE 23               inc hl
4181  92EF 3A A4 5F         ld a, (NUM_OPTIONS)
4182  92F2 77               ld (hl), a             ;Storing num option as default value
4183  92F3 23               inc hl
4184  92F4 3C               inc a
4185  92F5 32 A4 5F         ld (NUM_OPTIONS), a   ;Increment options
4186  92F8 EB               ex de, hl              ;Move option table address to DE
4187  92F9 E1               pop hl
4188  92FA ED A0            ldi                    ;Copy Address to address table
4189  92FC ED A0            ldi
4190  92FE ED A0            ldi
4191  9300 ED A0            ldi
4192  9302 C3 09 83         jp EXEC_LOOP
4193  9305                  ENDIF
4194  9305
4195  9305                  IFNDEF UNUSED_OP_POP_VAL_OPTION
4196  9305              OP_POP_VAL_OPTION:
4197  9305 3A A4 5F         ld a, (NUM_OPTIONS)
4198  9308 FE 20            cp 32    ;test if number of options is MAX4
4199  930A 38 05            jr c,.option_ok
4200  930C 3E 02            ld a, 2
4201  930E C3 00 9F         jp SYS_ERROR
4202  9311              .option_ok:
4203  9311 E5               push hl                    ;Store pointer
4204  9312 3A AA 5F         ld a, (OPTION_BULLET_ENABLED)
4205  9315 B7               or a
4206  9316 28 0F            jr z, 1f
4207  9318 CD 25 8C         call ADJUST_CHAR_POS  ;Advance to the best position for printing the choice
4208  931B D5               push de
4209  931C D5               push de                    ; ; d = POS_Y, e = POS_X
4210  931D 3E 7F            ld a, NO_SELECTED_BULLET
4211  931F CD EA 88         call GET_CHARACTER_POINTER  ;Get character pointer
4212  9322 D1               pop de
4213  9323 CD 51 8C         call PUT_8X8_CHAR           ; Print the character
4214  9326 D1               pop de
4215  9327 3A A4 5F     1:  ld a, (NUM_OPTIONS)
4216  932A F5               push af
4217  932B CB 27            sla a
4218  932D CB 27            sla a
4219  932F CB 27            sla a
4220  9331 6F               ld l, a
4221  9332 26 5E            ld h, HIGH OPTIONS_TABLE
4222  9334 73               ld (hl), e             ;Store screen pos
4223  9335 23               inc hl
4224  9336 72               ld (hl), d
4225  9337 23               inc hl
4226  9338 F1               pop af
4227  9339 3C               inc a
4228  933A 32 A4 5F         ld (NUM_OPTIONS), a   ;Increment options
4229  933D                  POP_INT_STACK
4229  933D DD 7E 00    >    ld a, (ix+0)
4229  9340 DD 23       >    inc ix
4230  9342 77               ld (hl), a             ;Storing value from stack
4231  9343 23               inc hl
4232  9344 EB               ex de, hl              ;Move option table address to DE
4233  9345 E1               pop hl
4234  9346 ED A0            ldi                    ;Copy Address to address table
4235  9348 ED A0            ldi
4236  934A ED A0            ldi
4237  934C ED A0            ldi
4238  934E C3 09 83         jp EXEC_LOOP
4239  9351                  ENDIF
4240  9351
4241  9351                  IFNDEF UNUSED_OP_WAITKEY
4242  9351              OP_WAITKEY:
4243  9351 E5               push hl                          ;Save pointer
4244  9352 CD 43 8C         call ADJUST_CHAR_POS_NO_ADVANCE  ;Advance to the best position for printing the choice
4245  9355 E5               push hl
4246  9356 E5               push hl                     ;d = POS_Y, e = POS_X
4247  9357 3E 88            ld a, WAIT_TO_KEY_BULLET
4248  9359 CD EA 88         call GET_CHARACTER_POINTER  ;Get character pointer
4249  935C D1               pop de
4250  935D CD 51 8C         call PUT_8X8_CHAR           ; Print the character
4251  9360 D1               pop de
4252  9361 CD EB 83     1:  call INKEY_MENU
4253  9364 E6 10            and KEYPRESS_FIRE
4254  9366 20 12            jr nz, .keyp
4255  9368              .animate_bullet:
4256  9368 D5               push de
4257  9369 3A AB 5F         ld a, (CYCLE_OPTION)
4258  936C C6 88            add a, WAIT_TO_KEY_BULLET
4259  936E D5               push de
4260  936F CD EA 88         call GET_CHARACTER_POINTER
4261  9372 D1               pop de
4262  9373 76               halt
4263  9374 CD 51 8C         call PUT_8X8_CHAR
4264  9377 D1               pop de
4265  9378 18 E7            jr 1b
4266  937A              .keyp:
4267  937A D5               push de
4268  937B D5               push de                     ;d = POS_Y, e = POS_X
4269  937C 3E 20            ld a, 32
4270  937E CD EA 88         call GET_CHARACTER_POINTER  ;Get character pointer
4271  9381 D1               pop de
4272  9382 CD 51 8C         call PUT_8X8_CHAR           ; Print the character
4273  9385 D1               pop de
4274  9386 ED 53 B7 5F      ld (POS_X), de
4275  938A CD EB 83     2:  call INKEY_MENU
4276  938D B7               or a
4277  938E 20 FA            jr nz, 2b
4278  9390                  ;xor a
4279  9390 32 BD 5F         ld (PRINTED_LINES), a
4280  9393 E1               pop hl
4281  9394 C3 09 83         jp EXEC_LOOP
4282  9397                  ENDIF
4283  9397
4284  9397                  IFNDEF UNUSED_OP_PAUSE
4285  9397              OP_PAUSE:
4286  9397 5E               ld e, (hl)
4287  9398 23               inc hl
4288  9399 56               ld d, (hl)
4289  939A 23               inc hl
4290  939B E5               push hl                     ;Save pointer
4291  939C ED 53 3C 80      ld (DOWN_COUNTER), de
4292  93A0 CD 43 8C         call ADJUST_CHAR_POS_NO_ADVANCE    ;Advance to the best position for printing the choice
4293  93A3 E5               push hl
4294  93A4 E5               push hl                     ;d = POS_Y, e = POS_X
4295  93A5 3E 88            ld a, WAIT_TO_KEY_BULLET
4296  93A7 CD EA 88         call GET_CHARACTER_POINTER  ;Get character pointer
4297  93AA D1               pop de
4298  93AB CD 51 8C         call PUT_8X8_CHAR           ; Print the character
4299  93AE D1               pop de
4300  93AF CD EB 83     1:  call INKEY_MENU
4301  93B2 E6 10            and KEYPRESS_FIRE
4302  93B4 20 1A            jr nz, .keyp
4303  93B6 ED 4B 3C 80      ld bc, (DOWN_COUNTER)
4304  93BA 78               ld a, b
4305  93BB B1               or c
4306  93BC 28 12            jr z, .keyp
4307  93BE              .animate_bullet:
4308  93BE D5               push de
4309  93BF 3A AB 5F         ld a, (CYCLE_OPTION)
4310  93C2 C6 88            add a, WAIT_TO_KEY_BULLET
4311  93C4 D5               push de
4312  93C5 CD EA 88         call GET_CHARACTER_POINTER
4313  93C8 D1               pop de
4314  93C9 76               halt
4315  93CA CD 51 8C         call PUT_8X8_CHAR
4316  93CD D1               pop de
4317  93CE 18 DF            jr 1b
4318  93D0              .keyp:
4319  93D0 D5               push de
4320  93D1 D5               push de                     ;d = POS_Y, e = POS_X
4321  93D2 3E 20            ld a, 32
4322  93D4 CD EA 88         call GET_CHARACTER_POINTER  ;Get character pointer
4323  93D7 D1               pop de
4324  93D8 CD 51 8C         call PUT_8X8_CHAR           ; Print the character
4325  93DB D1               pop de
4326  93DC ED 53 B7 5F      ld (POS_X), de
4327  93E0 CD EB 83     2:  call INKEY_MENU
4328  93E3 B7               or a
4329  93E4 20 FA            jr nz, 2b
4330  93E6                  ;xor a
4331  93E6 32 BD 5F         ld (PRINTED_LINES), a
4332  93E9 E1               pop hl
4333  93EA C3 09 83         jp EXEC_LOOP
4334  93ED                  ENDIF
4335  93ED
4336  93ED                  IFNDEF UNUSED_OP_CHOOSE
4337  93ED              OP_CHOOSE:
4338  93ED 22 F8 94         ld (.self_a), hl
4339  93F0 3A A9 5F         ld a, (DEFAULT_OPTION)
4340  93F3 32 A5 5F         ld (SELECTED_OPTION), a
4341  93F6 3A A4 5F         ld a, (NUM_OPTIONS)
4342  93F9 B7               or a
4343  93FA C2 02 94         jp nz, .options         ; No options available
4344  93FD 3E 03            ld a, 3
4345  93FF C3 00 9F         jp SYS_ERROR
4346  9402              .options:
4347  9402 3E 80            ld a, SELECTED_BULLET
4348  9404 CD 8B 8A         call PRINT_SELECTED_OPTION_BULLET
4349  9407              .inkey:
4350  9407 CD EB 83         call INKEY_MENU
4351  940A 0F               rrca
4352  940B DA 4A 94         jp c, .right
4353  940E 0F               rrca
4354  940F DA 23 94         jp c, .left
4355  9412 0F               rrca
4356  9413 DA A2 94         jp c, .down
4357  9416 0F               rrca
4358  9417 DA 7B 94         jp c, .up
4359  941A 0F               rrca
4360  941B DA D3 94         jp c, .selected
4361  941E CD B9 8A         call ANIMATE_OPTION_BULLET
4362  9421 18 E4            jr .inkey
4363  9423              .left:
4364  9423 3A A5 5F         ld a, (SELECTED_OPTION)
4365  9426 B7               or a
4366  9427 CA 07 94         jp z, .inkey
4367  942A F5               push af
4368  942B 3E 7F            ld a, NO_SELECTED_BULLET
4369  942D CD 8B 8A         call PRINT_SELECTED_OPTION_BULLET
4370  9430 3A A7 5F         ld a, (INCR_X_OPTION)
4371  9433 47               ld b, a
4372  9434 F1               pop af
4373  9435 90               sub b
4374  9436 DA 07 94         jp c, .inkey
4375  9439 32 A5 5F         ld (SELECTED_OPTION), a
4376  943C 3E 80            ld a, SELECTED_BULLET
4377  943E CD 8B 8A         call PRINT_SELECTED_OPTION_BULLET
4378  9441 CD EB 83     3:  call INKEY_MENU
4379  9444 B7               or a
4380  9445 CA 07 94         jp z, .inkey
4381  9448 18 F7            jr 3b
4382  944A              .right:
4383  944A 3A A4 5F         ld a, (NUM_OPTIONS)
4384  944D 4F               ld c, a
4385  944E 0D               dec c
4386  944F 3A A5 5F         ld a, (SELECTED_OPTION)
4387  9452 B9               cp c                        ; selected_option-numoptions
4388  9453 D2 07 94         jp nc, .inkey
4389  9456 F5               push af
4390  9457 3E 7F            ld a, NO_SELECTED_BULLET
4391  9459 CD 8B 8A         call PRINT_SELECTED_OPTION_BULLET
4392  945C 3A A4 5F         ld a, (NUM_OPTIONS)
4393  945F 4F               ld c, a
4394  9460 3A A7 5F         ld a, (INCR_X_OPTION)
4395  9463 47               ld b, a
4396  9464 F1               pop af
4397  9465 80               add a, b
4398  9466 B9               cp c
4399  9467 D2 07 94         jp nc, .inkey
4400  946A 32 A5 5F         ld (SELECTED_OPTION), a
4401  946D 3E 80            ld a, SELECTED_BULLET
4402  946F CD 8B 8A         call PRINT_SELECTED_OPTION_BULLET
4403  9472 CD EB 83     4:  call INKEY_MENU
4404  9475 B7               or a
4405  9476 CA 07 94         jp z, .inkey
4406  9479 18 F7            jr 4b
4407  947B              .up:
4408  947B 3A A5 5F         ld a, (SELECTED_OPTION)
4409  947E B7               or a
4410  947F CA 07 94         jp z, .inkey
4411  9482 F5               push af
4412  9483 3E 7F            ld a, NO_SELECTED_BULLET
4413  9485 CD 8B 8A         call PRINT_SELECTED_OPTION_BULLET
4414  9488 3A A8 5F         ld a, (INCR_Y_OPTION)
4415  948B 47               ld b, a
4416  948C F1               pop af
4417  948D 90               sub b
4418  948E DA 07 94         jp c, .inkey
4419  9491 32 A5 5F         ld (SELECTED_OPTION), a
4420  9494 3E 80            ld a, SELECTED_BULLET
4421  9496 CD 8B 8A         call PRINT_SELECTED_OPTION_BULLET
4422  9499 CD EB 83     2:  call INKEY_MENU
4423  949C B7               or a
4424  949D CA 07 94         jp z, .inkey
4425  94A0 18 F7            jr 2b
4426  94A2              .down:
4427  94A2 3A A4 5F         ld a, (NUM_OPTIONS)
4428  94A5 4F               ld c, a
4429  94A6 0D               dec c
4430  94A7 3A A5 5F         ld a, (SELECTED_OPTION)
4431  94AA B9               cp c                        ; selected_option-numoptions
4432  94AB D2 07 94         jp nc, .inkey
4433  94AE F5               push af
4434  94AF 3E 7F            ld a, NO_SELECTED_BULLET
4435  94B1 CD 8B 8A         call PRINT_SELECTED_OPTION_BULLET
4436  94B4 3A A4 5F         ld a, (NUM_OPTIONS)
4437  94B7 4F               ld c, a
4438  94B8 3A A8 5F         ld a, (INCR_Y_OPTION)
4439  94BB 47               ld b, a
4440  94BC F1               pop af
4441  94BD 80               add a, b
4442  94BE B9               cp c                        ; selected_option-numoptions
4443  94BF D2 07 94         jp nc, .inkey
4444  94C2 32 A5 5F         ld (SELECTED_OPTION), a
4445  94C5 3E 80            ld a, SELECTED_BULLET
4446  94C7 CD 8B 8A         call PRINT_SELECTED_OPTION_BULLET
4447  94CA CD EB 83     3:  call INKEY_MENU
4448  94CD B7               or a
4449  94CE CA 07 94         jp z, .inkey
4450  94D1 18 F7            jr 3b
4451  94D3              .selected:
4452  94D3 3A A5 5F         ld a, (SELECTED_OPTION)
4453  94D6 CB 27            sla a
4454  94D8 CB 27            sla a
4455  94DA CB 27            sla a
4456  94DC C6 02            add a, 2
4457  94DE 6F               ld l, a
4458  94DF 26 5E            ld h, HIGH OPTIONS_TABLE
4459  94E1 AF               xor a
4460  94E2 32 A4 5F         ld (NUM_OPTIONS), a
4461  94E5 CD EB 83     5:  call INKEY_MENU
4462  94E8 B7               or a
4463  94E9 20 FA            jr nz, 5b
4464  94EB 7E               ld a, (hl)      ;Store selected option value
4465  94EC 23               inc hl
4466  94ED 32 A6 5F         ld (SELECTED_OPTION_VALUE), a
4467  94F0 7E               ld a, (hl)
4468  94F1 23               inc hl
4469  94F2 B7               or a
4470  94F3 CA ED 8E         jp z, OP_GOTO
4471  94F6 E5               push hl
4472  94F7              .self_a+1:
4473  94F7 21 00 00         ld hl, 0-0
4474  94FA 3A BE 5F         ld a, (CHUNK)
4475  94FD DD 75 FF         ld (ix-1), l
4476  9500 DD 74 FE         ld (ix-2), h
4477  9503 DD 77 FD         ld (ix-3), a
4478  9506 11 FD FF         ld de, 65536-3    ; ix-3
4479  9509 DD 19            add ix, de
4480  950B E1               pop hl
4481  950C C3 ED 8E         jp OP_GOTO
4482  950F                  ENDIF
4483  950F
4484  950F              ;----------------------------------------------
4485  950F
4486  950F                  IFNDEF UNUSED_OP_CHOOSE_W
4487  950F              OP_CHOOSE_W:
4488  950F
4489  950F 5E               ld e, (hl)
4490  9510 23               inc hl
4491  9511 56               ld d, (hl)
4492  9512 23               inc hl
4493  9513
4494  9513 D5               push de            ;Save timeout
4495  9514
4496  9514 11 00 5F         ld de, TIMEOUT_OPTION
4497  9517 ED A0            ldi
4498  9519 ED A0            ldi
4499  951B ED A0            ldi
4500  951D ED A0            ldi
4501  951F
4502  951F D1               pop de           ;Restore timeout
4503  9520
4504  9520 3A A9 5F         ld a, (DEFAULT_OPTION)
4505  9523 32 A5 5F         ld (SELECTED_OPTION), a
4506  9526 3A A4 5F         ld a, (NUM_OPTIONS)
4507  9529 B7               or a
4508  952A C2 32 95         jp nz, .options         ; No options available
4509  952D 3E 03            ld a, 3
4510  952F C3 00 9F         jp SYS_ERROR
4511  9532
4512  9532              .options:
4513  9532 ED 53 3C 80      ld (DOWN_COUNTER), de
4514  9536 3E 7F            ld a, NO_SELECTED_BULLET
4515  9538 CD 8B 8A         call PRINT_SELECTED_OPTION_BULLET
4516  953B              .inkey:
4517  953B CD EB 83         call INKEY_MENU
4518  953E 0F               rrca
4519  953F DA 87 95         jp c, .right
4520  9542 0F               rrca
4521  9543 DA 60 95         jp c, .left
4522  9546 0F               rrca
4523  9547 DA DF 95         jp c, .down
4524  954A 0F               rrca
4525  954B DA B8 95         jp c, .up
4526  954E 0F               rrca
4527  954F DA 1D 96         jp c, .selected
4528  9552 ED 4B 3C 80      ld bc, (DOWN_COUNTER)
4529  9556 79               ld a, c
4530  9557 B0               or b
4531  9558 CA 10 96         jp z, .count_elapsed
4532  955B CD B9 8A         call ANIMATE_OPTION_BULLET
4533  955E                  ;jr 1b
4534  955E 18 DB            jr .inkey
4535  9560              .left:
4536  9560 3A A5 5F         ld a, (SELECTED_OPTION)
4537  9563 B7               or a
4538  9564 CA 3B 95         jp z, .inkey
4539  9567 F5               push af
4540  9568 3E 7F            ld a, NO_SELECTED_BULLET
4541  956A CD 8B 8A         call PRINT_SELECTED_OPTION_BULLET
4542  956D 3A A7 5F         ld a, (INCR_X_OPTION)
4543  9570 47               ld b, a
4544  9571 F1               pop af
4545  9572 90               sub b
4546  9573 DA 3B 95         jp c, .inkey
4547  9576 32 A5 5F         ld (SELECTED_OPTION), a
4548  9579 3E 80            ld a, SELECTED_BULLET
4549  957B CD 8B 8A         call PRINT_SELECTED_OPTION_BULLET
4550  957E CD EB 83     3:  call INKEY_MENU
4551  9581 B7               or a
4552  9582 CA 3B 95         jp z, .inkey
4553  9585 18 F7            jr 3b
4554  9587              .right:
4555  9587 3A A4 5F         ld a, (NUM_OPTIONS)
4556  958A 4F               ld c, a
4557  958B 0D               dec c
4558  958C 3A A5 5F         ld a, (SELECTED_OPTION)
4559  958F B9               cp c                        ; selected_option-numoptions
4560  9590 D2 3B 95         jp nc, .inkey
4561  9593 F5               push af
4562  9594 3E 7F            ld a, NO_SELECTED_BULLET
4563  9596 CD 8B 8A         call PRINT_SELECTED_OPTION_BULLET
4564  9599 3A A4 5F         ld a, (NUM_OPTIONS)
4565  959C 4F               ld c, a
4566  959D 3A A7 5F         ld a, (INCR_X_OPTION)
4567  95A0 47               ld b, a
4568  95A1 F1               pop af
4569  95A2 80               add a, b
4570  95A3 B9               cp c
4571  95A4 D2 3B 95         jp nc, .inkey
4572  95A7 32 A5 5F         ld (SELECTED_OPTION), a
4573  95AA 3E 80            ld a, SELECTED_BULLET
4574  95AC CD 8B 8A         call PRINT_SELECTED_OPTION_BULLET
4575  95AF CD EB 83     4:  call INKEY_MENU
4576  95B2 B7               or a
4577  95B3 CA 3B 95         jp z, .inkey
4578  95B6 18 F7            jr 4b
4579  95B8              .up:
4580  95B8 3A A5 5F         ld a, (SELECTED_OPTION)
4581  95BB B7               or a
4582  95BC CA 3B 95         jp z, .inkey
4583  95BF F5               push af
4584  95C0 3E 7F            ld a, NO_SELECTED_BULLET
4585  95C2 CD 8B 8A         call PRINT_SELECTED_OPTION_BULLET
4586  95C5 3A A8 5F         ld a, (INCR_Y_OPTION)
4587  95C8 47               ld b, a
4588  95C9 F1               pop af
4589  95CA 90               sub b
4590  95CB DA 3B 95         jp c, .inkey
4591  95CE 32 A5 5F         ld (SELECTED_OPTION), a
4592  95D1 3E 80            ld a, SELECTED_BULLET
4593  95D3 CD 8B 8A         call PRINT_SELECTED_OPTION_BULLET
4594  95D6 CD EB 83     2:  call INKEY_MENU
4595  95D9 B7               or a
4596  95DA CA 3B 95         jp z, .inkey
4597  95DD 18 F7            jr 2b
4598  95DF              .down:
4599  95DF 3A A4 5F         ld a, (NUM_OPTIONS)
4600  95E2 4F               ld c, a
4601  95E3 0D               dec c
4602  95E4 3A A5 5F         ld a, (SELECTED_OPTION)
4603  95E7 B9               cp c                        ; selected_option-numoptions
4604  95E8 D2 3B 95         jp nc, .inkey
4605  95EB F5               push af
4606  95EC 3E 7F            ld a, NO_SELECTED_BULLET
4607  95EE CD 8B 8A         call PRINT_SELECTED_OPTION_BULLET
4608  95F1 3A A4 5F         ld a, (NUM_OPTIONS)
4609  95F4 4F               ld c, a
4610  95F5 3A A8 5F         ld a, (INCR_Y_OPTION)
4611  95F8 47               ld b, a
4612  95F9 F1               pop af
4613  95FA 80               add a, b
4614  95FB B9               cp c                        ; selected_option-numoptions
4615  95FC D2 3B 95         jp nc, .inkey
4616  95FF 32 A5 5F         ld (SELECTED_OPTION), a
4617  9602 3E 80            ld a, SELECTED_BULLET
4618  9604 CD 8B 8A         call PRINT_SELECTED_OPTION_BULLET
4619  9607 CD EB 83     3:  call INKEY_MENU
4620  960A B7               or a
4621  960B CA 3B 95         jp z, .inkey
4622  960E 18 F7            jr 3b
4623  9610              .count_elapsed:
4624  9610 3E FF            ld a, $FF
4625  9612 32 A5 5F         ld (SELECTED_OPTION), a
4626  9615 32 A6 5F         ld (SELECTED_OPTION_VALUE), a
4627  9618 21 00 5F         ld hl, TIMEOUT_OPTION
4628  961B 18 13            jr 3f
4629  961D              .selected:
4630  961D 3A A5 5F         ld a, (SELECTED_OPTION)
4631  9620 CB 27            sla a
4632  9622 CB 27            sla a
4633  9624 CB 27            sla a
4634  9626 C6 02            add a, 2
4635  9628 6F               ld l, a
4636  9629 26 5E            ld h, HIGH OPTIONS_TABLE
4637  962B 7E               ld a, (hl)      ;Store selected option value
4638  962C 23               inc hl
4639  962D 32 A6 5F         ld (SELECTED_OPTION_VALUE), a
4640  9630 4E           3:  ld c, (hl)               ;C= if is GOSUB
4641  9631 23               inc hl
4642  9632 AF               xor a
4643  9633 32 A4 5F         ld (NUM_OPTIONS), a
4644  9636 CD EB 83     4:  call INKEY_MENU
4645  9639 B7               or a
4646  963A 20 FA            jr nz, 4b
4647  963C 79               ld a, c
4648  963D B7               or a
4649  963E CA ED 8E         jp z, OP_GOTO
4650  9641 C3 02 8F         jp OP_GOSUB
4651  9644                  ENDIF
4652  9644
4653  9644              ;----------------------------------------------
4654  9644
4655  9644                  IFNDEF UNUSED_OP_CHOOSE_CH
4656  9644              OP_CHOOSE_CH:
4657  9644 3A AC 5F         ld a, (RETURN_FROM_CHOOSE_CH)
4658  9647 B7               or a
4659  9648 20 25            jr nz, .no_store_ret_addr
4660  964A 3C               inc a                           ;Sets a to 1
4661  964B 11 AC 5F         ld de, RETURN_FROM_CHOOSE_CH
4662  964E 12               ld (de), a                      ;Store 1 at RETURN_FROM_CHOOSE_CH (when we return here, skip this)
4663  964F 13               inc de
4664  9650 2B               dec hl                          ;Returns to previous position
4665  9651 EB               ex de, hl
4666  9652 3A BE 5F         ld a, (CHUNK)
4667  9655 77               ld (hl), a
4668  9656 23               inc hl
4669  9657 73               ld (hl), e
4670  9658 23               inc hl
4671  9659 72               ld (hl), d
4672  965A 23               inc hl
4673  965B EB               ex de, hl
4674  965C 23               inc hl                         ;restore IP to current position
4675  965D                  ;read destination address for change
4676  965D ED A0            ldi
4677  965F ED A0            ldi
4678  9661 ED A0            ldi
4679  9663 3A A9 5F         ld a, (DEFAULT_OPTION)
4680  9666 32 A5 5F         ld (SELECTED_OPTION), a        ;Resets selected option
4681  9669 22 74 97         ld (.self_a), hl
4682  966C C3 8B 97         jp .on_change_gosub
4683  966F              .no_store_ret_addr:
4684  966F 3A A4 5F         ld a, (NUM_OPTIONS)
4685  9672 B7               or a
4686  9673 C2 7B 96         jp nz, .options       ; No options available
4687  9676 3E 03            ld a, 3
4688  9678 C3 00 9F         jp SYS_ERROR
4689  967B              .options:
4690  967B 3E 80            ld a, SELECTED_BULLET
4691  967D CD 8B 8A         call PRINT_SELECTED_OPTION_BULLET
4692  9680              .inkey:
4693  9680 CD EB 83         call INKEY_MENU
4694  9683 0F               rrca
4695  9684 DA C3 96         jp c, .right
4696  9687 0F               rrca
4697  9688 DA 9C 96         jp c, .left
4698  968B 0F               rrca
4699  968C DA 1B 97         jp c, .down
4700  968F 0F               rrca
4701  9690 DA F4 96         jp c, .up
4702  9693 0F               rrca
4703  9694 DA 4C 97         jp c, .selected
4704  9697 CD B9 8A         call ANIMATE_OPTION_BULLET
4705  969A 18 E4            jr .inkey
4706  969C              .left:
4707  969C 3A A5 5F         ld a, (SELECTED_OPTION)
4708  969F B7               or a
4709  96A0 CA 80 96         jp z, .inkey
4710  96A3 F5               push af
4711  96A4 3E 7F            ld a, NO_SELECTED_BULLET
4712  96A6 CD 8B 8A         call PRINT_SELECTED_OPTION_BULLET
4713  96A9 3A A7 5F         ld a, (INCR_X_OPTION)
4714  96AC 47               ld b, a
4715  96AD F1               pop af
4716  96AE 90               sub b
4717  96AF DA 80 96         jp c, .inkey
4718  96B2 32 A5 5F         ld (SELECTED_OPTION), a
4719  96B5 3E 80            ld a, SELECTED_BULLET
4720  96B7 CD 8B 8A         call PRINT_SELECTED_OPTION_BULLET
4721  96BA CD EB 83     3:  call INKEY_MENU
4722  96BD B7               or a
4723  96BE CA 8B 97         jp z, .on_change_gosub
4724  96C1 18 F7            jr 3b
4725  96C3              .right:
4726  96C3 3A A4 5F         ld a, (NUM_OPTIONS)
4727  96C6 4F               ld c, a
4728  96C7 0D               dec c
4729  96C8 3A A5 5F         ld a, (SELECTED_OPTION)
4730  96CB B9               cp c                        ; selected_option-numoptions
4731  96CC D2 80 96         jp nc, .inkey
4732  96CF F5               push af
4733  96D0 3E 7F            ld a, NO_SELECTED_BULLET
4734  96D2 CD 8B 8A         call PRINT_SELECTED_OPTION_BULLET
4735  96D5 3A A4 5F         ld a, (NUM_OPTIONS)
4736  96D8 4F               ld c, a
4737  96D9 3A A7 5F         ld a, (INCR_X_OPTION)
4738  96DC 47               ld b, a
4739  96DD F1               pop af
4740  96DE 80               add a, b
4741  96DF B9               cp c
4742  96E0 D2 80 96         jp nc, .inkey
4743  96E3 32 A5 5F         ld (SELECTED_OPTION), a
4744  96E6 3E 80            ld a, SELECTED_BULLET
4745  96E8 CD 8B 8A         call PRINT_SELECTED_OPTION_BULLET
4746  96EB CD EB 83     4:  call INKEY_MENU
4747  96EE B7               or a
4748  96EF CA 8B 97         jp z, .on_change_gosub
4749  96F2 18 F7            jr 4b
4750  96F4              .up:
4751  96F4 3A A5 5F         ld a, (SELECTED_OPTION)
4752  96F7 B7               or a
4753  96F8 CA 80 96         jp z, .inkey
4754  96FB F5               push af
4755  96FC 3E 7F            ld a, NO_SELECTED_BULLET
4756  96FE CD 8B 8A         call PRINT_SELECTED_OPTION_BULLET
4757  9701 3A A8 5F         ld a, (INCR_Y_OPTION)
4758  9704 47               ld b, a
4759  9705 F1               pop af
4760  9706 90               sub b
4761  9707 DA 80 96         jp c, .inkey
4762  970A 32 A5 5F         ld (SELECTED_OPTION), a
4763  970D 3E 80            ld a, SELECTED_BULLET
4764  970F CD 8B 8A         call PRINT_SELECTED_OPTION_BULLET
4765  9712 CD EB 83     2:  call INKEY_MENU
4766  9715 B7               or a
4767  9716 CA 8B 97         jp z, .on_change_gosub
4768  9719 18 F7            jr 2b
4769  971B              .down:
4770  971B 3A A4 5F         ld a, (NUM_OPTIONS)
4771  971E 4F               ld c, a
4772  971F 0D               dec c
4773  9720 3A A5 5F         ld a, (SELECTED_OPTION)
4774  9723 B9               cp c                        ; selected_option-numoptions
4775  9724 D2 80 96         jp nc, .inkey
4776  9727 F5               push af
4777  9728 3E 7F            ld a, NO_SELECTED_BULLET
4778  972A CD 8B 8A         call PRINT_SELECTED_OPTION_BULLET
4779  972D 3A A4 5F         ld a, (NUM_OPTIONS)
4780  9730 4F               ld c, a
4781  9731 3A A8 5F         ld a, (INCR_Y_OPTION)
4782  9734 47               ld b, a
4783  9735 F1               pop af
4784  9736 80               add a, b
4785  9737 B9               cp c                        ; selected_option-numoptions
4786  9738 D2 80 96         jp nc, .inkey
4787  973B 32 A5 5F         ld (SELECTED_OPTION), a
4788  973E 3E 80            ld a, SELECTED_BULLET
4789  9740 CD 8B 8A         call PRINT_SELECTED_OPTION_BULLET
4790  9743 CD EB 83     3:  call INKEY_MENU
4791  9746 B7               or a
4792  9747 CA 8B 97         jp z, .on_change_gosub
4793  974A 18 F7            jr 3b
4794  974C              .selected:
4795  974C 3A A5 5F         ld a, (SELECTED_OPTION)
4796  974F CB 27            sla a
4797  9751 CB 27            sla a
4798  9753 CB 27            sla a
4799  9755 C6 02            add a, 2                ;Skips to jump address
4800  9757 6F               ld l, a
4801  9758 26 5E            ld h, HIGH OPTIONS_TABLE
4802  975A AF               xor a
4803  975B 32 A4 5F         ld (NUM_OPTIONS), a
4804  975E 32 AC 5F         ld (RETURN_FROM_CHOOSE_CH), a
4805  9761 CD EB 83     5:  call INKEY_MENU
4806  9764 B7               or a
4807  9765 20 FA            jr nz, 5b
4808  9767 7E               ld a, (hl)      ;Store selected option value
4809  9768 23               inc hl
4810  9769 32 A6 5F         ld (SELECTED_OPTION_VALUE), a
4811  976C 7E               ld a, (hl)
4812  976D 23               inc hl
4813  976E B7               or a
4814  976F CA ED 8E         jp z, OP_GOTO
4815  9772 E5               push hl
4816  9773              .self_a+1:
4817  9773 21 00 00         ld hl, 0-0
4818  9776 3A BE 5F         ld a, (CHUNK)
4819  9779 DD 75 FF         ld (ix-1), l
4820  977C DD 74 FE         ld (ix-2), h
4821  977F DD 77 FD         ld (ix-3), a
4822  9782 11 FD FF         ld de, 65536-3    ; ix-3
4823  9785 DD 19            add ix, de
4824  9787 E1               pop hl
4825  9788 C3 ED 8E         jp OP_GOTO
4826  978B              .on_change_gosub:
4827  978B 21 AD 5F         ld hl, CHOOSE_CH_RET_ADDRESS
4828  978E 7E               ld a, (hl)
4829  978F 23               inc hl
4830  9790 5E               ld e, (hl)
4831  9791 23               inc hl
4832  9792 56               ld d, (hl)
4833  9793 23               inc hl
4834  9794 DD 73 FF         ld (ix-1), e
4835  9797 DD 72 FE         ld (ix-2), d
4836  979A DD 77 FD         ld (ix-3), a
4837  979D 11 FD FF         ld de, 65536-3    ; ix-3
4838  97A0 DD 19            add ix, de
4839  97A2 C3 ED 8E         jp OP_GOTO
4840  97A5                  ENDIF
4841  97A5
4842  97A5                  IFNDEF OP_CLEAR_OPTIONS
4843  97A5              OP_CLEAR_OPTIONS:
4844  97A5 AF               xor a
4845  97A6 32 A4 5F         ld (NUM_OPTIONS), a          ;Clear options.
4846  97A9 C3 09 83         jp EXEC_LOOP
4847  97AC                  ENDIF
4848  97AC
4849  97AC              ;----------------------------------------------------------
4850  97AC
4851  97AC                  IFNDEF UNUSED_OP_PUSH_OPTION_ST
4852  97AC              OP_PUSH_OPTION_ST:
4853  97AC 11 A4 5F         ld de, NUM_OPTIONS
4854  97AF 7E               ld a, (hl)
4855  97B0 23               inc hl
4856  97B1 B7               or a
4857  97B2 28 04            jr z, .is_zero
4858  97B4 47               ld b, a
4859  97B5 13           1:  inc de
4860  97B6 10 FD            djnz 1b
4861  97B8              .is_zero:
4862  97B8 1A               ld a, (de)
4863  97B9                  PUSH_INT_STACK
4863  97B9 DD 2B       >    dec ix
4863  97BB DD 77 00    >    ld (ix+0), a
4864  97BE C3 09 83         jp EXEC_LOOP
4865  97C1                  ENDIF
4866  97C1
4867  97C1              ;----------------------------------------------------------
4868  97C1
4869  97C1                  IFNDEF UNUSED_OP_TYPERATE
4870  97C1              OP_TYPERATE:
4871  97C1 56               ld d, (hl)
4872  97C2 23               inc hl
4873  97C3 5E               ld e, (hl)
4874  97C4 23               inc hl
4875  97C5 ED 53 B3 5F      ld (PRT_INTERVAL), de
4876  97C9 C3 09 83         jp EXEC_LOOP
4877  97CC                  ENDIF
4878  97CC
4879  97CC                  IFNDEF UNUSED_OP_CLEAR
4880  97CC              OP_CLEAR:
4881  97CC E5               push hl
4882  97CD CD 18 8D         call CLEAR_WIN
4883  97D0 E1               pop hl
4884  97D1 C3 09 83         jp EXEC_LOOP
4885  97D4                  ENDIF
4886  97D4
4887  97D4                  IFNDEF UNUSED_OP_PAGEPAUSE
4888  97D4              OP_PAGEPAUSE:
4889  97D4 7E               ld a, (hl)
4890  97D5 23               inc hl
4891  97D6 32 BF 5F         ld (WAIT_NEW_SCREEN), a
4892  97D9 C3 09 83         jp EXEC_LOOP
4893  97DC                  ENDIF
4894  97DC
4895  97DC                  IFNDEF UNUSED_OP_CHAR_D
4896  97DC              OP_CHAR_D:
4897  97DC 7E               ld a, (hl)
4898  97DD 23               inc hl
4899  97DE E5               push hl
4900  97DF CD 86 89         call PUT_VAR_CHAR
4901  97E2 E1               pop hl
4902  97E3 C3 09 83         jp EXEC_LOOP
4903  97E6                  ENDIF
4904  97E6
4905  97E6                  IFNDEF UNUSED_OP_CHAR_I
4906  97E6              OP_CHAR_I:
4907  97E6 16 5D            ld d, HIGH FLAGS
4908  97E8 5E               ld e, (hl)
4909  97E9 23               inc hl
4910  97EA 1A               ld a, (de)
4911  97EB E5               push hl
4912  97EC CD 86 89         call PUT_VAR_CHAR
4913  97EF E1               pop hl
4914  97F0 C3 09 83         jp EXEC_LOOP
4915  97F3                  ENDIF
4916  97F3
4917  97F3                  IFNDEF UNUSED_OP_POP_CHAR
4918  97F3              OP_POP_CHAR:
4919  97F3                  POP_INT_STACK
4919  97F3 DD 7E 00    >    ld a, (ix+0)
4919  97F6 DD 23       >    inc ix
4920  97F8 E5               push hl
4921  97F9 CD 86 89         call PUT_VAR_CHAR
4922  97FC E1               pop hl
4923  97FD C3 09 83         jp EXEC_LOOP
4924  9800                  ENDIF
4925  9800
4926  9800                  IFNDEF UNUSED_OP_TAB
4927  9800                  IFDEF UNUSED_OP_REPCHAR
4928  9800 ~                UNDEFINE UNUSED_OP_REPCHAR
4929  9800                  ENDIF
4930  9800              OP_TAB:
4931  9800 3A B6 5F         ld a, (CHARSET_OFFSET)
4932  9803 C6 20            add a, $20
4933  9805 18 02            jr OP_TAB2
4934  9807                  ENDIF
4935  9807
4936  9807                  IFNDEF UNUSED_OP_REPCHAR
4937  9807              OP_REPCHAR:
4938  9807 7E               ld a, (hl)
4939  9808 23               inc hl
4940  9809              OP_TAB2:
4941  9809 46               ld b, (hl)
4942  980A 23               inc hl
4943  980B E5               push hl
4944  980C C5           1:  push bc
4945  980D F5               push af
4946  980E CD 86 89         call PUT_VAR_CHAR
4947  9811 F1               pop af
4948  9812 C1               pop bc
4949  9813 10 F7            djnz 1b
4950  9815 E1               pop hl
4951  9816 C3 09 83         jp EXEC_LOOP
4952  9819                  ENDIF
4953  9819
4954  9819                  IFNDEF UNUSED_OP_NEWLINE
4955  9819              OP_NEWLINE:
4956  9819 46               ld b, (hl)
4957  981A 23               inc hl
4958  981B E5               push hl
4959  981C C5           1:  push bc
4960  981D CD 01 89         call CRLF
4961  9820 C1               pop bc
4962  9821 10 F9            djnz 1b
4963  9823 E1               pop hl
4964  9824 C3 09 83         jp EXEC_LOOP
4965  9827                  ENDIF
4966  9827
4967  9827                  IFNDEF UNUSED_OP_BACKSPACE
4968  9827              OP_BACKSPACE:
4969  9827 46               ld b, (hl)
4970  9828 23               inc hl
4971  9829 E5               push hl
4972  982A C5           1:  push bc
4973  982B CD 9D 8C         call BACKSPACE
4974  982E C1               pop bc
4975  982F 10 F9            djnz 1b
4976  9831 E1               pop hl
4977  9832 C3 09 83         jp EXEC_LOOP
4978  9835                  ENDIF
4979  9835
4980  9835                  IFNDEF UNUSED_OP_SFX_D
4981  9835              OP_SFX_D:
4982  9835 5E               ld e, (hl)
4983  9836 23               inc hl
4984  9837 DD E5            push ix
4985  9839 E5               push hl
4986  983A 3E 00            ld a, BEEPFX_AVAILABLE
4987  983C B7               or a
4988  983D 28 07            jr z, 1f
4989  983F
4990  983F 7B               ld a, e
4991  9840 32 01 00         ld (SFX_ID), a
4992  9843 CD 00 00         call BEEPFX
4993  9846
4994  9846 E1           1:  pop hl
4995  9847 DD E1            pop ix
4996  9849 C3 09 83         jp EXEC_LOOP
4997  984C                  ENDIF
4998  984C
4999  984C                  IFNDEF UNUSED_OP_SFX_I
5000  984C              OP_SFX_I:
5001  984C 5E               ld e, (hl)
5002  984D 23               inc hl
5003  984E DD E5            push ix
5004  9850 E5               push hl
5005  9851 3E 00            ld a, BEEPFX_AVAILABLE
5006  9853 B7               or a
5007  9854 28 09            jr z, 1f
5008  9856
5009  9856 16 5D            ld d, HIGH FLAGS
5010  9858 1A               ld a, (de)
5011  9859 32 01 00         ld (SFX_ID), a
5012  985C CD 00 00         call BEEPFX
5013  985F
5014  985F E1           1:  pop hl
5015  9860 DD E1            pop ix
5016  9862 C3 09 83         jp EXEC_LOOP
5017  9865                  ENDIF
5018  9865
5019  9865                  IFNDEF UNUSED_OP_POP_SFX
5020  9865              OP_POP_SFX:
5021  9865 E5               push hl
5022  9866                  POP_INT_STACK
5022  9866 DD 7E 00    >    ld a, (ix+0)
5022  9869 DD 23       >    inc ix
5023  986B 3E 00            ld a, BEEPFX_AVAILABLE
5024  986D B7               or a
5025  986E 28 0A            jr z, 1f
5026  9870 32 01 00         ld (SFX_ID), a
5027  9873 DD E5            push ix
5028  9875 CD 00 00         call BEEPFX
5029  9878 DD E1            pop ix
5030  987A E1           1:  pop hl
5031  987B C3 09 83         jp EXEC_LOOP
5032  987E                  ENDIF
5033  987E
5034  987E
5035  987E                  IFDEF USE_WYZ
5036  987E ~            FIND_WYZ_INDEX:
5037  987E ~                push af
5038  987E ~                push hl
5039  987E ~                ld c, a
5040  987E ~                ld b, TYPE_WYZ
5041  987E ~                call FIND_IN_INDEX
5042  987E ~                pop hl
5043  987E ~                pop af
5044  987E ~                ret
5045  987E                  ENDIF
5046  987E
5047  987E                  IFNDEF UNUSED_OP_TRACK_D
5048  987E              OP_TRACK_D:
5049  987E 7E               ld a, (hl)
5050  987F 23               inc hl
5051  9880                  IFDEF USE_VORTEX
5052  9880 ~                push hl
5053  9880 ~                push ix
5054  9880 ~                call LOAD_MUSIC
5055  9880 ~                pop ix
5056  9880 ~                pop hl
5057  9880                  ENDIF
5058  9880                  IFDEF USE_WYZ
5059  9880 ~                call FIND_WYZ_INDEX
5060  9880 ~                ld d, 1
5061  9880 ~                ld e, a
5062  9880 ~                call WYZ_CALL
5063  9880                  ENDIF
5064  9880 C3 09 83         jp EXEC_LOOP
5065  9883                  ENDIF
5066  9883
5067  9883                  IFNDEF UNUSED_OP_TRACK_I
5068  9883              OP_TRACK_I:
5069  9883 5E               ld e, (hl)
5070  9884 23               inc hl
5071  9885 16 5D            ld d, HIGH FLAGS
5072  9887 1A               ld a, (de)
5073  9888                  IFDEF USE_VORTEX
5074  9888 ~                push hl
5075  9888 ~                push ix
5076  9888 ~                call LOAD_MUSIC
5077  9888 ~                pop ix
5078  9888 ~                pop hl
5079  9888                  ENDIF
5080  9888                  IFDEF USE_WYZ
5081  9888 ~                call FIND_WYZ_INDEX
5082  9888 ~                ld d, 1
5083  9888 ~                ld e, a
5084  9888 ~                call WYZ_CALL
5085  9888                  ENDIF
5086  9888 C3 09 83         jp EXEC_LOOP
5087  988B                  ENDIF
5088  988B
5089  988B                  IFNDEF UNUSED_OP_POP_TRACK
5090  988B              OP_POP_TRACK:
5091  988B                  POP_INT_STACK
5091  988B DD 7E 00    >    ld a, (ix+0)
5091  988E DD 23       >    inc ix
5092  9890                  IFDEF USE_VORTEX
5093  9890 ~                push hl
5094  9890 ~                push ix
5095  9890 ~                call LOAD_MUSIC
5096  9890 ~                pop ix
5097  9890 ~                pop hl
5098  9890                  ENDIF
5099  9890                  IFDEF USE_WYZ
5100  9890 ~                call FIND_WYZ_INDEX
5101  9890 ~                ld d, 1
5102  9890 ~                ld e, a
5103  9890 ~                call WYZ_CALL
5104  9890                  ENDIF
5105  9890 C3 09 83         jp EXEC_LOOP
5106  9893                  ENDIF
5107  9893
5108  9893                  IFNDEF UNUSED_OP_PLAY_D
5109  9893              OP_PLAY_D:
5110  9893 7E               ld a, (hl)
5111  9894 23               inc hl
5112  9895                  IFDEF USE_VORTEX
5113  9895 ~                push hl
5114  9895 ~                ld hl, VTR_STAT
5115  9895 ~                bit 1, (hl)
5116  9895 ~                jr nz, 3f
5117  9895 ~                ld a, 5
5118  9895 ~                jp SYS_ERROR
5119  9895 ~            3:  or a
5120  9895 ~                jr nz, 2f
5121  9895 ~                res 2, (hl)
5122  9895 ~                jr 1f
5123  9895 ~            2:  set 2, (hl)
5124  9895 ~            1:  pop hl
5125  9895                  ENDIF
5126  9895                  IFDEF USE_WYZ
5127  9895 ~                ld d, 2
5128  9895 ~                ld e, a
5129  9895 ~                call WYZ_CALL
5130  9895                  ENDIF
5131  9895 C3 09 83         jp EXEC_LOOP
5132  9898                  ENDIF
5133  9898
5134  9898                  IFNDEF UNUSED_OP_PLAY_I
5135  9898              OP_PLAY_I:
5136  9898 5E               ld e, (hl)
5137  9899 23               inc hl
5138  989A 16 5D            ld d, HIGH FLAGS
5139  989C 1A               ld a, (de)
5140  989D                  IFDEF USE_VORTEX
5141  989D ~                push hl
5142  989D ~                ld hl, VTR_STAT
5143  989D ~                bit 1, (hl)
5144  989D ~                jr nz, 3f
5145  989D ~                ld a, 5
5146  989D ~                jp SYS_ERROR
5147  989D ~            3:  or a
5148  989D ~                jr nz, 2f
5149  989D ~                res 2, (hl)
5150  989D ~                jr 1f
5151  989D ~            2:  set 2, (hl)
5152  989D ~            1:  pop hl
5153  989D                  ENDIF
5154  989D                  IFDEF USE_WYZ
5155  989D ~                ld d, 2
5156  989D ~                ld e, a
5157  989D ~                call WYZ_CALL
5158  989D                  ENDIF
5159  989D C3 09 83         jp EXEC_LOOP
5160  98A0                  ENDIF
5161  98A0
5162  98A0                  IFNDEF UNUSED_OP_POP_PLAY
5163  98A0              OP_POP_PLAY:
5164  98A0                  POP_INT_STACK
5164  98A0 DD 7E 00    >    ld a, (ix+0)
5164  98A3 DD 23       >    inc ix
5165  98A5                  IFDEF USE_VORTEX
5166  98A5 ~                push hl
5167  98A5 ~                ld hl, VTR_STAT
5168  98A5 ~                bit 1, (hl)
5169  98A5 ~                jr nz, 3f
5170  98A5 ~                ld a, 5
5171  98A5 ~                jp SYS_ERROR
5172  98A5 ~            3:  or a
5173  98A5 ~                jr nz, 2f
5174  98A5 ~                res 2, (hl)
5175  98A5 ~                jr 1f
5176  98A5 ~            2:  set 2, (hl)
5177  98A5 ~            1:  pop hl
5178  98A5                  ENDIF
5179  98A5                  IFDEF USE_WYZ
5180  98A5 ~                ld d, 2
5181  98A5 ~                ld e, a
5182  98A5 ~                call WYZ_CALL
5183  98A5                  ENDIF
5184  98A5 C3 09 83         jp EXEC_LOOP
5185  98A8                  ENDIF
5186  98A8
5187  98A8                  IFNDEF UNUSED_OP_LOOP_D
5188  98A8              OP_LOOP_D:
5189  98A8 7E               ld a, (hl)
5190  98A9 23               inc hl
5191  98AA                  IFDEF USE_VORTEX
5192  98AA ~                push hl
5193  98AA ~                ld hl, VTR_STAT
5194  98AA ~                bit 1, (hl)
5195  98AA ~                jr nz, 3f
5196  98AA ~                ld a, 5
5197  98AA ~                jp SYS_ERROR
5198  98AA ~            3:  or a
5199  98AA ~                jr nz, 2f
5200  98AA ~                set 0, (hl)
5201  98AA ~                jr 1f
5202  98AA ~            2:  res 0, (hl)
5203  98AA ~            1:  pop hl
5204  98AA                  ENDIF
5205  98AA                  IFDEF USE_WYZ
5206  98AA ~                ld d, 3
5207  98AA ~                ld e, a
5208  98AA ~                call WYZ_CALL
5209  98AA                  ENDIF
5210  98AA C3 09 83         jp EXEC_LOOP
5211  98AD                  ENDIF
5212  98AD
5213  98AD                  IFNDEF UNUSED_OP_LOOP_I
5214  98AD              OP_LOOP_I:
5215  98AD 5E               ld e, (hl)
5216  98AE 23               inc hl
5217  98AF 16 5D            ld d, HIGH FLAGS
5218  98B1 1A               ld a, (de)
5219  98B2                  IFDEF USE_VORTEX
5220  98B2 ~                push hl
5221  98B2 ~                ld hl, VTR_STAT
5222  98B2 ~                bit 1, (hl)
5223  98B2 ~                jr nz, 3f
5224  98B2 ~                ld a, 5
5225  98B2 ~                jp SYS_ERROR
5226  98B2 ~            3:  or a
5227  98B2 ~                jr nz, 2f
5228  98B2 ~                set 0, (hl)
5229  98B2 ~                jr 1f
5230  98B2 ~            2:  res 0, (hl)
5231  98B2 ~            1:  pop hl
5232  98B2                  ENDIF
5233  98B2                  IFDEF USE_WYZ
5234  98B2 ~                ld d, 3
5235  98B2 ~                ld e, a
5236  98B2 ~                call WYZ_CALL
5237  98B2                  ENDIF
5238  98B2 C3 09 83         jp EXEC_LOOP
5239  98B5                  ENDIF
5240  98B5
5241  98B5                  IFNDEF UNUSED_OP_POP_LOOP
5242  98B5              OP_POP_LOOP:
5243  98B5                  POP_INT_STACK
5243  98B5 DD 7E 00    >    ld a, (ix+0)
5243  98B8 DD 23       >    inc ix
5244  98BA                  IFDEF USE_VORTEX
5245  98BA ~                push hl
5246  98BA ~                ld hl, VTR_STAT
5247  98BA ~                bit 1, (hl)
5248  98BA ~                jr nz, 3f
5249  98BA ~                ld a, 5
5250  98BA ~                jp SYS_ERROR
5251  98BA ~            3:  or a
5252  98BA ~                jr nz, 2f
5253  98BA ~                set 0, (hl)
5254  98BA ~                jr 1f
5255  98BA ~            2:  res 0, (hl)
5256  98BA ~            1:  pop hl
5257  98BA                  ENDIF
5258  98BA                  IFDEF USE_WYZ
5259  98BA ~                ld d, 3
5260  98BA ~                ld e, a
5261  98BA ~                call WYZ_CALL
5262  98BA                  ENDIF
5263  98BA C3 09 83         jp EXEC_LOOP
5264  98BD                  ENDIF
5265  98BD
5266  98BD                  IFNDEF UNUSED_OP_SET_XPOS
5267  98BD              OP_SET_XPOS:
5268  98BD 16 5D            ld d, HIGH FLAGS
5269  98BF 5E               ld e, (hl)
5270  98C0 23               inc hl
5271  98C1 3A B7 5F         ld a, (POS_X)
5272  98C4 CB 3F            srl a
5273  98C6 CB 3F            srl a
5274  98C8 CB 3F            srl a
5275  98CA 12               ld (de), a
5276  98CB C3 09 83         jp EXEC_LOOP
5277  98CE                  ENDIF
5278  98CE
5279  98CE                  IFNDEF UNUSED_OP_SET_YPOS
5280  98CE              OP_SET_YPOS:
5281  98CE 16 5D            ld d, HIGH FLAGS
5282  98D0 5E               ld e, (hl)
5283  98D1 23               inc hl
5284  98D2 3A B8 5F         ld a, (POS_Y)
5285  98D5 12               ld (de), a
5286  98D6 C3 09 83         jp EXEC_LOOP
5287  98D9                  ENDIF
5288  98D9
5289  98D9                  IFNDEF UNUSED_OP_PUSH_XPOS
5290  98D9              OP_PUSH_XPOS:
5291  98D9 3A B7 5F         ld a, (POS_X)
5292  98DC CB 3F            srl a
5293  98DE CB 3F            srl a
5294  98E0 CB 3F            srl a
5295  98E2                  PUSH_INT_STACK
5295  98E2 DD 2B       >    dec ix
5295  98E4 DD 77 00    >    ld (ix+0), a
5296  98E7 C3 09 83         jp EXEC_LOOP
5297  98EA                  ENDIF
5298  98EA
5299  98EA                  IFNDEF UNUSED_OP_PUSH_YPOS
5300  98EA              OP_PUSH_YPOS:
5301  98EA 3A B8 5F         ld a, (POS_Y)
5302  98ED                  PUSH_INT_STACK
5302  98ED DD 2B       >    dec ix
5302  98EF DD 77 00    >    ld (ix+0), a
5303  98F2 C3 09 83         jp EXEC_LOOP
5304  98F5                  ENDIF
5305  98F5
5306  98F5                  IFNDEF UNUSED_OP_MIN
5307  98F5              OP_MIN:
5308  98F5                  OP_2PARAM_GET_STACK  ; A= Param1, C=Param2
5308  98F5 DD 4E 00    >    ld c, (ix+0)
5308  98F8 DD 7E 01    >    ld a, (ix+1)
5309  98FB B9               cp c                 ; a-c
5310  98FC 30 13            jr nc, 1f             ; A >= C
5311  98FE 79               ld a, c
5312  98FF                  OP_2PARAM_STORE_STACK
5312  98FF DD 23       >    inc ix
5312  9901 DD 77 00    >    ld (ix+0), a
5312  9904 C3 09 83    >    jp EXEC_LOOP
5313  9907                  ENDIF
5314  9907
5315  9907                  IFNDEF UNUSED_OP_MAX
5316  9907              OP_MAX:
5317  9907                  OP_2PARAM_GET_STACK  ; A= Param1, C=Param2
5317  9907 DD 4E 00    >    ld c, (ix+0)
5317  990A DD 7E 01    >    ld a, (ix+1)
5318  990D B9               cp c                 ; a-c
5319  990E 38 01            jr c, 1f             ; A < C
5320  9910 79               ld a, c
5321  9911              1:  OP_2PARAM_STORE_STACK
5321  9911 DD 23       >    inc ix
5321  9913 DD 77 00    >    ld (ix+0), a
5321  9916 C3 09 83    >    jp EXEC_LOOP
5322  9919                  ENDIF
5323  9919
5324  9919                  IFNDEF UNUSED_OP_PUSH_IS_DISK
5325  9919              OP_PUSH_IS_DISK:
5326  9919 3E 00            ld a, 0
5327  991B                  PUSH_INT_STACK
5327  991B DD 2B       >    dec ix
5327  991D DD 77 00    >    ld (ix+0), a
5328  9920 C3 09 83         jp EXEC_LOOP
5329  9923                  ENDIF
5330  9923              ;-------------------------------------------------------
5331  9923
5332  9923                  IFNDEF UNUSED_OP_POP_MENUCONFIG
5333  9923              OP_POP_MENUCONFIG:
5334  9923 DD 56 00         ld d, (ix+0)
5335  9926 DD 5E 01         ld e, (ix+1)
5336  9929 DD 46 02         ld b, (ix+2)
5337  992C DD 4E 03         ld c, (ix+3)
5338  992F ED 43 A7 5F      ld (INCR_X_OPTION), bc
5339  9933 ED 53 A9 5F      ld (DEFAULT_OPTION), de
5340  9937 11 04 00         ld de, 4
5341  993A DD 19            add ix, de
5342  993C C3 09 83         jp EXEC_LOOP
5343  993F                  ENDIF
5344  993F
5345  993F                  IFNDEF UNUSED_OP_MENUCONFIG
5346  993F              OP_MENUCONFIG:
5347  993F 11 A7 5F         ld de, INCR_X_OPTION
5348  9942 ED A0            ldi
5349  9944 ED A0            ldi
5350  9946 ED A0            ldi
5351  9948 ED A0            ldi
5352  994A C3 09 83         jp EXEC_LOOP
5353  994D                  ENDIF
5354  994D
5355  994D              ;-------------------------------------------------------
5356  994D
5357  994D                  IFNDEF UNUSED_OP_POP_ALL_BLIT
5358  994D              OP_POP_ALL_BLIT:
5359  994D E5               push hl
5360  994E DD 46 00         ld b, (ix+0)               ; GET Y
5361  9951 DD 23            inc ix
5362  9953 DD 4E 00         ld c, (ix+0)               ; GET X
5363  9956 DD 23            inc ix
5364  9958 C5               push bc
5365  9959 ED 43 74 80      ld (CPY_SCR_BLK_X_D), bc
5366  995D DD 56 00         ld d, (ix+0)               ; GET H
5367  9960 DD 23            inc ix
5368  9962 DD 5E 00         ld e, (ix+0)               ; GET W
5369  9965 DD 23            inc ix
5370  9967 DD 46 00         ld b, (ix+0)               ; GET YO
5371  996A DD 23            inc ix
5372  996C DD 4E 00         ld c, (ix+0)               ; GET XO
5373  996F DD 23            inc ix
5374  9971 CD F4 8C         call POS_ADJUST
5375  9974 CD 00 8D         call RECT_ADJUST
5376  9977 ED 43 70 80      ld (CPY_SCR_BLK_X), bc
5377  997B ED 53 72 80      ld (CPY_SCR_BLK_W), de
5378  997F C1               pop bc
5379  9980 18 33            jr 2f
5380  9982                  IFNDEF BLIT_USED
5381  9982                  DEFINE BLIT_USED
5382  9982                  ENDIF
5383  9982                  ENDIF
5384  9982
5385  9982                  IFNDEF UNUSED_OP_POP_BLIT
5386  9982              OP_POP_BLIT:
5387  9982 11 70 80         ld de, CPY_SCR_BLK_X
5388  9985 ED A0            ldi
5389  9987 ED A0            ldi
5390  9989 ED A0            ldi
5391  998B ED A0            ldi
5392  998D DD 46 00         ld b, (ix+0)               ; GET Y
5393  9990 DD 23            inc ix
5394  9992 DD 4E 00         ld c, (ix+0)               ; GET X
5395  9995 DD 23            inc ix
5396  9997 ED 43 74 80      ld (CPY_SCR_BLK_X_D), bc
5397  999B 18 13            jr 1f
5398  999D                  IFNDEF BLIT_USED
5399  999D ~                DEFINE BLIT_USED
5400  999D                  ENDIF
5401  999D                  ENDIF
5402  999D
5403  999D                  IFNDEF UNUSED_OP_BLIT
5404  999D              OP_BLIT:
5405  999D 11 70 80         ld de, CPY_SCR_BLK_X
5406  99A0 ED A0            ldi
5407  99A2 ED A0            ldi
5408  99A4 ED A0            ldi
5409  99A6 ED A0            ldi
5410  99A8 ED A0            ldi
5411  99AA ED A0            ldi
5412  99AC ED 4B 74 80      ld bc, (CPY_SCR_BLK_X_D)
5413  99B0                  IFNDEF BLIT_USED
5414  99B0 ~                DEFINE BLIT_USED
5415  99B0                  ENDIF
5416  99B0                  ENDIF
5417  99B0
5418  99B0                  IFDEF BLIT_USED
5419  99B0 ED 5B 72 80  1:  ld de, (CPY_SCR_BLK_W)
5420  99B4 E5               push hl
5421  99B5 CD EC 8C     2:  call POS_CHECK
5422  99B8 DA B7 9A         jp c, .endBlit
5423  99BB CD 00 8D         call RECT_ADJUST
5424  99BE 7A               ld a, d
5425  99BF B7               or a
5426  99C0 CA B7 9A         jp z, .endBlit
5427  99C3 7B               ld a, e
5428  99C4 B7               or a
5429  99C5 CA B7 9A         jp z, .endBlit
5430  99C8 ED 53 72 80  4:  ld (CPY_SCR_BLK_W), de
5431  99CC ED 43 74 80      ld (CPY_SCR_BLK_X_D), bc
5432  99D0
5433  99D0              .getPxlAddr:
5434  99D0                  ;ld bc,(CPY_SCR_BLK_X_D)
5435  99D0 78               ld a, b
5436  99D1 E6 18            and %00011000
5437  99D3 C6 40            add a, %01000000         ; Sumamos $40 (bits superiores = 010)
5438  99D5 57               ld d, a
5439  99D6 78               ld a, b
5440  99D7 E6 07            and %00000111
5441  99D9 0F               rrca
5442  99DA 0F               rrca
5443  99DB 0F               rrca
5444  99DC 81               add a, c
5445  99DD 5F               ld e, a
5446  99DE
5447  99DE ED 4B 70 80      ld bc,(CPY_SCR_BLK_X)
5448  99E2 78               ld a, b
5449  99E3 E6 1F            and %00011111
5450  99E5 C6 60            add a, HIGH SCREEN_BUFFER_PXL
5451  99E7 67               ld h, a
5452  99E8 79               ld a, c
5453  99E9 E6 1F            and %00011111
5454  99EB 6F               ld l, a
5455  99EC
5456  99EC              ;Copy pixels
5457  99EC ED 4B 72 80      ld bc,(CPY_SCR_BLK_W)
5458  99F0              .loopRowsPxl:
5459  99F0 C5               push bc
5460  99F1 D5               push de
5461  99F2 06 00            ld b, 0
5462  99F4 79               ld a, c
5463  99F5
5464  99F5                  REPT 7
5465  99F5 E5          >    push hl
5466  99F6 D5          >    push de
5467  99F7 4F          >    ld c, a
5468  99F8 08          >    ex af, af'
5469  99F9 ED B0       >    ldir
5470  99FB D1          >    pop de
5471  99FC E1          >    pop hl
5472  99FD 14          >    inc d
5473  99FE 7D          >    ld a, l
5474  99FF C6 20       >    add a, 32
5475  9A01 6F          >    ld l, a
5476  9A02 08          >    ex af, af'
5465  9A03 E5          >    push hl
5466  9A04 D5          >    push de
5467  9A05 4F          >    ld c, a
5468  9A06 08          >    ex af, af'
5469  9A07 ED B0       >    ldir
5470  9A09 D1          >    pop de
5471  9A0A E1          >    pop hl
5472  9A0B 14          >    inc d
5473  9A0C 7D          >    ld a, l
5474  9A0D C6 20       >    add a, 32
5475  9A0F 6F          >    ld l, a
5476  9A10 08          >    ex af, af'
5465  9A11 E5          >    push hl
5466  9A12 D5          >    push de
5467  9A13 4F          >    ld c, a
5468  9A14 08          >    ex af, af'
5469  9A15 ED B0       >    ldir
5470  9A17 D1          >    pop de
5471  9A18 E1          >    pop hl
5472  9A19 14          >    inc d
5473  9A1A 7D          >    ld a, l
5474  9A1B C6 20       >    add a, 32
5475  9A1D 6F          >    ld l, a
5476  9A1E 08          >    ex af, af'
5465  9A1F E5          >    push hl
5466  9A20 D5          >    push de
5467  9A21 4F          >    ld c, a
5468  9A22 08          >    ex af, af'
5469  9A23 ED B0       >    ldir
5470  9A25 D1          >    pop de
5471  9A26 E1          >    pop hl
5472  9A27 14          >    inc d
5473  9A28 7D          >    ld a, l
5474  9A29 C6 20       >    add a, 32
5475  9A2B 6F          >    ld l, a
5476  9A2C 08          >    ex af, af'
5465  9A2D E5          >    push hl
5466  9A2E D5          >    push de
5467  9A2F 4F          >    ld c, a
5468  9A30 08          >    ex af, af'
5469  9A31 ED B0       >    ldir
5470  9A33 D1          >    pop de
5471  9A34 E1          >    pop hl
5472  9A35 14          >    inc d
5473  9A36 7D          >    ld a, l
5474  9A37 C6 20       >    add a, 32
5475  9A39 6F          >    ld l, a
5476  9A3A 08          >    ex af, af'
5465  9A3B E5          >    push hl
5466  9A3C D5          >    push de
5467  9A3D 4F          >    ld c, a
5468  9A3E 08          >    ex af, af'
5469  9A3F ED B0       >    ldir
5470  9A41 D1          >    pop de
5471  9A42 E1          >    pop hl
5472  9A43 14          >    inc d
5473  9A44 7D          >    ld a, l
5474  9A45 C6 20       >    add a, 32
5475  9A47 6F          >    ld l, a
5476  9A48 08          >    ex af, af'
5465  9A49 E5          >    push hl
5466  9A4A D5          >    push de
5467  9A4B 4F          >    ld c, a
5468  9A4C 08          >    ex af, af'
5469  9A4D ED B0       >    ldir
5470  9A4F D1          >    pop de
5471  9A50 E1          >    pop hl
5472  9A51 14          >    inc d
5473  9A52 7D          >    ld a, l
5474  9A53 C6 20       >    add a, 32
5475  9A55 6F          >    ld l, a
5476  9A56 08          >    ex af, af'
5477  9A57                  ENDR
5478  9A57
5479  9A57 E5               push hl     ;Last line
5480  9A58 4F               ld c, a
5481  9A59 ED B0            ldir
5482  9A5B E1               pop hl
5483  9A5C 7D               ld a, l
5484  9A5D E6 1F            and %00011111
5485  9A5F 6F               ld l, a
5486  9A60 24               inc h
5487  9A61 D1               pop de
5488  9A62 7B               ld a, e     ; A = lower part of the address. RRRC CCCC.
5489  9A63 C6 20            add a, $20  ; Add one line (RRRC CCCC + 0010 0000).
5490  9A65 5F               ld e, a     ; L = A.
5491  9A66 30 04            jr nc,1f    ; If there is no carry, the row follows between 0
5492  9A68                              ; and 7, it exits.  ; There is carry-over, the third of the screen has to be changed.
5493  9A68 7A               ld a, d     ; A = upper part of memory address. 010T TSSS.
5494  9A69 C6 08            add a, $08  ; Add one third (010T TSSS + 0000 1000).
5495  9A6B 57               ld d, a     ; H = A.  ret
5496  9A6C
5497  9A6C C1           1:  pop bc
5498  9A6D 10 81            djnz .loopRowsPxl
5499  9A6F
5500  9A6F              .getAttAddr:
5501  9A6F ED 4B 70 80      ld bc,(CPY_SCR_BLK_X)
5502  9A73 78               ld a, b
5503  9A74 0F               rrca
5504  9A75 0F               rrca
5505  9A76 0F               rrca
5506  9A77 E6 03            and %00000011
5507  9A79 C6 78            add a, HIGH SCREEN_BUFFER_ATT
5508  9A7B 67               ld h, a
5509  9A7C 78               ld a, b
5510  9A7D E6 07            and %00000111
5511  9A7F 0F               rrca
5512  9A80 0F               rrca
5513  9A81 0F               rrca
5514  9A82 81               add a, c
5515  9A83 6F               ld l, a
5516  9A84
5517  9A84 ED 4B 74 80      ld bc,(CPY_SCR_BLK_X_D)
5518  9A88 78               ld a, b
5519  9A89 0F               rrca
5520  9A8A 0F               rrca
5521  9A8B 0F               rrca
5522  9A8C E6 03            and %00000011
5523  9A8E C6 58            add a, %01011000         ; Ponemos los bits 15-10 como 010110b
5524  9A90 57               ld d, a
5525  9A91 78               ld a, b
5526  9A92 E6 07            and %00000111
5527  9A94 0F               rrca
5528  9A95 0F               rrca
5529  9A96 0F               rrca
5530  9A97 81               add a, c
5531  9A98 5F               ld e, a
5532  9A99
5533  9A99              ;Copy attr
5534  9A99 ED 4B 72 80      ld bc,(CPY_SCR_BLK_W)
5535  9A9D              .loopRowsAtt:
5536  9A9D C5               push bc
5537  9A9E 06 00            ld b, 0
5538  9AA0 D5               push de
5539  9AA1 E5               push hl
5540  9AA2 ED B0            ldir
5541  9AA4 E1               pop hl
5542  9AA5 D1               pop de
5543  9AA6 3E 20            ld a, $20
5544  9AA8 85               add a, l
5545  9AA9 30 01            jr nc, 1f
5546  9AAB 24               inc h
5547  9AAC 6F           1:  ld l, a
5548  9AAD 3E 20            ld a, $20
5549  9AAF 83               add a, e
5550  9AB0 30 01            jr nc, 2f
5551  9AB2 14               inc d
5552  9AB3 5F           2:  ld e, a
5553  9AB4 C1               pop bc
5554  9AB5 10 E6            djnz .loopRowsAtt
5555  9AB7
5556  9AB7              .endBlit:
5557  9AB7 E1               pop hl
5558  9AB8 C3 09 83         jp EXEC_LOOP
5559  9ABB
5560  9ABB              CPY_SCR_BLK_X     EQU TMP_AREA + 0
5561  9ABB              CPY_SCR_BLK_Y     EQU TMP_AREA + 1
5562  9ABB              CPY_SCR_BLK_W     EQU TMP_AREA + 2
5563  9ABB              CPY_SCR_BLK_H     EQU TMP_AREA + 3
5564  9ABB              CPY_SCR_BLK_X_D   EQU TMP_AREA + 4
5565  9ABB              CPY_SCR_BLK_Y_D   EQU TMP_AREA + 5
5566  9ABB
5567  9ABB                  UNDEFINE BLIT_USED
5568  9ABB                  ENDIF
5569  9ABB              ;---------------
5570  9ABB
5571  9ABB                  IFNDEF UNUSED_OP_FADEOUT
5572  9ABB
5573  9ABB                  IFNDEF GET_ATTR_ADDR_USED
5574  9ABB                  DEFINE GET_ATTR_ADDR_USED
5575  9ABB                  ENDIF
5576  9ABB
5577  9ABB              FADEOUT_ITERATIONS              EQU 8
5578  9ABB
5579  9ABB              OP_FADEOUT:
5580  9ABB 4E               ld c, (hl)
5581  9ABC 23               inc hl
5582  9ABD 46               ld b, (hl)
5583  9ABE 23               inc hl
5584  9ABF 5E               ld e, (hl)
5585  9AC0 23               inc hl
5586  9AC1 56               ld d, (hl)
5587  9AC2 23               inc hl
5588  9AC3 E5               push hl
5589  9AC4 ED 53 C4 5F      ld (FADEOUT_W), de
5590  9AC8 CD 91 9B         call GET_ATTR_ADDR
5591  9ACB 22 C2 5F         ld (FADE_OUT_ADDRESS), hl
5592  9ACE 3E 08            ld a, FADEOUT_ITERATIONS ; Num iterations
5593  9AD0 32 C1 5F         ld (FADE_OUT_ITERARIONS), a
5594  9AD3 76           1:  halt
5595  9AD4 3A C1 5F         ld a, (FADE_OUT_ITERARIONS)
5596  9AD7 B7               or a
5597  9AD8 20 F9            jr nz, 1b
5598  9ADA E1               pop hl
5599  9ADB C3 09 83         jp EXEC_LOOP
5600  9ADE                  ENDIF
5601  9ADE
5602  9ADE                  IFNDEF UNUSED_OP_POP_FILLATTR
5602  9ADE
5603  9ADE                  IFNDEF GET_ATTR_ADDR_USED
5604  9ADE ~                DEFINE GET_ATTR_ADDR_USED
5605  9ADE                  ENDIF
5606  9ADE                  IFNDEF FILLATTR_USED
5607  9ADE                  DEFINE FILLATTR_USED
5608  9ADE                  ENDIF
5609  9ADE              OP_POP_FILLATTR:
5610  9ADE E5               push hl
5611  9ADF                  ;Get Attr
5612  9ADF DD 7E 00         ld a, (ix+0)
5613  9AE2                  ;Get Height
5614  9AE2 DD 66 01         ld h, (ix+1)
5615  9AE5                  ;Get Width
5616  9AE5 DD 6E 02         ld l, (ix+2)
5617  9AE8                  ;Get Rows
5618  9AE8 DD 46 03         ld b, (ix+3)
5619  9AEB                  ;Get Cols
5620  9AEB DD 4E 04         ld c, (ix+4)
5621  9AEE 11 05 00         ld de, 5
5622  9AF1 DD 19            add ix, de
5623  9AF3 EB               ex de, hl
5624  9AF4 18 0B            jr FILLATTR
5625  9AF6                  ENDIF
5626  9AF6
5627  9AF6                  IFNDEF UNUSED_OP_FILLATTR
5628  9AF6                  IFNDEF GET_ATTR_ADDR_USED
5629  9AF6 ~                DEFINE GET_ATTR_ADDR_USED
5630  9AF6                  ENDIF
5631  9AF6                  IFNDEF FILLATTR_USED
5632  9AF6 ~                DEFINE FILLATTR_USED
5633  9AF6                  ENDIF
5634  9AF6              OP_FILLATTR:
5635  9AF6 4E               ld c, (hl)
5636  9AF7 23               inc hl
5637  9AF8 46               ld b, (hl)
5638  9AF9 23               inc hl
5639  9AFA 5E               ld e, (hl)
5640  9AFB 23               inc hl
5641  9AFC 56               ld d, (hl)
5642  9AFD 23               inc hl
5643  9AFE 7E               ld a, (hl)
5644  9AFF 23               inc hl
5645  9B00 E5               push hl
5646  9B01                  ENDIF
5647  9B01
5648  9B01                  IFDEF FILLATTR_USED
5649  9B01                  ; bc: y - x
5650  9B01                  ; de: height - width
5651  9B01              FILLATTR:
5652  9B01 08               ex af, af'
5653  9B02 CD F4 8C         call POS_ADJUST
5654  9B05 CD 00 8D         call RECT_ADJUST
5655  9B08 CD 91 9B         call GET_ATTR_ADDR
5656  9B0B 08               ex af, af'
5657  9B0C
5658  9B0C 4F               ld c, a
5659  9B0D 43           2:  ld b, e        ; width -> B
5660  9B0E E5               push hl
5661  9B0F 71           1:  ld (hl), c     ; Fill color
5662  9B10 23               inc hl
5663  9B11 10 FC            djnz 1b
5664  9B13 E1               pop hl         ; Restore hl
5665  9B14 3E 20            ld a, 32       ; next attr line
5666  9B16 85               add a, l
5667  9B17 30 01            jr nc, 3f
5668  9B19 24               inc h
5669  9B1A 6F           3:  ld l, a
5670  9B1B 15               dec d
5671  9B1C 20 EF            jr nz, 2b
5672  9B1E
5673  9B1E E1               pop hl
5674  9B1F C3 09 83         jp EXEC_LOOP
5675  9B22                  ENDIF
5676  9B22
5677  9B22                  IFNDEF UNUSED_OP_PUTATTR
5678  9B22                  IFNDEF PUT_ATTR_USED
5679  9B22                  DEFINE PUT_ATTR_USED
5680  9B22                  ENDIF
5681  9B22              OP_PUTATTR:
5682  9B22                  ;Get Attr
5683  9B22 56               ld d, (hl)
5684  9B23 23               inc hl
5685  9B24                  ;Get mask
5686  9B24 5E               ld e, (hl)
5687  9B25 23               inc hl
5688  9B26                  ;Get Cols
5689  9B26 4E               ld c, (hl)
5690  9B27 23               inc hl
5691  9B28                  ;Get Rows
5692  9B28 46               ld b, (hl)
5693  9B29 23               inc hl
5694  9B2A E5               push hl
5695  9B2B CD F4 8C         call POS_ADJUST
5696  9B2E CD 6A 9B         call PUT_ATTR
5697  9B31 E1               pop hl
5698  9B32 C3 09 83         jp EXEC_LOOP
5699  9B35                  ENDIF
5700  9B35
5701  9B35                  IFNDEF UNUSED_OP_POP_PUTATTR
5702  9B35                  IFNDEF PUT_ATTR_USED
5703  9B35 ~                DEFINE PUT_ATTR_USED
5704  9B35                  ENDIF
5705  9B35              OP_POP_PUTATTR:
5706  9B35                  ;Get Cols
5707  9B35 4E               ld c, (hl)
5708  9B36 23               inc hl
5709  9B37                  ;Get Rows
5710  9B37 46               ld b, (hl)
5711  9B38 23               inc hl
5712  9B39 E5               push hl
5713  9B3A CD F4 8C         call POS_ADJUST
5714  9B3D                  ;Get mask
5715  9B3D DD 5E 00         ld e, (ix+0)
5716  9B40                  ;Get Attr
5717  9B40 DD 56 01         ld d, (ix+1)
5718  9B43 DD 23            inc ix
5719  9B45 DD 23            inc ix
5720  9B47 CD 6A 9B         call PUT_ATTR
5721  9B4A E1               pop hl
5722  9B4B C3 09 83         jp EXEC_LOOP
5723  9B4E                  ENDIF
5724  9B4E
5725  9B4E                  IFNDEF UNUSED_OP_POP_ALL_PUTATTR
5726  9B4E                  IFNDEF PUT_ATTR_USED
5727  9B4E ~                DEFINE PUT_ATTR_USED
5728  9B4E                  ENDIF
5729  9B4E              OP_POP_ALL_PUTATTR:
5730  9B4E                  ;Get Rows
5731  9B4E DD 46 00         ld b, (ix+0)
5732  9B51                  ;Get Cols
5733  9B51 DD 4E 01         ld c, (ix+1)
5734  9B54 CD F4 8C         call POS_ADJUST
5735  9B57                  ;Get mask
5736  9B57 DD 5E 02         ld e, (ix+2)
5737  9B5A                  ;Get Attr
5738  9B5A DD 56 03         ld d, (ix+3)
5739  9B5D E5               push hl
5740  9B5E CD 6A 9B         call PUT_ATTR
5741  9B61 11 04 00         ld de, 4
5742  9B64 DD 19            add ix, de
5743  9B66 E1               pop hl
5744  9B67 C3 09 83         jp EXEC_LOOP
5745  9B6A                  ENDIF
5746  9B6A
5747  9B6A                  IFDEF PUT_ATTR_USED
5748  9B6A                  IFNDEF GET_ATTR_ADDR_USED
5749  9B6A ~                DEFINE GET_ATTR_ADDR_USED
5750  9B6A                  ENDIF
5751  9B6A              PUT_ATTR:
5752  9B6A CD 91 9B         call GET_ATTR_ADDR
5753  9B6D 7A               ld a, d
5754  9B6E A3               and e
5755  9B6F 57               ld d, a
5756  9B70 7B               ld a, e
5757  9B71 2F               cpl
5758  9B72 A6               and (hl)        ;AND with mask
5759  9B73 B2               or d            ;OR with new values
5760  9B74 77               ld (hl), a      ;Store value again
5761  9B75 C9               ret
5762  9B76                  ENDIF
5763  9B76
5764  9B76                  IFNDEF UNUSED_OP_PUSH_GETATTR
5765  9B76                  IFNDEF GET_ATTR_ADDR_USED
5766  9B76 ~                DEFINE GET_ATTR_ADDR_USED
5767  9B76                  ENDIF
5768  9B76              OP_PUSH_GETATTR:
5769  9B76                  ;Get Rows
5770  9B76 DD 46 00         ld b, (ix+0)
5771  9B79 DD 23            inc ix
5772  9B7B                  ;Get Cols
5773  9B7B DD 4E 00         ld c, (ix+0)
5774  9B7E DD 23            inc ix
5775  9B80 CD F4 8C         call POS_ADJUST
5776  9B83 E5               push hl
5777  9B84 CD 91 9B         call GET_ATTR_ADDR
5778  9B87 7E               ld a, (hl)        ;Get attribute
5779  9B88                  PUSH_INT_STACK
5779  9B88 DD 2B       >    dec ix
5779  9B8A DD 77 00    >    ld (ix+0), a
5780  9B8D E1               pop hl
5781  9B8E C3 09 83         jp EXEC_LOOP
5782  9B91                  ENDIF
5783  9B91
5784  9B91                  IFDEF GET_ATTR_ADDR_USED
5785  9B91              GET_ATTR_ADDR:
5786  9B91                  ; bc: y - x
5787  9B91 78               ld a, b
5788  9B92 0F               rrca
5789  9B93 0F               rrca
5790  9B94 0F               rrca
5791  9B95 E6 03            and %00000011
5792  9B97 C6 58            add a, %01011000
5793  9B99 67               ld h, a
5794  9B9A 78               ld a, b
5795  9B9B E6 07            and %00000111
5796  9B9D 0F               rrca
5797  9B9E 0F               rrca
5798  9B9F 0F               rrca
5799  9BA0 81               add a, c
5800  9BA1 6F               ld l, a        ; HL -> Attr coordinates
5801  9BA2 C9               ret
5802  9BA3                  UNDEFINE GET_ATTR_ADDR_USED
5803  9BA3                  ENDIF
5804  9BA3
5805  9BA3              ;---------------
5806  9BA3                  IFNDEF UNUSED_OP_RAMLOAD
5807  9BA3              OP_RAMLOAD:
5808  9BA3 46               ld b, (hl)
5809  9BA4 23               inc hl
5810  9BA5 4E               ld c, (hl)
5811  9BA6 23               inc hl
5812  9BA7 E5               push hl
5813  9BA8 CD 22 85         call CHK_RAMLOAD_PARAMETERS
5814  9BAB CD 30 85         call RAMLOAD
5815  9BAE E1               pop hl
5816  9BAF C3 09 83         jp EXEC_LOOP
5817  9BB2                  ENDIF
5818  9BB2
5819  9BB2                  IFNDEF UNUSED_OP_RAMSAVE
5820  9BB2              OP_RAMSAVE:
5821  9BB2 46               ld b, (hl)
5822  9BB3 23               inc hl
5823  9BB4 4E               ld c, (hl)
5824  9BB5 23               inc hl
5825  9BB6 E5               push hl
5826  9BB7 CD 22 85         call CHK_RAMLOAD_PARAMETERS
5827  9BBA CD 38 85         call RAMSAVE
5828  9BBD E1               pop hl
5829  9BBE C3 09 83         jp EXEC_LOOP
5830  9BC1                  ENDIF
5831  9BC1
5832  9BC1                  IFNDEF UNUSED_OP_POP_SLOT_LOAD
5833  9BC1              OP_POP_SLOT_LOAD:
5834  9BC1                  POP_INT_STACK
5834  9BC1 DD 7E 00    >    ld a, (ix+0)
5834  9BC4 DD 23       >    inc ix
5835  9BC6 32 C8 5F         ld (CURR_SAVE_SLOT), a
5836  9BC9 CD EA 85         call DO_LOAD
5837  9BCC C3 09 83         jp EXEC_LOOP
5838  9BCF                  ENDIF
5839  9BCF
5840  9BCF                  IFNDEF UNUSED_OP_POP_SLOT_SAVE
5841  9BCF              OP_POP_SLOT_SAVE:
5842  9BCF                  POP_INT_STACK
5842  9BCF DD 7E 00    >    ld a, (ix+0)
5842  9BD2 DD 23       >    inc ix
5843  9BD4 32 C8 5F         ld (CURR_SAVE_SLOT), a
5844  9BD7 46               ld b, (hl)
5845  9BD8 23               inc hl
5846  9BD9 4E               ld c, (hl)
5847  9BDA 23               inc hl
5848  9BDB CD 22 85         call CHK_RAMLOAD_PARAMETERS
5849  9BDE CD A5 85         call DO_SAVE
5850  9BE1 C3 09 83         jp EXEC_LOOP
5851  9BE4                  ENDIF
5852  9BE4
5853  9BE4                  IFNDEF UNUSED_OP_PUSH_SAVE_RESULT
5854  9BE4              OP_PUSH_SAVE_RESULT:
5855  9BE4 3A C9 5F         ld a, (LAST_SAVE_RESULT)
5856  9BE7                  PUSH_INT_STACK
5856  9BE7 DD 2B       >    dec ix
5856  9BE9 DD 77 00    >    ld (ix+0), a
5857  9BEC C3 09 83         jp EXEC_LOOP
5858  9BEF                  ENDIF
5859  9BEF
5860  9BEF              ;-------------------------------------------------------
5861  9BEF                  IFNDEF UNUSED_OP_SHIFT_R
5862  9BEF              OP_SHIFT_R:
5863  9BEF                  ; p2 = A, p1 = C
5864  9BEF DD 7E 00         ld a, (ix+0)
5865  9BF2 DD 4E 01         ld c, (ix+1)
5866  9BF5 B7               or a
5867  9BF6 28 05            jr z, 1f
5868  9BF8 47               ld b, a
5869  9BF9 CB 39        2:  srl c
5870  9BFB 10 FC            djnz 2b
5871  9BFD DD 23        1:  inc ix
5872  9BFF DD 71 00         ld (ix+0), c
5873  9C02 C3 09 83         jp EXEC_LOOP
5874  9C05                  ENDIF
5875  9C05
5876  9C05                  IFNDEF UNUSED_OP_SHIFT_L
5877  9C05              OP_SHIFT_L:
5878  9C05                  ; p2 = A, p1 = C
5879  9C05 DD 7E 00         ld a, (ix+0)
5880  9C08 DD 4E 01         ld c, (ix+1)
5881  9C0B B7               or a
5882  9C0C 28 05            jr z, 1f
5883  9C0E 47               ld b, a
5884  9C0F CB 21        2:  sla c
5885  9C11 10 FC            djnz 2b
5886  9C13 DD 23        1:  inc ix
5887  9C15 DD 71 00         ld (ix+0), c
5888  9C18 C3 09 83         jp EXEC_LOOP
5889  9C1B                  ENDIF
5890  9C1B
5891  9C1B              ;-------------------------------------------------------
5892  9C1B                  IFNDEF UNUSED_OP_WINDOW
5893  9C1B              OP_WINDOW:
5894  9C1B E5               push hl
5895  9C1C E5               push hl
5896  9C1D 3A B5 5F         ld a, (CURR_WINDOW)
5897  9C20 11 15 7C         ld de, WINDOWS
5898  9C23 83               add a, e
5899  9C24 30 01            jr nc, 1f
5900  9C26 14               inc d
5901  9C27 5F           1:  ld e, a
5902  9C28 21 B7 5F         ld hl, POS_X
5903  9C2B 01 07 00         ld bc, 7
5904  9C2E ED B0            ldir
5905  9C30 3A 8D 5C         ld a, (ATTR_P)
5906  9C33 12               ld (de), a
5907  9C34 E1               pop hl
5908  9C35 7E               ld a, (hl)
5909  9C36 E6 07            and 7
5910  9C38 CB 27            sla a
5911  9C3A CB 27            sla a
5912  9C3C CB 27            sla a
5913  9C3E 32 B5 5F         ld (CURR_WINDOW), a
5914  9C41 21 15 7C         ld hl, WINDOWS
5915  9C44 85               add a, l
5916  9C45 30 01            jr nc, 1f
5917  9C47 24               inc h
5918  9C48 6F           1:  ld l, a
5919  9C49 11 B7 5F         ld de, POS_X
5920  9C4C 01 07 00         ld bc, 7
5921  9C4F ED B0            ldir
5922  9C51 7E               ld a, (hl)
5923  9C52 32 8D 5C         ld (ATTR_P), a
5924  9C55 E1               pop hl
5925  9C56 23               inc hl
5926  9C57 C3 09 83         jp EXEC_LOOP
5927  9C5A                  ENDIF
5928  9C5A
5929  9C5A                  IFNDEF UNUSED_OP_CHARSET
5930  9C5A                  ; TODO: Add charset to Window?
5931  9C5A              OP_CHARSET:
5932  9C5A 7E               ld a, (hl)
5933  9C5B 23               inc hl
5934  9C5C E5               push hl
5935  9C5D B7               or a
5936  9C5E 28 02            jr z, 1f
5937  9C60 3E 80            ld a, $80                ;If <> 0, sets offset to 128
5938  9C62 32 B6 5F     1:  ld (CHARSET_OFFSET), a
5939  9C65 C6 20            add a, $20               ;Space
5940  9C67 CD F6 88         call GET_CHARACTER_WIDTH
5941  9C6A 32 C7 5F         ld (WIDTH_BACKSPACE), a
5942  9C6D E1               pop hl
5943  9C6E C3 09 83         jp EXEC_LOOP
5944  9C71                  ENDIF
5945  9C71
5946  9C71                  IFNDEF UNUSED_OP_SKIP_ARRAY
5947  9C71              OP_SKIP_ARRAY:
5948  9C71 16 00            ld d, 0
5949  9C73 5E               ld e, (hl)
5950  9C74 23               inc hl
5951  9C75 13               inc de
5952  9C76 19               add hl, de
5953  9C77 C3 09 83         jp EXEC_LOOP
5954  9C7A                  ENDIF
5955  9C7A
5956  9C7A                  IFNDEF UNUSED_OP_PUSH_VAL_ARRAY
5957  9C7A              OP_PUSH_VAL_ARRAY:
5958  9C7A 4E               ld c, (hl)
5959  9C7B 23               inc hl
5960  9C7C 5E               ld e, (hl)
5961  9C7D 23               inc hl
5962  9C7E 56               ld d, (hl)
5963  9C7F 23               inc hl
5964  9C80 E5               push hl
5965  9C81 3A BE 5F         ld a, (CHUNK)
5966  9C84 B9               cp c                      ; If the CHUNK is the same...
5967  9C85 28 10            jr z, .same_CHUNK
5968  9C87 F5               push af
5969  9C88 79               ld a, c
5970  9C89 D5               push de
5971  9C8A CD 19 83         call LOAD_CHUNK
5972  9C8D D1               pop de
5973  9C8E CD 9E 9C         call .push_val_array
5974  9C91 F1               pop af
5975  9C92 CD 19 83         call LOAD_CHUNK
5976  9C95 18 03            jr 1f
5977  9C97              .same_CHUNK:
5978  9C97 CD 9E 9C         call .push_val_array
5979  9C9A E1           1:  pop hl
5980  9C9B C3 09 83         jp EXEC_LOOP
5981  9C9E              .push_val_array:
5982  9C9E 1A               ld a, (de)            ;Get size-1
5983  9C9F 13               inc de
5984  9CA0 26 00            ld h, 0
5985  9CA2 DD 6E 00         ld l, (ix+0)          ;Get offset
5986  9CA5 BD               cp l                  ;test if offset > (size-1) (A-C)
5987  9CA6 30 05            jr nc, 2f
5988  9CA8                  ;Error, array out of bounds
5989  9CA8 3E 07            ld a, 7
5990  9CAA C3 00 9F         jp SYS_ERROR
5991  9CAD 19           2:  add hl, de
5992  9CAE 7E               ld a, (hl)
5993  9CAF DD 77 00         ld (ix+0), a
5994  9CB2 C9               ret
5995  9CB3                  ENDIF
5996  9CB3
5997  9CB3                  IFNDEF UNUSED_OP_POP_VAL_ARRAY
5998  9CB3              OP_POP_VAL_ARRAY:
5999  9CB3 4E               ld c, (hl)
6000  9CB4 23               inc hl
6001  9CB5 5E               ld e, (hl)
6002  9CB6 23               inc hl
6003  9CB7 56               ld d, (hl)
6004  9CB8 23               inc hl
6005  9CB9 E5               push hl
6006  9CBA 3A BE 5F         ld a, (CHUNK)
6007  9CBD B9               cp c       ; If the CHUNK is the same...
6008  9CBE 28 10            jr z, .same_CHUNK
6009  9CC0 F5               push af
6010  9CC1 79               ld a, c
6011  9CC2 D5               push de
6012  9CC3 CD 19 83         call LOAD_CHUNK
6013  9CC6 D1               pop de
6014  9CC7 CD D7 9C         call .pop_val_array
6015  9CCA F1               pop af
6016  9CCB CD 19 83         call LOAD_CHUNK
6017  9CCE 18 03            jr 1f
6018  9CD0              .same_CHUNK:
6019  9CD0 CD D7 9C         call .pop_val_array
6020  9CD3 E1           1:  pop hl
6021  9CD4 C3 09 83         jp EXEC_LOOP
6022  9CD7              .pop_val_array:
6023  9CD7 1A               ld a, (de)            ;Get size-1
6024  9CD8 13               inc de
6025  9CD9 26 00            ld h, 0
6026  9CDB DD 6E 00         ld l, (ix+0)          ;Get offset
6027  9CDE BD               cp l                  ;test if offset > (size-1) (A-C)
6028  9CDF DD 7E 01         ld a, (ix+1)          ;Get value
6029  9CE2 30 05            jr nc, 2f
6030  9CE4                  ;Error, array out of bounds
6031  9CE4 3E 07            ld a, 7
6032  9CE6 C3 00 9F         jp SYS_ERROR
6033  9CE9 19           2:  add hl, de
6034  9CEA 77               ld (hl), a
6035  9CEB DD 23            inc ix
6036  9CED DD 23            inc ix
6037  9CEF C9               ret
6038  9CF0                  ENDIF
6039  9CF0
6040  9CF0                  IFNDEF UNUSED_OP_PUSH_LEN_ARRAY
6041  9CF0              OP_PUSH_LEN_ARRAY:
6042  9CF0 4E               ld c, (hl)
6043  9CF1 23               inc hl
6044  9CF2 5E               ld e, (hl)
6045  9CF3 23               inc hl
6046  9CF4 56               ld d, (hl)
6047  9CF5 23               inc hl
6048  9CF6 3A BE 5F         ld a, (CHUNK)
6049  9CF9 B9               cp c                  ; If the CHUNK is the same...
6050  9CFA 28 16            jr z, .same_CHUNK
6051  9CFC E5               push hl
6052  9CFD F5               push af
6053  9CFE 79               ld a, c
6054  9CFF D5               push de
6055  9D00 CD 19 83         call LOAD_CHUNK
6056  9D03 D1               pop de
6057  9D04 1A               ld a, (de)
6058  9D05                  PUSH_INT_STACK
6058  9D05 DD 2B       >    dec ix
6058  9D07 DD 77 00    >    ld (ix+0), a
6059  9D0A F1               pop af
6060  9D0B CD 19 83         call LOAD_CHUNK
6061  9D0E E1               pop hl
6062  9D0F C3 09 83         jp EXEC_LOOP
6063  9D12              .same_CHUNK:
6064  9D12 1A               ld a, (de)
6065  9D13                  PUSH_INT_STACK
6065  9D13 DD 2B       >    dec ix
6065  9D15 DD 77 00    >    ld (ix+0), a
6066  9D18 C3 09 83         jp EXEC_LOOP
6067  9D1B                  ENDIF
6068  9D1B
6069  9D1B ~            /*
6070  9D1B ~
6071  9D1B ~                ld a, (ix+0)
6072  9D1B ~                inc ix
6073  9D1B ~                ld a, (ix+0)
6074  9D1B ~                inc ix
6075  9D1B ~
6076  9D1B ~                MACRO OP_2PARAM_GET_STACK
6077  9D1B ~                ld c, (ix+0)
6078  9D1B ~                ld a, (ix+1)
6079  9D1B ~                ENDM
6080  9D1B ~
6081  9D1B ~                MACRO OP_2PARAM_STORE_STACK
6082  9D1B ~                inc ix
6083  9D1B ~                ld (ix+0), a
6084  9D1B ~                jp EXEC_LOOP
6085  9D1B ~                ENDM
6086  9D1B ~
6087  9D1B ~                MACRO POP_INT_STACK
6088  9D1B ~                ld a, (ix+0)
6089  9D1B ~                inc ix
6090  9D1B ~                ENDM
6091  9D1B ~
6092  9D1B ~                MACRO PUSH_INT_STACK
6093  9D1B ~                dec ix
6094  9D1B ~                ld (ix+0), a
6095  9D1B ~                ENDM
6096  9D1B ~            */
6097  9D1B
6098  9D1B ~            /*
6099  9D1B ~                IFNDEF UNUSED_OP_EXTERN
6100  9D1B ~            OP_EXTERN:
6101  9D1B ~                ld b, (hl)
6102  9D1B ~                inc hl
6103  9D1B ~                ld a, (hl)
6104  9D1B ~                inc hl
6105  9D1B ~                ld (.jump_addr+0), a
6106  9D1B ~                ld a, (hl)
6107  9D1B ~                inc hl
6108  9D1B ~                ld (.jump_addr+1), a
6109  9D1B ~                push hl
6110  9D1B ~                ld a, (CHUNK)
6111  9D1B ~                push af
6112  9D1B ~                cp b       ; If the CHUNK is the same...
6113  9D1B ~                jr z, 1f
6114  9D1B ~                ld a, b
6115  9D1B ~                push hl
6116  9D1B ~                call LOAD_CHUNK
6117  9D1B ~                pop hl
6118  9D1B ~            1:  ld de, FLAGS
6119  9D1B ~            .jump_addr+1:
6120  9D1B ~                call 0-0
6121  9D1B ~                pop bc
6122  9D1B ~                ld a, (CHUNK)
6123  9D1B ~                cp b       ; If the CHUNK is the same...
6124  9D1B ~                jr z, 2f
6125  9D1B ~                ld a, b
6126  9D1B ~                call LOAD_CHUNK
6127  9D1B ~            2:  pop hl
6128  9D1B ~                jp EXEC_LOOP
6129  9D1B ~                ENDIF
6130  9D1B ~            */
6131  9D1B              ;------------------------
6132  9D1B              ERROR_NOP:
6133  9D1B 3E 06            ld a, 6
6134  9D1D C3 00 9F         jp SYS_ERROR
6135  9D20
6136  9D20
6137  9D20 00 00 00...      ALIGN 256
6138  9E00              OPCODES:
6139  9E00 16 83            DW OP_END
6140  9E02 E6 8E            DW OP_TEXT
6141  9E04 ED 8E            DW OP_GOTO
6142  9E06 02 8F            DW OP_GOSUB
6143  9E08 1C 8F            DW OP_RETURN
6144  9E0A                  IFNDEF UNUSED_OP_MARGINS
6145  9E0A 2E 92            DW OP_MARGINS
6146  9E0C                  ENDIF
6147  9E0C                  IFDEF UNUSED_OP_MARGINS
6148  9E0C ~                DW ERROR_NOP
6149  9E0C                  ENDIF
6150  9E0C                  IFNDEF UNUSED_OP_CENTER
6151  9E0C 4F 92            DW OP_CENTER
6152  9E0E                  ENDIF
6153  9E0E                  IFDEF UNUSED_OP_CENTER
6154  9E0E ~                DW ERROR_NOP
6155  9E0E                  ENDIF
6156  9E0E                  IFNDEF UNUSED_OP_AT
6157  9E0E 41 92            DW OP_AT
6158  9E10                  ENDIF
6159  9E10                  IFDEF UNUSED_OP_AT
6160  9E10 ~                DW ERROR_NOP
6161  9E10                  ENDIF
6162  9E10                  IFNDEF UNUSED_OP_SET_D
6163  9E10 A8 8F            DW OP_SET_D
6164  9E12                  ENDIF
6165  9E12                  IFDEF UNUSED_OP_SET_D
6166  9E12 ~                DW ERROR_NOP
6167  9E12                  ENDIF
6168  9E12                  IFNDEF UNUSED_OP_SET_I
6169  9E12 B2 8F            DW OP_SET_I
6170  9E14                  ENDIF
6171  9E14                  IFDEF UNUSED_OP_SET_I
6172  9E14 ~                DW ERROR_NOP
6173  9E14                  ENDIF
6174  9E14                  IFNDEF UNUSED_OP_POP_SET
6175  9E14 59 8F            DW OP_POP_SET
6176  9E16                  ENDIF
6177  9E16                  IFDEF UNUSED_OP_POP_SET
6178  9E16 ~                DW ERROR_NOP
6179  9E16                  ENDIF
6180  9E16                  IFNDEF UNUSED_OP_PUSH_D
6181  9E16 76 8F            DW OP_PUSH_D
6182  9E18                  ENDIF
6183  9E18                  IFDEF UNUSED_OP_PUSH_D
6184  9E18 ~                DW ERROR_NOP
6185  9E18                  ENDIF
6186  9E18                  IFNDEF UNUSED_OP_PUSH_I
6187  9E18 80 8F            DW OP_PUSH_I
6188  9E1A                  ENDIF
6189  9E1A                  IFDEF UNUSED_OP_PUSH_I
6190  9E1A ~                DW ERROR_NOP
6191  9E1A                  ENDIF
6192  9E1A 39 8F            DW OP_IF_GOTO
6193  9E1C 49 8F            DW OP_IF_N_GOTO
6194  9E1E                  IFNDEF UNUSED_OP_PUSH_INKEY
6195  9E1E B9 90            DW OP_PUSH_INKEY
6196  9E20                  ENDIF
6197  9E20                  IFDEF UNUSED_OP_PUSH_INKEY
6198  9E20 ~                DW ERROR_NOP
6199  9E20                  ENDIF
6200  9E20                  IFNDEF UNUSED_OP_PUSH_RANDOM
6201  9E20 DC 90            DW OP_PUSH_RANDOM
6202  9E22                  ENDIF
6203  9E22                  IFDEF UNUSED_OP_PUSH_RANDOM
6204  9E22 ~                DW ERROR_NOP
6205  9E22                  ENDIF
6206  9E22                  IFNDEF UNUSED_OP_NOT
6207  9E22 CC 8F            DW OP_NOT
6208  9E24                  ENDIF
6209  9E24                  IFDEF UNUSED_OP_NOT
6210  9E24 ~                DW ERROR_NOP
6211  9E24                  ENDIF
6212  9E24                  IFNDEF UNUSED_OP_NOT_B
6213  9E24 D7 8F            DW OP_NOT_B
6214  9E26                  ENDIF
6215  9E26                  IFDEF UNUSED_OP_NOT_B
6216  9E26 ~                DW ERROR_NOP
6217  9E26                  ENDIF
6218  9E26                  IFNDEF UNUSED_OP_AND
6219  9E26 E1 8F            DW OP_AND
6220  9E28                  ENDIF
6221  9E28                  IFDEF UNUSED_OP_AND
6222  9E28 ~                DW ERROR_NOP
6223  9E28                  ENDIF
6224  9E28                  IFNDEF UNUSED_OP_OR
6225  9E28 F0 8F            DW OP_OR
6226  9E2A                  ENDIF
6227  9E2A                  IFDEF UNUSED_OP_OR
6228  9E2A ~                DW ERROR_NOP
6229  9E2A                  ENDIF
6230  9E2A                  IFNDEF UNUSED_OP_ADD
6231  9E2A 87 90            DW OP_ADD
6232  9E2C                  ENDIF
6233  9E2C                  IFDEF UNUSED_OP_ADD
6234  9E2C ~                DW ERROR_NOP
6235  9E2C                  ENDIF
6236  9E2C                  IFNDEF UNUSED_OP_SUB
6237  9E2C 9A 90            DW OP_SUB
6238  9E2E                  ENDIF
6239  9E2E                  IFDEF UNUSED_OP_SUB
6240  9E2E ~                DW ERROR_NOP
6241  9E2E                  ENDIF
6242  9E2E                  IFNDEF UNUSED_OP_CP_EQ
6243  9E2E FF 8F            DW OP_CP_EQ
6244  9E30                  ENDIF
6245  9E30                  IFDEF UNUSED_OP_CP_EQ
6246  9E30 ~                DW ERROR_NOP
6247  9E30                  ENDIF
6248  9E30                  IFNDEF UNUSED_OP_CP_NE
6249  9E30 15 90            DW OP_CP_NE
6250  9E32                  ENDIF
6251  9E32                  IFDEF UNUSED_OP_CP_NE
6252  9E32 ~                DW ERROR_NOP
6253  9E32                  ENDIF
6254  9E32                  IFNDEF UNUSED_OP_CP_LE
6255  9E32 6F 90            DW OP_CP_LE
6256  9E34                  ENDIF
6257  9E34                  IFDEF UNUSED_OP_CP_LE
6258  9E34 ~                DW ERROR_NOP
6259  9E34                  ENDIF
6260  9E34                  IFNDEF UNUSED_OP_CP_ME
6261  9E34 41 90            DW OP_CP_ME
6262  9E36                  ENDIF
6263  9E36                  IFDEF UNUSED_OP_CP_ME
6264  9E36 ~                DW ERROR_NOP
6265  9E36                  ENDIF
6266  9E36                  IFNDEF UNUSED_OP_CP_LT
6267  9E36 2B 90            DW OP_CP_LT
6268  9E38                  ENDIF
6269  9E38                  IFDEF UNUSED_OP_CP_LT
6270  9E38 ~                DW ERROR_NOP
6271  9E38                  ENDIF
6272  9E38                  IFNDEF UNUSED_OP_CP_MT
6273  9E38 57 90            DW OP_CP_MT
6274  9E3A                  ENDIF
6275  9E3A                  IFDEF UNUSED_OP_CP_MT
6276  9E3A ~                DW ERROR_NOP
6277  9E3A                  ENDIF
6278  9E3A                  IFNDEF UNUSED_OP_INK_D
6279  9E3A 5F 91            DW OP_INK_D
6280  9E3C                  ENDIF
6281  9E3C                  IFDEF UNUSED_OP_INK_D
6282  9E3C ~                DW ERROR_NOP
6283  9E3C                  ENDIF
6284  9E3C                  IFNDEF UNUSED_OP_PAPER_D
6285  9E3C 68 91            DW OP_PAPER_D
6286  9E3E                  ENDIF
6287  9E3E                  IFDEF UNUSED_OP_PAPER_D
6288  9E3E ~                DW ERROR_NOP
6289  9E3E                  ENDIF
6290  9E3E                  IFNDEF UNUSED_OP_BORDER_D
6291  9E3E 85 91            DW OP_BORDER_D
6292  9E40                  ENDIF
6293  9E40                  IFDEF UNUSED_OP_BORDER_D
6294  9E40 ~                DW ERROR_NOP
6295  9E40                  ENDIF
6296  9E40                  IFNDEF UNUSED_OP_PRINT_D
6297  9E40 8E 91            DW OP_PRINT_D
6298  9E42                  ENDIF
6299  9E42                  IFDEF UNUSED_OP_PRINT_D
6300  9E42 ~                DW ERROR_NOP
6301  9E42                  ENDIF
6302  9E42                  IFNDEF UNUSED_OP_INK_I
6303  9E42 98 91            DW OP_INK_I
6304  9E44                  ENDIF
6305  9E44                  IFDEF UNUSED_OP_INK_I
6306  9E44 ~                DW ERROR_NOP
6307  9E44                  ENDIF
6308  9E44                  IFNDEF UNUSED_OP_PAPER_I
6309  9E44 A4 91            DW OP_PAPER_I
6310  9E46                  ENDIF
6311  9E46                  IFDEF UNUSED_OP_PAPER_I
6312  9E46 ~                DW ERROR_NOP
6313  9E46                  ENDIF
6314  9E46                  IFNDEF UNUSED_OP_BORDER_I
6315  9E46 CA 91            DW OP_BORDER_I
6316  9E48                  ENDIF
6317  9E48                  IFDEF UNUSED_OP_BORDER_I
6318  9E48 ~                DW ERROR_NOP
6319  9E48                  ENDIF
6320  9E48                  IFNDEF UNUSED_OP_PRINT_I
6321  9E48 D6 91            DW OP_PRINT_I
6322  9E4A                  ENDIF
6323  9E4A                  IFDEF UNUSED_OP_PRINT_I
6324  9E4A ~                DW ERROR_NOP
6325  9E4A                  ENDIF
6326  9E4A                  IFNDEF UNUSED_OP_BRIGHT_D
6327  9E4A 71 91            DW OP_BRIGHT_D
6328  9E4C                  ENDIF
6329  9E4C                  IFDEF UNUSED_OP_BRIGHT_D
6330  9E4C ~                DW ERROR_NOP
6331  9E4C                  ENDIF
6332  9E4C                  IFNDEF UNUSED_OP_FLASH_D
6333  9E4C 7B 91            DW OP_FLASH_D
6334  9E4E                  ENDIF
6335  9E4E                  IFDEF UNUSED_OP_FLASH_D
6336  9E4E ~                DW ERROR_NOP
6337  9E4E                  ENDIF
6338  9E4E                  IFNDEF UNUSED_OP_BRIGHT_I
6339  9E4E B0 91            DW OP_BRIGHT_I
6340  9E50                  ENDIF
6341  9E50                  IFDEF UNUSED_OP_BRIGHT_I
6342  9E50 ~                DW ERROR_NOP
6343  9E50                  ENDIF
6344  9E50                  IFNDEF UNUSED_OP_FLASH_I
6345  9E50 BD 91            DW OP_FLASH_I
6346  9E52                  ENDIF
6347  9E52                  IFDEF UNUSED_OP_FLASH_I
6348  9E52 ~                DW ERROR_NOP
6349  9E52                  ENDIF
6350  9E52                  IFNDEF UNUSED_OP_PICTURE_D
6351  9E52 56 92            DW OP_PICTURE_D
6352  9E54                  ENDIF
6353  9E54                  IFDEF UNUSED_OP_PICTURE_D
6354  9E54 ~                DW ERROR_NOP
6355  9E54                  ENDIF
6356  9E54                  IFNDEF UNUSED_OP_DISPLAY_D
6357  9E54 60 92            DW OP_DISPLAY_D
6358  9E56                  ENDIF
6359  9E56                  IFDEF UNUSED_OP_DISPLAY_D
6360  9E56 ~                DW ERROR_NOP
6361  9E56                  ENDIF
6362  9E56                  IFNDEF UNUSED_OP_PICTURE_I
6363  9E56 6E 92            DW OP_PICTURE_I
6364  9E58                  ENDIF
6365  9E58                  IFDEF UNUSED_OP_PICTURE_I
6366  9E58 ~                DW ERROR_NOP
6367  9E58                  ENDIF
6368  9E58                  IFNDEF UNUSED_OP_DISPLAY_I
6369  9E58 7B 92            DW OP_DISPLAY_I
6370  9E5A                  ENDIF
6371  9E5A                  IFDEF UNUSED_OP_DISPLAY_I
6372  9E5A ~                DW ERROR_NOP
6373  9E5A                  ENDIF
6374  9E5A                  IFNDEF UNUSED_OP_RANDOM
6375  9E5A 01 91            DW OP_RANDOM
6376  9E5C                  ENDIF
6377  9E5C                  IFDEF UNUSED_OP_RANDOM
6378  9E5C ~                DW ERROR_NOP
6379  9E5C                  ENDIF
6380  9E5C                  IFNDEF UNUSED_OP_OPTION
6381  9E5C BD 92            DW OP_OPTION
6382  9E5E                  ENDIF
6383  9E5E                  IFDEF UNUSED_OP_OPTION
6384  9E5E ~                DW ERROR_NOP
6385  9E5E                  ENDIF
6386  9E5E                  IFNDEF UNUSED_OP_WAITKEY
6387  9E5E 51 93            DW OP_WAITKEY
6388  9E60                  ENDIF
6389  9E60                  IFDEF UNUSED_OP_WAITKEY
6390  9E60 ~                DW ERROR_NOP
6391  9E60                  ENDIF
6392  9E60                  IFNDEF UNUSED_OP_INKEY
6393  9E60 AC 90            DW OP_INKEY
6394  9E62                  ENDIF
6395  9E62                  IFDEF UNUSED_OP_INKEY
6396  9E62 ~                DW ERROR_NOP
6397  9E62                  ENDIF
6398  9E62                  IFNDEF UNUSED_OP_WAIT
6399  9E62 AA 92            DW OP_WAIT
6400  9E64                  ENDIF
6401  9E64                  IFDEF UNUSED_OP_WAIT
6402  9E64 ~                DW ERROR_NOP
6403  9E64                  ENDIF
6404  9E64                  IFNDEF UNUSED_OP_PAUSE
6405  9E64 97 93            DW OP_PAUSE
6406  9E66                  ENDIF
6407  9E66                  IFDEF UNUSED_OP_PAUSE
6408  9E66 ~                DW ERROR_NOP
6409  9E66                  ENDIF
6410  9E66                  IFNDEF UNUSED_OP_CHOOSE
6411  9E66 ED 93            DW OP_CHOOSE
6412  9E68                  ENDIF
6413  9E68                  IFDEF UNUSED_OP_CHOOSE
6414  9E68 ~                DW ERROR_NOP
6415  9E68                  ENDIF
6416  9E68                  IFNDEF UNUSED_OP_CHOOSE_W
6417  9E68 0F 95            DW OP_CHOOSE_W
6418  9E6A                  ENDIF
6419  9E6A                  IFDEF UNUSED_OP_CHOOSE_W
6420  9E6A ~                DW ERROR_NOP
6421  9E6A                  ENDIF
6422  9E6A                  IFNDEF UNUSED_OP_TYPERATE
6423  9E6A C1 97            DW OP_TYPERATE
6424  9E6C                  ENDIF
6425  9E6C                  IFDEF UNUSED_OP_TYPERATE
6426  9E6C ~                DW ERROR_NOP
6427  9E6C                  ENDIF
6428  9E6C                  IFNDEF UNUSED_OP_CLEAR
6429  9E6C CC 97            DW OP_CLEAR
6430  9E6E                  ENDIF
6431  9E6E                  IFDEF UNUSED_OP_CLEAR
6432  9E6E ~                DW ERROR_NOP
6433  9E6E                  ENDIF
6434  9E6E                  IFNDEF UNUSED_OP_PAGEPAUSE
6435  9E6E D4 97            DW OP_PAGEPAUSE
6436  9E70                  ENDIF
6437  9E70                  IFDEF UNUSED_OP_PAGEPAUSE
6438  9E70 ~                DW ERROR_NOP
6439  9E70                  ENDIF
6440  9E70                  IFNDEF UNUSED_OP_CHAR_D
6441  9E70 DC 97            DW OP_CHAR_D
6442  9E72                  ENDIF
6443  9E72                  IFDEF UNUSED_OP_CHAR_D
6444  9E72 ~                DW ERROR_NOP
6445  9E72                  ENDIF
6446  9E72                  IFNDEF UNUSED_OP_TAB
6447  9E72 00 98            DW OP_TAB
6448  9E74                  ENDIF
6449  9E74                  IFDEF UNUSED_OP_TAB
6450  9E74 ~                DW ERROR_NOP
6451  9E74                  ENDIF
6452  9E74                  IFNDEF UNUSED_OP_REPCHAR
6453  9E74 07 98            DW OP_REPCHAR
6454  9E76                  ENDIF
6455  9E76                  IFDEF UNUSED_OP_REPCHAR
6456  9E76 ~                DW ERROR_NOP
6457  9E76                  ENDIF
6458  9E76                  IFNDEF UNUSED_OP_SFX_D
6459  9E76 35 98            DW OP_SFX_D
6460  9E78                  ENDIF
6461  9E78                  IFDEF UNUSED_OP_SFX_D
6462  9E78 ~                DW ERROR_NOP
6463  9E78                  ENDIF
6464  9E78                  IFNDEF UNUSED_OP_SFX_I
6465  9E78 4C 98            DW OP_SFX_I
6466  9E7A                  ENDIF
6467  9E7A                  IFDEF UNUSED_OP_SFX_I
6468  9E7A ~                DW ERROR_NOP
6469  9E7A                  ENDIF
6470  9E7A                  IFNDEF UNUSED_OP_TRACK_D
6471  9E7A 7E 98            DW OP_TRACK_D
6472  9E7C                  ENDIF
6473  9E7C                  IFDEF UNUSED_OP_TRACK_D
6474  9E7C ~                DW ERROR_NOP
6475  9E7C                  ENDIF
6476  9E7C                  IFNDEF UNUSED_OP_TRACK_I
6477  9E7C 83 98            DW OP_TRACK_I
6478  9E7E                  ENDIF
6479  9E7E                  IFDEF UNUSED_OP_TRACK_I
6480  9E7E ~                DW ERROR_NOP
6481  9E7E                  ENDIF
6482  9E7E                  IFNDEF UNUSED_OP_PLAY_D
6483  9E7E 93 98            DW OP_PLAY_D
6484  9E80                  ENDIF
6485  9E80                  IFDEF UNUSED_OP_PLAY_D
6486  9E80 ~                DW ERROR_NOP
6487  9E80                  ENDIF
6488  9E80                  IFNDEF UNUSED_OP_PLAY_I
6489  9E80 98 98            DW OP_PLAY_I
6490  9E82                  ENDIF
6491  9E82                  IFDEF UNUSED_OP_PLAY_I
6492  9E82 ~                DW ERROR_NOP
6493  9E82                  ENDIF
6494  9E82                  IFNDEF UNUSED_OP_LOOP_D
6495  9E82 A8 98            DW OP_LOOP_D
6496  9E84                  ENDIF
6497  9E84                  IFDEF UNUSED_OP_LOOP_D
6498  9E84 ~                DW ERROR_NOP
6499  9E84                  ENDIF
6500  9E84                  IFNDEF UNUSED_OP_LOOP_I
6501  9E84 AD 98            DW OP_LOOP_I
6502  9E86                  ENDIF
6503  9E86                  IFDEF UNUSED_OP_LOOP_I
6504  9E86 ~                DW ERROR_NOP
6505  9E86                  ENDIF
6506  9E86                  IFNDEF UNUSED_OP_RANDOMIZE
6507  9E86 36 91            DW OP_RANDOMIZE
6508  9E88                  ENDIF
6509  9E88                  IFDEF UNUSED_OP_RANDOMIZE
6510  9E88 ~                DW ERROR_NOP
6511  9E88                  ENDIF
6512  9E88                  IFNDEF UNUSED_OP_POP_AT
6513  9E88 3E 91            DW OP_POP_AT
6514  9E8A                  ENDIF
6515  9E8A                  IFDEF UNUSED_OP_POP_AT
6516  9E8A ~                DW ERROR_NOP
6517  9E8A                  ENDIF
6518  9E8A                  IFNDEF UNUSED_OP_NEWLINE
6519  9E8A 19 98            DW OP_NEWLINE
6520  9E8C                  ENDIF
6521  9E8C                  IFDEF UNUSED_OP_NEWLINE
6522  9E8C ~                DW ERROR_NOP
6523  9E8C                  ENDIF
6524  9E8C                  IFNDEF UNUSED_OP_SET_DI
6525  9E8C BE 8F            DW OP_SET_DI
6526  9E8E                  ENDIF
6527  9E8E                  IFDEF UNUSED_OP_SET_DI
6528  9E8E ~                DW ERROR_NOP
6529  9E8E                  ENDIF
6530  9E8E                  IFNDEF UNUSED_OP_POP_SET_DI
6531  9E8E 66 8F            DW OP_POP_SET_DI
6532  9E90                  ENDIF
6533  9E90                  IFDEF UNUSED_OP_POP_SET_DI
6534  9E90 ~                DW ERROR_NOP
6535  9E90                  ENDIF
6536  9E90                  IFNDEF UNUSED_OP_PUSH_DI
6537  9E90 8D 8F            DW OP_PUSH_DI
6538  9E92                  ENDIF
6539  9E92                  IFDEF UNUSED_OP_PUSH_DI
6540  9E92 ~                DW ERROR_NOP
6541  9E92                  ENDIF
6542  9E92                  IFNDEF UNUSED_OP_POP_INK
6543  9E92 E3 91            DW OP_POP_INK
6544  9E94                  ENDIF
6545  9E94                  IFDEF UNUSED_OP_POP_INK
6546  9E94 ~                DW ERROR_NOP
6547  9E94                  ENDIF
6548  9E94                  IFNDEF UNUSED_OP_POP_PAPER
6549  9E94 EF 91            DW OP_POP_PAPER
6550  9E96                  ENDIF
6551  9E96                  IFDEF UNUSED_OP_POP_PAPER
6552  9E96 ~                DW ERROR_NOP
6553  9E96                  ENDIF
6554  9E96                  IFNDEF UNUSED_OP_POP_BORDER
6555  9E96 15 92            DW OP_POP_BORDER
6556  9E98                  ENDIF
6557  9E98                  IFDEF UNUSED_OP_POP_BORDER
6558  9E98 ~                DW ERROR_NOP
6559  9E98                  ENDIF
6560  9E98                  IFNDEF UNUSED_OP_POP_BRIGHT
6561  9E98 FB 91            DW OP_POP_BRIGHT
6562  9E9A                  ENDIF
6563  9E9A                  IFDEF UNUSED_OP_POP_BRIGHT
6564  9E9A ~                DW ERROR_NOP
6565  9E9A                  ENDIF
6566  9E9A                  IFNDEF UNUSED_OP_POP_FLASH
6567  9E9A 08 92            DW OP_POP_FLASH
6568  9E9C                  ENDIF
6569  9E9C                  IFDEF UNUSED_OP_POP_FLASH
6570  9E9C ~                DW ERROR_NOP
6571  9E9C                  ENDIF
6572  9E9C                  IFNDEF UNUSED_OP_POP_PRINT
6573  9E9C 21 92            DW OP_POP_PRINT
6574  9E9E                  ENDIF
6575  9E9E                  IFDEF UNUSED_OP_POP_PRINT
6576  9E9E ~                DW ERROR_NOP
6577  9E9E                  ENDIF
6578  9E9E                  IFNDEF UNUSED_OP_CHAR_I
6579  9E9E E6 97            DW OP_CHAR_I
6580  9EA0                  ENDIF
6581  9EA0                  IFDEF UNUSED_OP_CHAR_I
6582  9EA0 ~                DW ERROR_NOP
6583  9EA0                  ENDIF
6584  9EA0                  IFNDEF UNUSED_OP_POP_CHAR
6585  9EA0 F3 97            DW OP_POP_CHAR
6586  9EA2                  ENDIF
6587  9EA2                  IFDEF UNUSED_OP_POP_CHAR
6588  9EA2 ~                DW ERROR_NOP
6589  9EA2                  ENDIF
6590  9EA2                  IFNDEF UNUSED_OP_POP_PICTURE
6591  9EA2 8C 92            DW OP_POP_PICTURE
6592  9EA4                  ENDIF
6593  9EA4                  IFDEF UNUSED_OP_POP_PICTURE
6594  9EA4 ~                DW ERROR_NOP
6595  9EA4                  ENDIF
6596  9EA4                  IFNDEF UNUSED_OP_POP_DISPLAY
6597  9EA4 99 92            DW OP_POP_DISPLAY
6598  9EA6                  ENDIF
6599  9EA6                  IFDEF UNUSED_OP_POP_DISPLAY
6600  9EA6 ~                DW ERROR_NOP
6601  9EA6                  ENDIF
6602  9EA6                  IFNDEF UNUSED_OP_POP_SFX
6603  9EA6 65 98            DW OP_POP_SFX
6604  9EA8                  ENDIF
6605  9EA8                  IFDEF UNUSED_OP_POP_SFX
6606  9EA8 ~                DW ERROR_NOP
6607  9EA8                  ENDIF
6608  9EA8                  IFNDEF UNUSED_OP_POP_TRACK
6609  9EA8 8B 98            DW OP_POP_TRACK
6610  9EAA                  ENDIF
6611  9EAA                  IFDEF UNUSED_OP_POP_TRACK
6612  9EAA ~                DW ERROR_NOP
6613  9EAA                  ENDIF
6614  9EAA                  IFNDEF UNUSED_OP_POP_PLAY
6615  9EAA A0 98            DW OP_POP_PLAY
6616  9EAC                  ENDIF
6617  9EAC                  IFDEF UNUSED_OP_POP_PLAY
6618  9EAC ~                DW ERROR_NOP
6619  9EAC                  ENDIF
6620  9EAC                  IFNDEF UNUSED_OP_POP_LOOP
6621  9EAC B5 98            DW OP_POP_LOOP
6622  9EAE                  ENDIF
6623  9EAE                  IFDEF UNUSED_OP_POP_LOOP
6624  9EAE ~                DW ERROR_NOP
6625  9EAE                  ENDIF
6626  9EAE                  IFNDEF UNUSED_OP_POP_PUSH_I
6627  9EAE 9C 8F            DW OP_POP_PUSH_I
6628  9EB0                  ENDIF
6629  9EB0                  IFDEF UNUSED_OP_POP_PUSH_I
6630  9EB0 ~                DW ERROR_NOP
6631  9EB0                  ENDIF
6632  9EB0                  IFNDEF UNUSED_OP_SET_XPOS
6633  9EB0 BD 98            DW OP_SET_XPOS
6634  9EB2                  ENDIF
6635  9EB2                  IFDEF UNUSED_OP_SET_XPOS
6636  9EB2 ~                DW ERROR_NOP
6637  9EB2                  ENDIF
6638  9EB2                  IFNDEF UNUSED_OP_SET_YPOS
6639  9EB2 CE 98            DW OP_SET_YPOS
6640  9EB4                  ENDIF
6641  9EB4                  IFDEF UNUSED_OP_SET_YPOS
6642  9EB4 ~                DW ERROR_NOP
6643  9EB4                  ENDIF
6644  9EB4                  IFNDEF UNUSED_OP_PUSH_XPOS
6645  9EB4 D9 98            DW OP_PUSH_XPOS
6646  9EB6                  ENDIF
6647  9EB6                  IFDEF UNUSED_OP_PUSH_XPOS
6648  9EB6 ~                DW ERROR_NOP
6649  9EB6                  ENDIF
6650  9EB6                  IFNDEF UNUSED_OP_PUSH_YPOS
6651  9EB6 EA 98            DW OP_PUSH_YPOS
6652  9EB8                  ENDIF
6653  9EB8                  IFDEF UNUSED_OP_PUSH_YPOS
6654  9EB8 ~                DW ERROR_NOP
6655  9EB8                  ENDIF
6656  9EB8                  IFNDEF UNUSED_OP_MAX
6657  9EB8 F5 98            DW OP_MIN
6658  9EBA                  ENDIF
6659  9EBA                  IFDEF UNUSED_OP_MIN
6660  9EBA ~                DW ERROR_NOP
6661  9EBA                  ENDIF
6662  9EBA                  IFNDEF UNUSED_OP_MAX
6663  9EBA 07 99            DW OP_MAX
6664  9EBC                  ENDIF
6665  9EBC                  IFDEF UNUSED_OP_MAX
6666  9EBC ~                DW ERROR_NOP
6667  9EBC                  ENDIF
6668  9EBC                  IFNDEF UNUSED_OP_BLIT
6669  9EBC 9D 99            DW OP_BLIT
6670  9EBE                  ENDIF
6671  9EBE                  IFDEF UNUSED_OP_BLIT
6672  9EBE ~                DW ERROR_NOP
6673  9EBE                  ENDIF
6674  9EBE                  IFNDEF UNUSED_OP_POP_BLIT
6675  9EBE 82 99            DW OP_POP_BLIT
6676  9EC0                  ENDIF
6677  9EC0                  IFDEF UNUSED_OP_POP_BLIT
6678  9EC0 ~                DW ERROR_NOP
6679  9EC0                  ENDIF
6680  9EC0                  IFNDEF UNUSED_OP_MENUCONFIG
6681  9EC0 3F 99            DW OP_MENUCONFIG
6682  9EC2                  ENDIF
6683  9EC2                  IFDEF UNUSED_OP_MENUCONFIG
6684  9EC2 ~                DW ERROR_NOP
6685  9EC2                  ENDIF
6686  9EC2                  IFNDEF UNUSED_OP_POP_MENUCONFIG
6687  9EC2 23 99            DW OP_POP_MENUCONFIG
6688  9EC4                  ENDIF
6689  9EC4                  IFDEF UNUSED_OP_POP_MENUCONFIG
6690  9EC4 ~                DW ERROR_NOP
6691  9EC4                  ENDIF
6692  9EC4                  IFNDEF UNUSED_OP_PUSH_IS_DISK
6693  9EC4 19 99            DW OP_PUSH_IS_DISK
6694  9EC6                  ENDIF
6695  9EC6                  IFDEF UNUSED_OP_PUSH_IS_DISK
6696  9EC6 ~                DW ERROR_NOP
6697  9EC6                  ENDIF
6698  9EC6                  IFNDEF UNUSED_OP_BACKSPACE
6699  9EC6 27 98            DW OP_BACKSPACE
6700  9EC8                  ENDIF
6701  9EC8                  IFDEF UNUSED_OP_BACKSPACE
6702  9EC8 ~                DW ERROR_NOP
6703  9EC8                  ENDIF
6704  9EC8                  IFNDEF UNUSED_OP_RAMLOAD
6705  9EC8 A3 9B            DW OP_RAMLOAD
6706  9ECA                  ENDIF
6707  9ECA                  IFDEF UNUSED_OP_RAMLOAD
6708  9ECA ~                DW ERROR_NOP
6709  9ECA                  ENDIF
6710  9ECA                  IFNDEF UNUSED_OP_RAMSAVE
6711  9ECA B2 9B            DW OP_RAMSAVE
6712  9ECC                  ENDIF
6713  9ECC                  IFDEF UNUSED_OP_RAMSAVE
6714  9ECC ~                DW ERROR_NOP
6715  9ECC                  ENDIF
6716  9ECC                  IFNDEF UNUSED_OP_POP_SLOT_LOAD
6717  9ECC C1 9B            DW OP_POP_SLOT_LOAD
6718  9ECE                  ENDIF
6719  9ECE                  IFDEF UNUSED_OP_POP_SLOT_LOAD
6720  9ECE ~                DW ERROR_NOP
6721  9ECE                  ENDIF
6722  9ECE                  IFNDEF UNUSED_OP_POP_SLOT_SAVE
6723  9ECE CF 9B            DW OP_POP_SLOT_SAVE
6724  9ED0                  ENDIF
6725  9ED0                  IFDEF UNUSED_OP_POP_SLOT_SAVE
6726  9ED0 ~                DW ERROR_NOP
6727  9ED0                  ENDIF
6728  9ED0                  IFNDEF UNUSED_OP_PUSH_SAVE_RESULT
6729  9ED0 E4 9B            DW OP_PUSH_SAVE_RESULT
6730  9ED2                  ENDIF
6731  9ED2                  IFDEF UNUSED_OP_PUSH_SAVE_RESULT
6732  9ED2 ~                DW ERROR_NOP
6733  9ED2                  ENDIF
6734  9ED2                  IFNDEF UNUSED_OP_FADEOUT
6735  9ED2 BB 9A            DW OP_FADEOUT
6736  9ED4                  ENDIF
6737  9ED4                  IFDEF UNUSED_OP_FADEOUT
6738  9ED4 ~                DW ERROR_NOP
6739  9ED4                  ENDIF
6740  9ED4                  IFNDEF UNUSED_OP_FILLATTR
6741  9ED4 F6 9A            DW OP_FILLATTR
6742  9ED6                  ENDIF
6743  9ED6                  IFDEF UNUSED_OP_FILLATTR
6744  9ED6 ~                DW ERROR_NOP
6745  9ED6                  ENDIF
6746  9ED6                  IFNDEF UNUSED_OP_PUTATTR
6747  9ED6 22 9B            DW OP_PUTATTR
6748  9ED8                  ENDIF
6749  9ED8                  IFDEF UNUSED_OP_PUTATTR
6750  9ED8 ~                DW ERROR_NOP
6751  9ED8                  ENDIF
6752  9ED8                  IFNDEF UNUSED_OP_POP_PUTATTR
6753  9ED8 35 9B            DW OP_POP_PUTATTR
6754  9EDA                  ENDIF
6755  9EDA                  IFDEF UNUSED_OP_POP_PUTATTR
6756  9EDA ~                DW ERROR_NOP
6757  9EDA                  ENDIF
6758  9EDA                  IFNDEF UNUSED_OP_CHOOSE_CH
6759  9EDA 44 96            DW OP_CHOOSE_CH
6760  9EDC                  ENDIF
6761  9EDC                  IFDEF UNUSED_OP_CHOOSE_CH
6762  9EDC ~                DW ERROR_NOP
6763  9EDC                  ENDIF
6764  9EDC                  IFNDEF UNUSED_OP_PUSH_OPTION_ST
6765  9EDC AC 97            DW OP_PUSH_OPTION_ST
6766  9EDE                  ENDIF
6767  9EDE                  IFDEF UNUSED_OP_PUSH_OPTION_ST
6768  9EDE ~                DW ERROR_NOP
6769  9EDE                  ENDIF
6770  9EDE                  IFNDEF UNUSED_OP_CLEAR_OPTIONS
6771  9EDE A5 97            DW OP_CLEAR_OPTIONS
6772  9EE0                  ENDIF
6773  9EE0                  IFDEF UNUSED_OP_CLEAR_OPTIONS
6774  9EE0 ~                DW ERROR_NOP
6775  9EE0                  ENDIF
6776  9EE0                  IFNDEF UNUSED_OP_PUSH_GETATTR
6777  9EE0 76 9B            DW OP_PUSH_GETATTR
6778  9EE2                  ENDIF
6779  9EE2                  IFDEF UNUSED_OP_PUSH_GETATTR
6780  9EE2 ~                DW ERROR_NOP
6781  9EE2                  ENDIF
6782  9EE2                  IFNDEF UNUSED_OP_POP_ALL_BLIT
6783  9EE2 4D 99            DW OP_POP_ALL_BLIT
6784  9EE4                  ENDIF
6785  9EE4                  IFDEF UNUSED_OP_POP_ALL_BLIT
6786  9EE4 ~                DW ERROR_NOP
6787  9EE4                  ENDIF
6788  9EE4                  IFNDEF UNUSED_OP_SHIFT_R
6789  9EE4 EF 9B            DW OP_SHIFT_R
6790  9EE6                  ENDIF
6791  9EE6                  IFDEF UNUSED_OP_SHIFT_R
6792  9EE6 ~                DW ERROR_NOP
6793  9EE6                  ENDIF
6794  9EE6                  IFNDEF UNUSED_OP_SHIFT_L
6795  9EE6 05 9C            DW OP_SHIFT_L
6796  9EE8                  ENDIF
6797  9EE8                  IFDEF UNUSED_OP_SHIFT_L
6798  9EE8 ~                DW ERROR_NOP
6799  9EE8                  ENDIF
6800  9EE8                  IFNDEF UNUSED_OP_POP_ALL_PUTATTR
6801  9EE8 4E 9B            DW OP_POP_ALL_PUTATTR
6802  9EEA                  ENDIF
6803  9EEA                  IFDEF UNUSED_OP_POP_ALL_PUTATTR
6804  9EEA ~                DW ERROR_NOP
6805  9EEA                  ENDIF
6806  9EEA                  IFNDEF UNUSED_OP_POP_FILLATTR
6807  9EEA DE 9A            DW OP_POP_FILLATTR
6808  9EEC                  ENDIF
6809  9EEC                  IFDEF UNUSED_OP_POP_FILLATTR
6810  9EEC ~                DW ERROR_NOP
6811  9EEC                  ENDIF
6812  9EEC                  IFNDEF UNUSED_OP_POP_VAL_OPTION
6813  9EEC 05 93            DW OP_POP_VAL_OPTION
6814  9EEE                  ENDIF
6815  9EEE                  IFDEF UNUSED_OP_POP_VAL_OPTION
6816  9EEE ~                DW ERROR_NOP
6817  9EEE                  ENDIF
6818  9EEE                  IFNDEF UNUSED_OP_WINDOW
6819  9EEE 1B 9C            DW OP_WINDOW
6820  9EF0                  ENDIF
6821  9EF0                  IFDEF UNUSED_OP_WINDOW
6822  9EF0 ~                DW ERROR_NOP
6823  9EF0                  ENDIF
6824  9EF0                  IFNDEF UNUSED_OP_CHARSET
6825  9EF0 5A 9C            DW OP_CHARSET
6826  9EF2                  ENDIF
6827  9EF2                  IFDEF UNUSED_OP_CHARSET
6828  9EF2 ~                DW ERROR_NOP
6829  9EF2                  ENDIF
6830  9EF2                  IFNDEF UNUSED_OP_SKIP_ARRAY
6831  9EF2 71 9C            DW OP_SKIP_ARRAY
6832  9EF4                  ENDIF
6833  9EF4                  IFDEF UNUSED_OP_SKIP_ARRAY
6834  9EF4 ~                DW ERROR_NOP
6835  9EF4                  ENDIF
6836  9EF4                  IFNDEF UNUSED_OP_PUSH_VAL_ARRAY
6837  9EF4 7A 9C            DW OP_PUSH_VAL_ARRAY
6838  9EF6                  ENDIF
6839  9EF6                  IFDEF UNUSED_OP_PUSH_VAL_ARRAY
6840  9EF6 ~                DW ERROR_NOP
6841  9EF6                  ENDIF
6842  9EF6                  IFNDEF UNUSED_OP_POP_VAL_ARRAY
6843  9EF6 B3 9C            DW OP_POP_VAL_ARRAY
6844  9EF8                  ENDIF
6845  9EF8                  IFDEF UNUSED_OP_POP_VAL_ARRAY
6846  9EF8 ~                DW ERROR_NOP
6847  9EF8                  ENDIF
6848  9EF8                  IFNDEF UNUSED_OP_PUSH_LEN_ARRAY
6849  9EF8 F0 9C            DW OP_PUSH_LEN_ARRAY
6850  9EFA                  ENDIF
6851  9EFA                  IFDEF UNUSED_OP_PUSH_LEN_ARRAY
6852  9EFA ~                DW ERROR_NOP
6853  9EFA                  ENDIF
6854  9EFA                  IFNDEF UNUSED_OP_SET_KEMPSTON
6855  9EFA C6 90            DW OP_SET_KEMPSTON
6856  9EFC                  ENDIF
6857  9EFC                  IFDEF UNUSED_OP_SET_KEMPSTON
6858  9EFC ~                DW ERROR_NOP
6859  9EFC                  ENDIF
6860  9EFC                  IFNDEF UNUSED_OP_PUSH_KEMPSTON
6861  9EFC D1 90            DW OP_PUSH_KEMPSTON
6862  9EFE                  ENDIF
6863  9EFE                  IFDEF UNUSED_OP_PUSH_KEMPSTON
6864  9EFE ~                DW ERROR_NOP
6865  9EFE                  ENDIF
6866  9EFE
6867  9EFE                  IFDEF USE_256_OPCODES
6868  9EFE ~                REPT 256-(($-OPCODES)/2)
6869  9EFE ~                DW ERROR_NOP
6870  9EFE ~                ENDR
6871  9EFE                  ENDIF
6872  9EFE                  IFNDEF USE_256_OPCODES
6873  9EFE                  REPT 128-(($-OPCODES)/2)
6874  9EFE 1B 9D       >    DW ERROR_NOP
6875  9F00                  ENDR
6876  9F00                  ENDIF
6877  9F00
6878  9F00
6879  9F00
6880  9F00              BEEPFX_AVAILABLE      EQU 0
6881  9F00              BEEPFX              EQU $0
6882  9F00              SFX_ID              EQU BEEPFX+1
6883  9F00
6884  9F00              ;----------------------------------------------------
6885  9F00              ; System Error message
6886  9F00              ; A = Error number
6887  9F00              SYS_ERROR:
6888  9F00 B7               or a
6889  9F01 F5               push af
6890  9F02 3E F2            ld a, %11110010
6891  9F04 32 8D 5C         ld (ATTR_P), a
6892  9F07 CD 0E 87         call INIT_WIN
6893  9F0A 21 16 9F         ld hl, SYS_ERROR_MSG
6894  9F0D CD C3 8A         call PRINT_STR
6895  9F10 F1               pop af
6896  9F11 CD D1 8B         call PRINT_A_BYTE
6897  9F14              .endless:
6898  9F14 18 FE            jr .endless
6899  9F16
6900  9F16              SYS_ERROR_MSG:
6901  9F16 53 59 53 54      DB "SYSTEM ERROR No:",0
6901  9F1A 45 4D 20 45
6901  9F1E 52 52 4F 52
6901  9F22 20 4E 6F 3A
6901  9F26 00
6902  9F27              ;---------------------------------------------------
6903  9F27 2D 9F        TOKENS_ADDR         DW TOKENS
6904  9F29 78 9F        CHARSET_ADDR        DW CHARSET_S
6905  9F2B 78 A7        CHARSET_WIDTHS_ADDR DW CHARSET_W
6906  9F2D
6907  9F2D              TOKENS:
6908  9F2D 49 4E 43 4C      DEFB $49, $4E, $43, $4C, $55, $44, $45, $A0, $2E, $63, $79, $64, $22, $8D, $0D, $2F
6908  9F31 55 44 45 A0
6908  9F35 2E 63 79 64
6908  9F39 22 8D 0D 2F
6909  9F3D 2F 20 4C 6F      DEFB $2F, $20, $4C, $6F, $61, $E4, $2E, $63, $79, $64, $A2, $76, $61, $72, $69, $61
6909  9F41 61 E4 2E 63
6909  9F45 79 64 A2 76
6909  9F49 61 72 69 61
6910  9F4D 62 6C E5 22      DEFB $62, $6C, $E5, $22, $63, $68, $61, $70, $74, $65, $F2, $63, $6F, $6D, $6D, $6F
6910  9F51 63 68 61 70
6910  9F55 74 65 F2 63
6910  9F59 6F 6D 6D 6F
6911  9F5D EE 0D 2F 2F      DEFB $EE, $0D, $2F, $2F, $A0, $64, $65, $6D, $EF, $65, $A0, $69, $6E, $F4, $74, $6F
6911  9F61 A0 64 65 6D
6911  9F65 EF 65 A0 69
6911  9F69 6E F4 74 6F
6912  9F6D A0 72 61 F4      DEFB $A0, $72, $61, $F4, $65, $6E, $F4, $64, $E5, $69, $EE
6912  9F71 65 6E F4 64
6912  9F75 E5 69 EE
6913  9F78
6914  9F78
6915  9F78              CHARSET_S:
6916  9F78 00 00 00 00      DEFB $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
6916  9F7C 00 00 00 00
6916  9F80 00 00 00 00
6916  9F84 00 00 00 00
6917  9F88 00 00 00 00      DEFB $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
6917  9F8C 00 00 00 00
6917  9F90 00 00 00 00
6917  9F94 00 00 00 00
6918  9F98 00 00 00 00      DEFB $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
6918  9F9C 00 00 00 00
6918  9FA0 00 00 00 00
6918  9FA4 00 00 00 00
6919  9FA8 00 00 00 00      DEFB $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
6919  9FAC 00 00 00 00
6919  9FB0 00 00 00 00
6919  9FB4 00 00 00 00
6920  9FB8 00 00 00 00      DEFB $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
6920  9FBC 00 00 00 00
6920  9FC0 00 00 00 00
6920  9FC4 00 00 00 00
6921  9FC8 00 00 00 00      DEFB $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
6921  9FCC 00 00 00 00
6921  9FD0 00 00 00 00
6921  9FD4 00 00 00 00
6922  9FD8 00 00 00 00      DEFB $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
6922  9FDC 00 00 00 00
6922  9FE0 00 00 00 00
6922  9FE4 00 00 00 00
6923  9FE8 00 00 00 00      DEFB $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
6923  9FEC 00 00 00 00
6923  9FF0 00 00 00 00
6923  9FF4 00 00 00 00
6924  9FF8 00 20 50 30      DEFB $00, $20, $50, $30, $00, $70, $00, $00, $20, $00, $20, $20, $20, $20, $20, $00
6924  9FFC 00 70 00 00
6924  A000 20 00 20 20
6924  A004 20 20 20 00
6925  A008 20 00 20 40      DEFB $20, $00, $20, $40, $88, $88, $70, $00, $00, $00, $28, $50, $A0, $50, $28, $00
6925  A00C 88 88 70 00
6925  A010 00 00 28 50
6925  A014 A0 50 28 00
6926  A018 00 00 A0 50      DEFB $00, $00, $A0, $50, $28, $50, $A0, $00, $20, $40, $00, $68, $98, $98, $68, $00
6926  A01C 28 50 A0 00
6926  A020 20 40 00 68
6926  A024 98 98 68 00
6927  A028 10 20 70 88      DEFB $10, $20, $70, $88, $F8, $80, $78, $00, $10, $20, $00, $60, $20, $20, $70, $00
6927  A02C F8 80 78 00
6927  A030 10 20 00 60
6927  A034 20 20 70 00
6928  A038 10 20 00 70      DEFB $10, $20, $00, $70, $88, $88, $70, $00, $10, $20, $00, $88, $88, $88, $70, $00
6928  A03C 88 88 70 00
6928  A040 10 20 00 88
6928  A044 88 88 70 00
6929  A048 28 50 00 B0      DEFB $28, $50, $00, $B0, $C8, $88, $88, $00, $28, $50, $88, $C8, $A8, $98, $88, $00
6929  A04C C8 88 88 00
6929  A050 28 50 88 C8
6929  A054 A8 98 88 00
6930  A058 00 70 88 80      DEFB $00, $70, $88, $80, $88, $70, $20, $40, $70, $88, $80, $80, $88, $70, $20, $40
6930  A05C 88 70 20 40
6930  A060 70 88 80 80
6930  A064 88 70 20 40
6931  A068 00 50 00 88      DEFB $00, $50, $00, $88, $88, $88, $70, $00, $50, $00, $88, $88, $88, $88, $70, $00
6931  A06C 88 88 70 00
6931  A070 50 00 88 88
6931  A074 88 88 70 00
6932  A078 00 00 00 00      DEFB $00, $00, $00, $00, $00, $00, $00, $00, $20, $20, $20, $20, $20, $00, $20, $00
6932  A07C 00 00 00 00
6932  A080 20 20 20 20
6932  A084 20 00 20 00
6933  A088 50 50 00 00      DEFB $50, $50, $00, $00, $00, $00, $00, $00, $50, $F8, $50, $50, $50, $F8, $50, $00
6933  A08C 00 00 00 00
6933  A090 50 F8 50 50
6933  A094 50 F8 50 00
6934  A098 20 F8 A0 F8      DEFB $20, $F8, $A0, $F8, $28, $F8, $20, $00, $C8, $C8, $10, $20, $40, $98, $98, $00
6934  A09C 28 F8 20 00
6934  A0A0 C8 C8 10 20
6934  A0A4 40 98 98 00
6935  A0A8 20 50 20 60      DEFB $20, $50, $20, $60, $98, $90, $68, $00, $20, $40, $00, $00, $00, $00, $00, $00
6935  A0AC 98 90 68 00
6935  A0B0 20 40 00 00
6935  A0B4 00 00 00 00
6936  A0B8 08 10 10 10      DEFB $08, $10, $10, $10, $10, $10, $08, $00, $40, $20, $20, $20, $20, $20, $40, $00
6936  A0BC 10 10 08 00
6936  A0C0 40 20 20 20
6936  A0C4 20 20 40 00
6937  A0C8 A8 A8 70 F8      DEFB $A8, $A8, $70, $F8, $70, $A8, $A8, $00, $00, $20, $20, $F8, $20, $20, $00, $00
6937  A0CC 70 A8 A8 00
6937  A0D0 00 20 20 F8
6937  A0D4 20 20 00 00
6938  A0D8 00 00 00 00      DEFB $00, $00, $00, $00, $00, $10, $10, $20, $00, $00, $00, $78, $00, $00, $00, $00
6938  A0DC 00 10 10 20
6938  A0E0 00 00 00 78
6938  A0E4 00 00 00 00
6939  A0E8 00 00 00 00      DEFB $00, $00, $00, $00, $00, $30, $30, $00, $08, $08, $10, $20, $40, $80, $80, $00
6939  A0EC 00 30 30 00
6939  A0F0 08 08 10 20
6939  A0F4 40 80 80 00
6940  A0F8 70 98 98 A8      DEFB $70, $98, $98, $A8, $C8, $C8, $70, $00, $20, $60, $20, $20, $20, $20, $70, $00
6940  A0FC C8 C8 70 00
6940  A100 20 60 20 20
6940  A104 20 20 70 00
6941  A108 70 88 08 70      DEFB $70, $88, $08, $70, $80, $80, $F8, $00, $70, $88, $08, $30, $08, $88, $70, $00
6941  A10C 80 80 F8 00
6941  A110 70 88 08 30
6941  A114 08 88 70 00
6942  A118 10 30 50 90      DEFB $10, $30, $50, $90, $F8, $10, $10, $00, $F8, $80, $80, $F0, $08, $88, $70, $00
6942  A11C F8 10 10 00
6942  A120 F8 80 80 F0
6942  A124 08 88 70 00
6943  A128 70 88 80 F0      DEFB $70, $88, $80, $F0, $88, $88, $70, $00, $F8, $08, $08, $10, $10, $20, $20, $00
6943  A12C 88 88 70 00
6943  A130 F8 08 08 10
6943  A134 10 20 20 00
6944  A138 70 88 88 70      DEFB $70, $88, $88, $70, $88, $88, $70, $00, $70, $88, $88, $78, $08, $88, $70, $00
6944  A13C 88 88 70 00
6944  A140 70 88 88 78
6944  A144 08 88 70 00
6945  A148 00 00 20 00      DEFB $00, $00, $20, $00, $00, $20, $00, $00, $00, $00, $20, $00, $00, $20, $20, $40
6945  A14C 00 20 00 00
6945  A150 00 00 20 00
6945  A154 00 20 20 40
6946  A158 00 08 10 20      DEFB $00, $08, $10, $20, $20, $10, $08, $00, $00, $00, $00, $78, $00, $78, $00, $00
6946  A15C 20 10 08 00
6946  A160 00 00 00 78
6946  A164 00 78 00 00
6947  A168 00 40 20 10      DEFB $00, $40, $20, $10, $10, $20, $40, $00, $70, $88, $88, $10, $20, $00, $20, $00
6947  A16C 10 20 40 00
6947  A170 70 88 88 10
6947  A174 20 00 20 00
6948  A178 00 70 88 A8      DEFB $00, $70, $88, $A8, $B8, $80, $70, $00, $70, $88, $88, $F8, $88, $88, $88, $00
6948  A17C B8 80 70 00
6948  A180 70 88 88 F8
6948  A184 88 88 88 00
6949  A188 F0 88 88 F0      DEFB $F0, $88, $88, $F0, $88, $88, $F0, $00, $70, $88, $80, $80, $80, $88, $70, $00
6949  A18C 88 88 F0 00
6949  A190 70 88 80 80
6949  A194 80 88 70 00
6950  A198 F0 88 88 88      DEFB $F0, $88, $88, $88, $88, $88, $F0, $00, $F8, $80, $80, $F0, $80, $80, $F8, $00
6950  A19C 88 88 F0 00
6950  A1A0 F8 80 80 F0
6950  A1A4 80 80 F8 00
6951  A1A8 F8 80 80 F0      DEFB $F8, $80, $80, $F0, $80, $80, $80, $00, $70, $88, $80, $80, $98, $88, $70, $00
6951  A1AC 80 80 80 00
6951  A1B0 70 88 80 80
6951  A1B4 98 88 70 00
6952  A1B8 88 88 88 F8      DEFB $88, $88, $88, $F8, $88, $88, $88, $00, $70, $20, $20, $20, $20, $20, $70, $00
6952  A1BC 88 88 88 00
6952  A1C0 70 20 20 20
6952  A1C4 20 20 70 00
6953  A1C8 08 08 08 08      DEFB $08, $08, $08, $08, $08, $88, $70, $00, $88, $90, $A0, $C0, $A0, $90, $88, $00
6953  A1CC 08 88 70 00
6953  A1D0 88 90 A0 C0
6953  A1D4 A0 90 88 00
6954  A1D8 80 80 80 80      DEFB $80, $80, $80, $80, $80, $80, $F8, $00, $88, $D8, $A8, $88, $88, $88, $88, $00
6954  A1DC 80 80 F8 00
6954  A1E0 88 D8 A8 88
6954  A1E4 88 88 88 00
6955  A1E8 88 88 C8 A8      DEFB $88, $88, $C8, $A8, $98, $88, $88, $00, $70, $88, $88, $88, $88, $88, $70, $00
6955  A1EC 98 88 88 00
6955  A1F0 70 88 88 88
6955  A1F4 88 88 70 00
6956  A1F8 F0 88 88 F0      DEFB $F0, $88, $88, $F0, $80, $80, $80, $00, $70, $88, $88, $88, $A8, $98, $78, $00
6956  A1FC 80 80 80 00
6956  A200 70 88 88 88
6956  A204 A8 98 78 00
6957  A208 F0 88 88 F0      DEFB $F0, $88, $88, $F0, $90, $88, $88, $00, $70, $88, $80, $70, $08, $88, $70, $00
6957  A20C 90 88 88 00
6957  A210 70 88 80 70
6957  A214 08 88 70 00
6958  A218 F8 20 20 20      DEFB $F8, $20, $20, $20, $20, $20, $20, $00, $88, $88, $88, $88, $88, $88, $70, $00
6958  A21C 20 20 20 00
6958  A220 88 88 88 88
6958  A224 88 88 70 00
6959  A228 88 88 88 88      DEFB $88, $88, $88, $88, $88, $50, $20, $00, $88, $88, $88, $88, $A8, $A8, $50, $00
6959  A22C 88 50 20 00
6959  A230 88 88 88 88
6959  A234 A8 A8 50 00
6960  A238 88 88 50 20      DEFB $88, $88, $50, $20, $50, $88, $88, $00, $88, $88, $50, $20, $20, $20, $20, $00
6960  A23C 50 88 88 00
6960  A240 88 88 50 20
6960  A244 20 20 20 00
6961  A248 F8 08 10 20      DEFB $F8, $08, $10, $20, $40, $80, $F8, $00, $38, $20, $20, $20, $20, $20, $38, $00
6961  A24C 40 80 F8 00
6961  A250 38 20 20 20
6961  A254 20 20 38 00
6962  A258 80 80 40 20      DEFB $80, $80, $40, $20, $10, $08, $08, $00, $70, $10, $10, $10, $10, $10, $70, $00
6962  A25C 10 08 08 00
6962  A260 70 10 10 10
6962  A264 10 10 70 00
6963  A268 20 70 A8 20      DEFB $20, $70, $A8, $20, $20, $20, $20, $00, $00, $00, $00, $00, $00, $00, $FC, $00
6963  A26C 20 20 20 00
6963  A270 00 00 00 00
6963  A274 00 00 FC 00
6964  A278 30 48 40 F0      DEFB $30, $48, $40, $F0, $40, $40, $F8, $00, $00, $00, $68, $98, $88, $98, $68, $00
6964  A27C 40 40 F8 00
6964  A280 00 00 68 98
6964  A284 88 98 68 00
6965  A288 80 80 B0 C8      DEFB $80, $80, $B0, $C8, $88, $C8, $B0, $00, $00, $00, $70, $88, $80, $88, $70, $00
6965  A28C 88 C8 B0 00
6965  A290 00 00 70 88
6965  A294 80 88 70 00
6966  A298 08 08 68 98      DEFB $08, $08, $68, $98, $88, $98, $68, $00, $00, $00, $70, $88, $F0, $80, $78, $00
6966  A29C 88 98 68 00
6966  A2A0 00 00 70 88
6966  A2A4 F0 80 78 00
6967  A2A8 30 48 40 60      DEFB $30, $48, $40, $60, $40, $40, $40, $00, $00, $00, $70, $88, $88, $78, $08, $70
6967  A2AC 40 40 40 00
6967  A2B0 00 00 70 88
6967  A2B4 88 78 08 70
6968  A2B8 80 80 B0 C8      DEFB $80, $80, $B0, $C8, $88, $88, $88, $00, $20, $00, $60, $20, $20, $20, $70, $00
6968  A2BC 88 88 88 00
6968  A2C0 20 00 60 20
6968  A2C4 20 20 70 00
6969  A2C8 10 00 10 10      DEFB $10, $00, $10, $10, $10, $90, $60, $00, $80, $80, $80, $A0, $C0, $A0, $90, $00
6969  A2CC 10 90 60 00
6969  A2D0 80 80 80 A0
6969  A2D4 C0 A0 90 00
6970  A2D8 40 40 40 40      DEFB $40, $40, $40, $40, $40, $40, $30, $00, $00, $00, $D0, $A8, $A8, $A8, $A8, $00
6970  A2DC 40 40 30 00
6970  A2E0 00 00 D0 A8
6970  A2E4 A8 A8 A8 00
6971  A2E8 00 00 B0 C8      DEFB $00, $00, $B0, $C8, $88, $88, $88, $00, $00, $00, $70, $88, $88, $88, $70, $00
6971  A2EC 88 88 88 00
6971  A2F0 00 00 70 88
6971  A2F4 88 88 70 00
6972  A2F8 00 00 B0 C8      DEFB $00, $00, $B0, $C8, $88, $F0, $80, $80, $00, $00, $68, $98, $88, $78, $08, $0C
6972  A2FC 88 F0 80 80
6972  A300 00 00 68 98
6972  A304 88 78 08 0C
6973  A308 00 00 B0 40      DEFB $00, $00, $B0, $40, $40, $40, $40, $00, $00, $00, $70, $80, $70, $08, $F0, $00
6973  A30C 40 40 40 00
6973  A310 00 00 70 80
6973  A314 70 08 F0 00
6974  A318 00 40 E0 40      DEFB $00, $40, $E0, $40, $40, $40, $30, $00, $00, $00, $88, $88, $88, $88, $70, $00
6974  A31C 40 40 30 00
6974  A320 00 00 88 88
6974  A324 88 88 70 00
6975  A328 00 00 88 88      DEFB $00, $00, $88, $88, $50, $50, $20, $00, $00, $00, $88, $A8, $A8, $A8, $50, $00
6975  A32C 50 50 20 00
6975  A330 00 00 88 A8
6975  A334 A8 A8 50 00
6976  A338 00 00 88 50      DEFB $00, $00, $88, $50, $20, $50, $88, $00, $00, $00, $88, $88, $98, $68, $08, $70
6976  A33C 20 50 88 00
6976  A340 00 00 88 88
6976  A344 98 68 08 70
6977  A348 00 00 F8 10      DEFB $00, $00, $F8, $10, $20, $40, $F8, $00, $18, $20, $20, $40, $20, $20, $18, $00
6977  A34C 20 40 F8 00
6977  A350 18 20 20 40
6977  A354 20 20 18 00
6978  A358 10 10 10 10      DEFB $10, $10, $10, $10, $10, $10, $10, $00, $60, $10, $10, $08, $10, $10, $60, $00
6978  A35C 10 10 10 00
6978  A360 60 10 10 08
6978  A364 10 10 60 00
6979  A368 00 28 50 00      DEFB $00, $28, $50, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
6979  A36C 00 00 00 00
6979  A370 00 00 00 00
6979  A374 00 00 00 00
6980  A378 10 18 1C FE      DEFB $10, $18, $1C, $FE, $FE, $1C, $18, $10, $00, $10, $18, $FE, $FE, $18, $10, $00
6980  A37C FE 1C 18 10
6980  A380 00 10 18 FE
6980  A384 FE 18 10 00
6981  A388 00 10 18 FE      DEFB $00, $10, $18, $FE, $FE, $18, $10, $00, $00, $00, $00, $FE, $FE, $00, $00, $00
6981  A38C FE 18 10 00
6981  A390 00 00 00 FE
6981  A394 FE 00 00 00
6982  A398 00 00 18 FE      DEFB $00, $00, $18, $FE, $FE, $18, $00, $00, $00, $10, $18, $FE, $FE, $18, $10, $00
6982  A39C FE 18 00 00
6982  A3A0 00 10 18 FE
6982  A3A4 FE 18 10 00
6983  A3A8 00 10 18 FE      DEFB $00, $10, $18, $FE, $FE, $18, $10, $00, $10, $18, $1C, $FE, $FE, $1C, $18, $10
6983  A3AC FE 18 10 00
6983  A3B0 10 18 1C FE
6983  A3B4 FE 1C 18 10
6984  A3B8 18 18 18 18      DEFB $18, $18, $18, $18, $18, $7E, $3C, $18, $00, $18, $18, $18, $7E, $3C, $18, $00
6984  A3BC 18 7E 3C 18
6984  A3C0 00 18 18 18
6984  A3C4 7E 3C 18 00
6985  A3C8 00 00 18 18      DEFB $00, $00, $18, $18, $7E, $18, $00, $00, $00, $00, $00, $7E, $00, $00, $00, $00
6985  A3CC 7E 18 00 00
6985  A3D0 00 00 00 7E
6985  A3D4 00 00 00 00
6986  A3D8 00 00 18 18      DEFB $00, $00, $18, $18, $7E, $3C, $18, $00, $00, $18, $18, $18, $7E, $3C, $18, $00
6986  A3DC 7E 3C 18 00
6986  A3E0 00 18 18 18
6986  A3E4 7E 3C 18 00
6987  A3E8 18 18 18 18      DEFB $18, $18, $18, $18, $18, $7E, $3C, $18, $18, $18, $18, $18, $18, $7E, $3C, $18
6987  A3EC 18 7E 3C 18
6987  A3F0 18 18 18 18
6987  A3F4 18 7E 3C 18
6988  A3F8 00 C0 A0 E0      DEFB $00, $C0, $A0, $E0, $00, $E0, $00, $00, $00, $20, $00, $20, $20, $20, $20, $00
6988  A3FC 00 E0 00 00
6988  A400 00 20 00 20
6988  A404 20 20 20 00
6989  A408 00 20 00 20      DEFB $00, $20, $00, $20, $40, $50, $20, $00, $00, $00, $50, $A0, $50, $00, $00, $00
6989  A40C 40 50 20 00
6989  A410 00 00 50 A0
6989  A414 50 00 00 00
6990  A418 00 00 A0 50      DEFB $00, $00, $A0, $50, $A0, $00, $00, $00, $00, $10, $60, $10, $30, $50, $30, $00
6990  A41C A0 00 00 00
6990  A420 00 10 60 10
6990  A424 30 50 30 00
6991  A428 00 10 20 50      DEFB $00, $10, $20, $50, $60, $40, $30, $00, $10, $20, $00, $60, $20, $20, $70, $00
6991  A42C 60 40 30 00
6991  A430 10 20 00 60
6991  A434 20 20 70 00
6992  A438 00 10 20 50      DEFB $00, $10, $20, $50, $50, $50, $20, $00, $10, $20, $00, $50, $50, $50, $20, $00
6992  A43C 50 50 20 00
6992  A440 10 20 00 50
6992  A444 50 50 20 00
6993  A448 00 60 00 60      DEFB $00, $60, $00, $60, $50, $50, $50, $00, $70, $00, $50, $70, $70, $50, $50, $00
6993  A44C 50 50 50 00
6993  A450 70 00 50 70
6993  A454 70 50 50 00
6994  A458 00 00 20 50      DEFB $00, $00, $20, $50, $40, $50, $20, $40, $00, $20, $50, $40, $40, $50, $20, $40
6994  A45C 40 50 20 40
6994  A460 00 20 50 40
6994  A464 40 50 20 40
6995  A468 00 50 00 50      DEFB $00, $50, $00, $50, $50, $50, $20, $00, $50, $00, $50, $50, $50, $50, $20, $00
6995  A46C 50 50 20 00
6995  A470 50 00 50 50
6995  A474 50 50 20 00
6996  A478 00 00 00 00      DEFB $00, $00, $00, $00, $00, $00, $00, $00, $00, $20, $20, $20, $20, $00, $20, $00
6996  A47C 00 00 00 00
6996  A480 00 20 20 20
6996  A484 20 00 20 00
6997  A488 00 50 50 00      DEFB $00, $50, $50, $00, $00, $00, $00, $00, $00, $00, $20, $70, $20, $70, $20, $00
6997  A48C 00 00 00 00
6997  A490 00 00 20 70
6997  A494 20 70 20 00
6998  A498 00 20 70 40      DEFB $00, $20, $70, $40, $70, $10, $70, $20, $00, $50, $10, $20, $20, $40, $50, $00
6998  A49C 70 10 70 20
6998  A4A0 00 50 10 20
6998  A4A4 20 40 50 00
6999  A4A8 00 20 50 20      DEFB $00, $20, $50, $20, $60, $50, $60, $00, $00, $20, $40, $00, $00, $00, $00, $00
6999  A4AC 60 50 60 00
6999  A4B0 00 20 40 00
6999  A4B4 00 00 00 00
7000  A4B8 00 20 40 40      DEFB $00, $20, $40, $40, $40, $40, $20, $00, $00, $40, $20, $20, $20, $20, $40, $00
7000  A4BC 40 40 20 00
7000  A4C0 00 40 20 20
7000  A4C4 20 20 40 00
7001  A4C8 00 00 50 20      DEFB $00, $00, $50, $20, $70, $20, $50, $00, $00, $00, $20, $20, $70, $20, $20, $00
7001  A4CC 70 20 50 00
7001  A4D0 00 00 20 20
7001  A4D4 70 20 20 00
7002  A4D8 00 00 00 00      DEFB $00, $00, $00, $00, $00, $20, $20, $40, $00, $00, $00, $00, $70, $00, $00, $00
7002  A4DC 00 20 20 40
7002  A4E0 00 00 00 00
7002  A4E4 70 00 00 00
7003  A4E8 00 00 00 00      DEFB $00, $00, $00, $00, $00, $60, $60, $00, $00, $10, $10, $20, $20, $40, $40, $00
7003  A4EC 00 60 60 00
7003  A4F0 00 10 10 20
7003  A4F4 20 40 40 00
7004  A4F8 00 20 50 50      DEFB $00, $20, $50, $50, $50, $50, $20, $00, $00, $20, $60, $20, $20, $20, $70, $00
7004  A4FC 50 50 20 00
7004  A500 00 20 60 20
7004  A504 20 20 70 00
7005  A508 00 20 50 10      DEFB $00, $20, $50, $10, $20, $40, $70, $00, $00, $20, $50, $20, $10, $50, $20, $00
7005  A50C 20 40 70 00
7005  A510 00 20 50 20
7005  A514 10 50 20 00
7006  A518 00 50 50 70      DEFB $00, $50, $50, $70, $10, $10, $10, $00, $00, $70, $40, $60, $10, $50, $20, $00
7006  A51C 10 10 10 00
7006  A520 00 70 40 60
7006  A524 10 50 20 00
7007  A528 00 30 40 60      DEFB $00, $30, $40, $60, $50, $50, $20, $00, $00, $70, $10, $10, $20, $40, $40, $00
7007  A52C 50 50 20 00
7007  A530 00 70 10 10
7007  A534 20 40 40 00
7008  A538 00 20 50 20      DEFB $00, $20, $50, $20, $50, $50, $20, $00, $00, $20, $50, $50, $30, $50, $20, $00
7008  A53C 50 50 20 00
7008  A540 00 20 50 50
7008  A544 30 50 20 00
7009  A548 00 00 00 20      DEFB $00, $00, $00, $20, $00, $20, $00, $00, $00, $00, $20, $00, $00, $20, $20, $40
7009  A54C 00 20 00 00
7009  A550 00 00 20 00
7009  A554 00 20 20 40
7010  A558 00 00 10 20      DEFB $00, $00, $10, $20, $40, $20, $10, $00, $00, $00, $00, $70, $00, $70, $00, $00
7010  A55C 40 20 10 00
7010  A560 00 00 00 70
7010  A564 00 70 00 00
7011  A568 00 00 40 20      DEFB $00, $00, $40, $20, $10, $20, $40, $00, $00, $20, $50, $10, $20, $00, $20, $00
7011  A56C 10 20 40 00
7011  A570 00 20 50 10
7011  A574 20 00 20 00
7012  A578 00 60 90 B0      DEFB $00, $60, $90, $B0, $B0, $80, $60, $00, $00, $20, $50, $70, $50, $50, $50, $00
7012  A57C B0 80 60 00
7012  A580 00 20 50 70
7012  A584 50 50 50 00
7013  A588 00 60 50 60      DEFB $00, $60, $50, $60, $50, $50, $60, $00, $00, $20, $50, $40, $40, $50, $20, $00
7013  A58C 50 50 60 00
7013  A590 00 20 50 40
7013  A594 40 50 20 00
7014  A598 00 60 50 50      DEFB $00, $60, $50, $50, $50, $50, $60, $00, $00, $70, $40, $60, $40, $40, $70, $00
7014  A59C 50 50 60 00
7014  A5A0 00 70 40 60
7014  A5A4 40 40 70 00
7015  A5A8 00 70 40 70      DEFB $00, $70, $40, $70, $40, $40, $40, $00, $00, $20, $50, $40, $70, $50, $20, $00
7015  A5AC 40 40 40 00
7015  A5B0 00 20 50 40
7015  A5B4 70 50 20 00
7016  A5B8 00 50 50 70      DEFB $00, $50, $50, $70, $50, $50, $50, $00, $00, $70, $20, $20, $20, $20, $70, $00
7016  A5BC 50 50 50 00
7016  A5C0 00 70 20 20
7016  A5C4 20 20 70 00
7017  A5C8 00 30 10 10      DEFB $00, $30, $10, $10, $10, $50, $20, $00, $00, $50, $50, $60, $50, $50, $50, $00
7017  A5CC 10 50 20 00
7017  A5D0 00 50 50 60
7017  A5D4 50 50 50 00
7018  A5D8 00 40 40 40      DEFB $00, $40, $40, $40, $40, $40, $70, $00, $00, $50, $70, $70, $50, $50, $50, $00
7018  A5DC 40 40 70 00
7018  A5E0 00 50 70 70
7018  A5E4 50 50 50 00
7019  A5E8 00 50 50 70      DEFB $00, $50, $50, $70, $70, $50, $50, $00, $00, $20, $50, $50, $50, $50, $20, $00
7019  A5EC 70 50 50 00
7019  A5F0 00 20 50 50
7019  A5F4 50 50 20 00
7020  A5F8 00 60 50 50      DEFB $00, $60, $50, $50, $60, $40, $40, $00, $00, $20, $50, $50, $70, $70, $30, $00
7020  A5FC 60 40 40 00
7020  A600 00 20 50 50
7020  A604 70 70 30 00
7021  A608 00 60 50 50      DEFB $00, $60, $50, $50, $60, $50, $50, $00, $00, $20, $50, $20, $10, $50, $20, $00
7021  A60C 60 50 50 00
7021  A610 00 20 50 20
7021  A614 10 50 20 00
7022  A618 00 70 20 20      DEFB $00, $70, $20, $20, $20, $20, $20, $00, $00, $50, $50, $50, $50, $50, $20, $00
7022  A61C 20 20 20 00
7022  A620 00 50 50 50
7022  A624 50 50 20 00
7023  A628 00 50 50 50      DEFB $00, $50, $50, $50, $50, $20, $20, $00, $00, $50, $50, $50, $70, $70, $50, $00
7023  A62C 50 20 20 00
7023  A630 00 50 50 50
7023  A634 70 70 50 00
7024  A638 00 50 50 20      DEFB $00, $50, $50, $20, $50, $50, $50, $00, $00, $50, $50, $50, $20, $20, $20, $00
7024  A63C 50 50 50 00
7024  A640 00 50 50 50
7024  A644 20 20 20 00
7025  A648 00 70 10 20      DEFB $00, $70, $10, $20, $20, $40, $70, $00, $00, $70, $40, $40, $40, $40, $70, $00
7025  A64C 20 40 70 00
7025  A650 00 70 40 40
7025  A654 40 40 70 00
7026  A658 00 40 40 20      DEFB $00, $40, $40, $20, $20, $10, $10, $00, $00, $70, $10, $10, $10, $10, $70, $00
7026  A65C 20 10 10 00
7026  A660 00 70 10 10
7026  A664 10 10 70 00
7027  A668 00 20 70 20      DEFB $00, $20, $70, $20, $20, $20, $20, $00, $00, $00, $00, $00, $00, $00, $F0, $00
7027  A66C 20 20 20 00
7027  A670 00 00 00 00
7027  A674 00 00 F0 00
7028  A678 00 20 50 40      DEFB $00, $20, $50, $40, $60, $40, $70, $00, $00, $00, $60, $10, $30, $50, $30, $00
7028  A67C 60 40 70 00
7028  A680 00 00 60 10
7028  A684 30 50 30 00
7029  A688 00 40 40 60      DEFB $00, $40, $40, $60, $50, $50, $60, $00, $00, $00, $20, $50, $40, $50, $20, $00
7029  A68C 50 50 60 00
7029  A690 00 00 20 50
7029  A694 40 50 20 00
7030  A698 00 10 10 30      DEFB $00, $10, $10, $30, $50, $50, $20, $00, $00, $00, $20, $50, $60, $40, $30, $00
7030  A69C 50 50 20 00
7030  A6A0 00 00 20 50
7030  A6A4 60 40 30 00
7031  A6A8 00 20 50 40      DEFB $00, $20, $50, $40, $60, $40, $40, $00, $00, $00, $20, $50, $50, $30, $50, $20
7031  A6AC 60 40 40 00
7031  A6B0 00 00 20 50
7031  A6B4 50 30 50 20
7032  A6B8 00 40 40 60      DEFB $00, $40, $40, $60, $50, $50, $50, $00, $00, $20, $00, $60, $20, $20, $70, $00
7032  A6BC 50 50 50 00
7032  A6C0 00 20 00 60
7032  A6C4 20 20 70 00
7033  A6C8 00 10 00 30      DEFB $00, $10, $00, $30, $10, $10, $50, $20, $00, $40, $40, $50, $60, $50, $50, $00
7033  A6CC 10 10 50 20
7033  A6D0 00 40 40 50
7033  A6D4 60 50 50 00
7034  A6D8 00 40 40 40      DEFB $00, $40, $40, $40, $40, $50, $20, $00, $00, $00, $50, $70, $70, $50, $50, $00
7034  A6DC 40 50 20 00
7034  A6E0 00 00 50 70
7034  A6E4 70 50 50 00
7035  A6E8 00 00 60 50      DEFB $00, $00, $60, $50, $50, $50, $50, $00, $00, $00, $20, $50, $50, $50, $20, $00
7035  A6EC 50 50 50 00
7035  A6F0 00 00 20 50
7035  A6F4 50 50 20 00
7036  A6F8 00 00 60 50      DEFB $00, $00, $60, $50, $50, $60, $40, $40, $00, $00, $30, $50, $50, $30, $10, $10
7036  A6FC 50 60 40 40
7036  A700 00 00 30 50
7036  A704 50 30 10 10
7037  A708 00 00 60 50      DEFB $00, $00, $60, $50, $40, $40, $40, $00, $00, $00, $30, $40, $20, $10, $60, $00
7037  A70C 40 40 40 00
7037  A710 00 00 30 40
7037  A714 20 10 60 00
7038  A718 00 40 70 40      DEFB $00, $40, $70, $40, $40, $50, $20, $00, $00, $00, $50, $50, $50, $50, $20, $00
7038  A71C 40 50 20 00
7038  A720 00 00 50 50
7038  A724 50 50 20 00
7039  A728 00 00 50 50      DEFB $00, $00, $50, $50, $50, $20, $20, $00, $00, $00, $50, $50, $70, $70, $50, $00
7039  A72C 50 20 20 00
7039  A730 00 00 50 50
7039  A734 70 70 50 00
7040  A738 00 00 50 50      DEFB $00, $00, $50, $50, $20, $50, $50, $00, $00, $00, $50, $50, $30, $10, $50, $20
7040  A73C 20 50 50 00
7040  A740 00 00 50 50
7040  A744 30 10 50 20
7041  A748 00 00 70 10      DEFB $00, $00, $70, $10, $20, $40, $70, $00, $00, $00, $10, $20, $60, $20, $10, $00
7041  A74C 20 40 70 00
7041  A750 00 00 10 20
7041  A754 60 20 10 00
7042  A758 00 20 20 20      DEFB $00, $20, $20, $20, $20, $20, $20, $00, $00, $00, $40, $20, $30, $20, $40, $00
7042  A75C 20 20 20 00
7042  A760 00 00 40 20
7042  A764 30 20 40 00
7043  A768 00 00 A0 50      DEFB $00, $00, $A0, $50, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
7043  A76C 00 00 00 00
7043  A770 00 00 00 00
7043  A774 00 00 00 00
7044  A778
7045  A778
7046  A778              CHARSET_W:
7047  A778 06 06 06 06      DEFB $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06
7047  A77C 06 06 06 06
7047  A780 06 06 06 06
7047  A784 06 06 06 06
7048  A788 06 06 06 06      DEFB $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06
7048  A78C 06 06 06 06
7048  A790 06 06 06 06
7048  A794 06 06 06 06
7049  A798 06 06 06 06      DEFB $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06
7049  A79C 06 06 06 06
7049  A7A0 06 06 06 06
7049  A7A4 06 06 06 06
7050  A7A8 06 06 06 06      DEFB $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06
7050  A7AC 06 06 06 06
7050  A7B0 06 06 06 06
7050  A7B4 06 06 06 06
7051  A7B8 06 06 06 06      DEFB $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06
7051  A7BC 06 06 06 06
7051  A7C0 06 06 06 06
7051  A7C4 06 06 06 06
7052  A7C8 06 06 06 06      DEFB $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06
7052  A7CC 06 06 06 06
7052  A7D0 06 06 06 06
7052  A7D4 06 06 06 06
7053  A7D8 06 06 06 06      DEFB $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06
7053  A7DC 06 06 06 06
7053  A7E0 06 06 06 06
7053  A7E4 06 06 06 06
7054  A7E8 06 06 06 06      DEFB $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $06, $08
7054  A7EC 06 06 06 06
7054  A7F0 06 06 06 06
7054  A7F4 06 06 06 08
7055  A7F8 08 08 08 08      DEFB $08, $08, $08, $08, $08, $08, $08, $08, $08, $08, $08, $08, $08, $08, $08, $08
7055  A7FC 08 08 08 08
7055  A800 08 08 08 08
7055  A804 08 08 08 08
7056  A808 04 04 04 04      DEFB $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04
7056  A80C 04 04 04 04
7056  A810 04 04 04 04
7056  A814 04 04 04 04
7057  A818 04 04 04 04      DEFB $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04
7057  A81C 04 04 04 04
7057  A820 04 04 04 04
7057  A824 04 04 04 04
7058  A828 04 04 04 04      DEFB $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04
7058  A82C 04 04 04 04
7058  A830 04 04 04 04
7058  A834 04 04 04 04
7059  A838 04 04 04 04      DEFB $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04
7059  A83C 04 04 04 04
7059  A840 04 04 04 04
7059  A844 04 04 04 04
7060  A848 04 04 04 04      DEFB $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04
7060  A84C 04 04 04 04
7060  A850 04 04 04 04
7060  A854 04 04 04 04
7061  A858 04 04 04 04      DEFB $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04
7061  A85C 04 04 04 04
7061  A860 04 04 04 04
7061  A864 04 04 04 04
7062  A868 04 04 04 04      DEFB $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $04, $08
7062  A86C 04 04 04 04
7062  A870 04 04 04 04
7062  A874 04 04 04 08
7063  A878
7064  A878
7065  A878                  IFDEF SHOW_SIZE_INTERPRETER
7066  A878 ~            INDEX:
7067  A878 ~            SIZE_INTERPRETER = $ - START_INTERPRETER
7068  A878 ~                DISPLAY "SIZE_INTERPRETER=", /D, SIZE_INTERPRETER, " <"
7069  A878                  ENDIF
7070  A878
7071  A878                  IFNDEF SHOW_SIZE_INTERPRETER
7072  A878              INDEX:
7073  A878 00 00 00         DEFB $0, $0, $0
7074  A87B 7D A8            DEFW $A87D
7075  A87D
7076  A87D
7077  A87D              SIZE_INTERPRETER = $ - START_INTERPRETER
7078  A87D                  SAVETAP "./main.tap", HEADLESS,START_INTERPRETER, SIZE_INTERPRETER
7079  A87D                  ENDIF
7080  A87D                  ORG $A87D
7081  A87D              START_BLOCK_0:
7082  A87D 01 DF 78 B2      DEFB $01, $DF, $78, $B2, $9E, $70, $DF, $72, $8D, $86, $DF, $8F, $90, $75, $DF, $99
7082  A881 9E 70 DF 72
7082  A885 8D 86 DF 8F
7082  A889 90 75 DF 99
7083  A88D 90 8D DF 8B      DEFB $90, $8D, $DF, $8B, $97, $76, $7F, $77, $DF, $9E, $9B, $89, $72, $8A, $8D, $9A
7083  A891 97 76 7F 77
7083  A895 DF 9E 9B 89
7083  A899 72 8A 8D 9A
7084  A89D 78 AB 97 96      DEFB $78, $AB, $97, $96, $8C, $DF, $99, $96, $93, $76, $77, $91, $8C, $8B, $73, $9A
7084  A8A1 8C DF 99 96
7084  A8A5 93 76 77 91
7084  A8A9 8C 8B 73 9A
7085  A8AD 8C DF 97 90      DEFB $8C, $DF, $97, $90, $88, $DF, $74, $8A, $8C, $76, $7F, $74, $90, $8D, $98, $9E
7085  A8B1 88 DF 74 8A
7085  A8B5 8C 76 7F 74
7085  A8B9 90 8D 98 9E
7086  A8BD 91 96 85 76      DEFB $91, $96, $85, $76, $9C, $90, $71, $F2, $7D, $DF, $7B, $DF, $71, $9C, $93, $9E
7086  A8C1 9C 90 71 F2
7086  A8C5 7D DF 7B DF
7086  A8C9 71 9C 93 9E
7087  A8CD 73 96 90 91      DEFB $73, $96, $90, $91, $8C, $F2, $7F, $DD, $7B, $8C, $7E, $7D, $DF, $79, $DF, $8C
7087  A8D1 8C F2 7F DD
7087  A8D5 7B 8C 7E 7D
7087  A8D9 DF 79 DF 8C
7088  A8DD 8A 9D 8D 90      DEFB $8A, $9D, $8D, $90, $8A, $8B, $70, $9A, $8C, $F2, $7F, $DD, $79, $7E, $F5, $01
7088  A8E1 8A 8B 70 9A
7088  A8E5 8C F2 7F DD
7088  A8E9 79 7E F5 01
7089  A8ED 7F DD 75 8D      DEFB $7F, $DD, $75, $8D, $90, $7C, $F5, $01, $7F, $7A, $CE, $7C, $F5, $01, $7F, $7A
7089  A8F1 90 7C F5 01
7089  A8F5 7F 7A CE 7C
7089  A8F9 F5 01 7F 7A
7090  A8FD CD 7C F5 00      DEFB $CD, $7C, $F5, $00
7091  A901
7092  A901              SIZE_BLOCK_0 = $ - START_BLOCK_0
7093  A901                  SAVETAP "./main.tap",HEADLESS,START_BLOCK_0,SIZE_BLOCK_0
7094  A901
# file closed: cyd.asm
